"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const parseConformance_1 = require("fhir/parseConformance");
const fhir_1 = require("fhir/fhir");
const stu3Types = require("./stu3/types.json");
const stu3Resources = require("./stu3/resources.json");
const stu3ValueSets = require("./stu3/valuesets.json");
function joinUrl(...parts) {
    let url = '';
    for (let i = 0; i < parts.length; i++) {
        const argument = parts[i].toString();
        if (url && !url.endsWith('/')) {
            url += '/';
        }
        url += argument.startsWith('/') ? argument.substring(1) : argument;
    }
    return url;
}
exports.joinUrl = joinUrl;
function buildUrl(base, resourceType, id, operation, params) {
    let path = base;
    if (!path) {
        return;
    }
    if (resourceType) {
        path = joinUrl(path, resourceType);
        if (id) {
            path = joinUrl(path, id);
        }
    }
    if (operation) {
        path = joinUrl(path, operation);
    }
    if (params) {
        const keys = Object.keys(params);
        const paramArray = keys.map((key) => {
            const value = encodeURIComponent(params[key]);
            return key + '=' + value;
        });
        if (paramArray.length > 0) {
            path += '?' + paramArray.join('&');
        }
    }
    return path;
}
exports.buildUrl = buildUrl;
function parseUrl(url, base) {
    const parseUrlRegex = /(Account|ActivityDefinition|AdverseEvent|AllergyIntolerance|Appointment|AppointmentResponse|AuditEvent|Basic|Binary|BodySite|Bundle|CapabilityStatement|CarePlan|CareTeam|ChargeItem|Claim|ClaimResponse|ClinicalImpression|CodeSystem|Communication|CommunicationRequest|CompartmentDefinition|Composition|ConceptMap|Condition|Consent|Contract|Coverage|DataElement|DetectedIssue|Device|DeviceComponent|DeviceMetric|DeviceRequest|DeviceUseStatement|DiagnosticReport|DocumentManifest|DocumentReference|EligibilityRequest|EligibilityResponse|Encounter|Endpoint|EnrollmentRequest|EnrollmentResponse|EpisodeOfCare|ExpansionProfile|ExplanationOfBenefit|FamilyMemberHistory|Flag|Goal|GraphDefinition|Group|GuidanceResponse|HealthcareService|ImagingManifest|ImagingStudy|Immunization|ImmunizationRecommendation|ImplementationGuide|Library|Linkage|List|Location|Measure|MeasureReport|Media|MedicationAdministration|MedicationDispense|MedicationRequest|MedicationStatement|Medication|MessageDefinition|MessageHeader|NamingSystem|NutritionOrder|Observation|OperationDefinition|OperationOutcome|Organization|Patient|PaymentNotice|PaymentReconciliation|Person|PlanDefinition|PractitionerRole|Practitioner|ProcedureRequest|Procedure|ProcessRequest|ProcessResponse|Provenance|QuestionnaireResponse|Questionnaire|ReferralRequest|RelatedPerson|RequestGroup|ResearchStudy|ResearchSubject|RiskAssessment|Schedule|SearchParameter|Sequence|ServiceDefinition|Slot|Specimen|StructureDefinition|StructureMap|Subscription|Substance|SupplyDelivery|SupplyRequest|Task|TestReport|TestScript|ValueSet|VisionPrescription)(\/([A-Za-z0-9\-\.]+))?(\/_history\/([A-Za-z0-9\-\.]{1,64}))?/g;
    if (base && base.lastIndexOf('/') === base.length - 1) {
        base = base.substring(0, base.length - 1);
    }
    const next = url.replace(base, '');
    const match = parseUrlRegex.exec(next);
    if (match) {
        return {
            resourceType: match[1],
            id: match[3],
            historyId: match[5]
        };
    }
}
exports.parseUrl = parseUrl;
function getFhirStu3Instance() {
    // TODO: Determine which FHIR version to load
    const parser = new parseConformance_1.ParseConformance(false, fhir_1.Versions.STU3);
    parser.parseBundle(stu3ValueSets);
    parser.parseBundle(stu3Types);
    parser.parseBundle(stu3Resources);
    const fhir = new fhir_1.Fhir(parser);
    return fhir;
}
exports.getFhirStu3Instance = getFhirStu3Instance;
function getFhirR4Instance() {
    const fhir = new fhir_1.Fhir();
    // TODO: Consider loading specific base resources for FHIR R4...
    return fhir;
}
exports.getFhirR4Instance = getFhirR4Instance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmhpckhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZoaXJIZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw0REFBdUQ7QUFDdkQsb0NBQXlEO0FBQ3pELCtDQUErQztBQUMvQyx1REFBdUQ7QUFDdkQsdURBQXVEO0FBRXZELFNBQWdCLE9BQU8sQ0FBQyxHQUFHLEtBQWU7SUFDeEMsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDO0lBRWIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDckMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXJDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUM3QixHQUFHLElBQUksR0FBRyxDQUFDO1NBQ1o7UUFFRCxHQUFHLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO0tBQ3BFO0lBRUQsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBZEQsMEJBY0M7QUFFRCxTQUFnQixRQUFRLENBQUMsSUFBWSxFQUFFLFlBQXFCLEVBQUUsRUFBVyxFQUFFLFNBQWtCLEVBQUUsTUFBNkI7SUFDMUgsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRWhCLElBQUksQ0FBQyxJQUFJLEVBQUU7UUFDVCxPQUFPO0tBQ1I7SUFFRCxJQUFJLFlBQVksRUFBRTtRQUNoQixJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUVuQyxJQUFJLEVBQUUsRUFBRTtZQUNOLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQzFCO0tBQ0Y7SUFFRCxJQUFJLFNBQVMsRUFBRTtRQUNiLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0tBQ2pDO0lBRUQsSUFBSSxNQUFNLEVBQUU7UUFDVixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNsQyxNQUFNLEtBQUssR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUM5QyxPQUFPLEdBQUcsR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN6QixJQUFJLElBQUksR0FBRyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDcEM7S0FDRjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQWhDRCw0QkFnQ0M7QUFFRCxTQUFnQixRQUFRLENBQUMsR0FBVyxFQUFFLElBQWE7SUFDakQsTUFBTSxhQUFhLEdBQUcsaW5EQUFpbkQsQ0FBQztJQUV4b0QsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLENBQUMsTUFBTSxHQUFDLENBQUMsRUFBRTtRQUNuRCxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztLQUMzQztJQUVELE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLE1BQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFdkMsSUFBSSxLQUFLLEVBQUU7UUFDVCxPQUFPO1lBQ0wsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDdEIsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDWixTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUNwQixDQUFDO0tBQ0g7QUFDSCxDQUFDO0FBakJELDRCQWlCQztBQUVELFNBQWdCLG1CQUFtQjtJQUNqQyw2Q0FBNkM7SUFDN0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxtQ0FBZ0IsQ0FBQyxLQUFLLEVBQUUsZUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlELE1BQU0sQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM5QixNQUFNLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksV0FBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzlCLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQVJELGtEQVFDO0FBRUQsU0FBZ0IsaUJBQWlCO0lBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUksV0FBSSxFQUFFLENBQUM7SUFDeEIsZ0VBQWdFO0lBQ2hFLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUpELDhDQUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtQYXJzZUNvbmZvcm1hbmNlfSBmcm9tICdmaGlyL3BhcnNlQ29uZm9ybWFuY2UnO1xyXG5pbXBvcnQge0ZoaXIsIFZlcnNpb25zIGFzIEZoaXJWZXJzaW9uc30gZnJvbSAnZmhpci9maGlyJztcclxuaW1wb3J0ICogYXMgc3R1M1R5cGVzIGZyb20gJy4vc3R1My90eXBlcy5qc29uJztcclxuaW1wb3J0ICogYXMgc3R1M1Jlc291cmNlcyBmcm9tICcuL3N0dTMvcmVzb3VyY2VzLmpzb24nO1xyXG5pbXBvcnQgKiBhcyBzdHUzVmFsdWVTZXRzIGZyb20gJy4vc3R1My92YWx1ZXNldHMuanNvbic7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gam9pblVybCguLi5wYXJ0czogc3RyaW5nW10pIHtcclxuICBsZXQgdXJsID0gJyc7XHJcblxyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcclxuICAgIGNvbnN0IGFyZ3VtZW50ID0gcGFydHNbaV0udG9TdHJpbmcoKTtcclxuXHJcbiAgICBpZiAodXJsICYmICF1cmwuZW5kc1dpdGgoJy8nKSkge1xyXG4gICAgICB1cmwgKz0gJy8nO1xyXG4gICAgfVxyXG5cclxuICAgIHVybCArPSBhcmd1bWVudC5zdGFydHNXaXRoKCcvJykgPyBhcmd1bWVudC5zdWJzdHJpbmcoMSkgOiBhcmd1bWVudDtcclxuICB9XHJcblxyXG4gIHJldHVybiB1cmw7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZFVybChiYXNlOiBzdHJpbmcsIHJlc291cmNlVHlwZT86IHN0cmluZywgaWQ/OiBzdHJpbmcsIG9wZXJhdGlvbj86IHN0cmluZywgcGFyYW1zPzoge1trZXk6IHN0cmluZ106IGFueX0pIHtcclxuICBsZXQgcGF0aCA9IGJhc2U7XHJcblxyXG4gIGlmICghcGF0aCkge1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgaWYgKHJlc291cmNlVHlwZSkge1xyXG4gICAgcGF0aCA9IGpvaW5VcmwocGF0aCwgcmVzb3VyY2VUeXBlKTtcclxuXHJcbiAgICBpZiAoaWQpIHtcclxuICAgICAgcGF0aCA9IGpvaW5VcmwocGF0aCwgaWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWYgKG9wZXJhdGlvbikge1xyXG4gICAgcGF0aCA9IGpvaW5VcmwocGF0aCwgb3BlcmF0aW9uKTtcclxuICB9XHJcblxyXG4gIGlmIChwYXJhbXMpIHtcclxuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpO1xyXG4gICAgY29uc3QgcGFyYW1BcnJheSA9IGtleXMubWFwKChrZXkpID0+IHtcclxuICAgICAgY29uc3QgdmFsdWUgPSBlbmNvZGVVUklDb21wb25lbnQocGFyYW1zW2tleV0pO1xyXG4gICAgICByZXR1cm4ga2V5ICsgJz0nICsgdmFsdWU7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAocGFyYW1BcnJheS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHBhdGggKz0gJz8nICsgcGFyYW1BcnJheS5qb2luKCcmJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcGF0aDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlVXJsKHVybDogc3RyaW5nLCBiYXNlPzogc3RyaW5nKSB7XHJcbiAgY29uc3QgcGFyc2VVcmxSZWdleCA9IC8oQWNjb3VudHxBY3Rpdml0eURlZmluaXRpb258QWR2ZXJzZUV2ZW50fEFsbGVyZ3lJbnRvbGVyYW5jZXxBcHBvaW50bWVudHxBcHBvaW50bWVudFJlc3BvbnNlfEF1ZGl0RXZlbnR8QmFzaWN8QmluYXJ5fEJvZHlTaXRlfEJ1bmRsZXxDYXBhYmlsaXR5U3RhdGVtZW50fENhcmVQbGFufENhcmVUZWFtfENoYXJnZUl0ZW18Q2xhaW18Q2xhaW1SZXNwb25zZXxDbGluaWNhbEltcHJlc3Npb258Q29kZVN5c3RlbXxDb21tdW5pY2F0aW9ufENvbW11bmljYXRpb25SZXF1ZXN0fENvbXBhcnRtZW50RGVmaW5pdGlvbnxDb21wb3NpdGlvbnxDb25jZXB0TWFwfENvbmRpdGlvbnxDb25zZW50fENvbnRyYWN0fENvdmVyYWdlfERhdGFFbGVtZW50fERldGVjdGVkSXNzdWV8RGV2aWNlfERldmljZUNvbXBvbmVudHxEZXZpY2VNZXRyaWN8RGV2aWNlUmVxdWVzdHxEZXZpY2VVc2VTdGF0ZW1lbnR8RGlhZ25vc3RpY1JlcG9ydHxEb2N1bWVudE1hbmlmZXN0fERvY3VtZW50UmVmZXJlbmNlfEVsaWdpYmlsaXR5UmVxdWVzdHxFbGlnaWJpbGl0eVJlc3BvbnNlfEVuY291bnRlcnxFbmRwb2ludHxFbnJvbGxtZW50UmVxdWVzdHxFbnJvbGxtZW50UmVzcG9uc2V8RXBpc29kZU9mQ2FyZXxFeHBhbnNpb25Qcm9maWxlfEV4cGxhbmF0aW9uT2ZCZW5lZml0fEZhbWlseU1lbWJlckhpc3Rvcnl8RmxhZ3xHb2FsfEdyYXBoRGVmaW5pdGlvbnxHcm91cHxHdWlkYW5jZVJlc3BvbnNlfEhlYWx0aGNhcmVTZXJ2aWNlfEltYWdpbmdNYW5pZmVzdHxJbWFnaW5nU3R1ZHl8SW1tdW5pemF0aW9ufEltbXVuaXphdGlvblJlY29tbWVuZGF0aW9ufEltcGxlbWVudGF0aW9uR3VpZGV8TGlicmFyeXxMaW5rYWdlfExpc3R8TG9jYXRpb258TWVhc3VyZXxNZWFzdXJlUmVwb3J0fE1lZGlhfE1lZGljYXRpb25BZG1pbmlzdHJhdGlvbnxNZWRpY2F0aW9uRGlzcGVuc2V8TWVkaWNhdGlvblJlcXVlc3R8TWVkaWNhdGlvblN0YXRlbWVudHxNZWRpY2F0aW9ufE1lc3NhZ2VEZWZpbml0aW9ufE1lc3NhZ2VIZWFkZXJ8TmFtaW5nU3lzdGVtfE51dHJpdGlvbk9yZGVyfE9ic2VydmF0aW9ufE9wZXJhdGlvbkRlZmluaXRpb258T3BlcmF0aW9uT3V0Y29tZXxPcmdhbml6YXRpb258UGF0aWVudHxQYXltZW50Tm90aWNlfFBheW1lbnRSZWNvbmNpbGlhdGlvbnxQZXJzb258UGxhbkRlZmluaXRpb258UHJhY3RpdGlvbmVyUm9sZXxQcmFjdGl0aW9uZXJ8UHJvY2VkdXJlUmVxdWVzdHxQcm9jZWR1cmV8UHJvY2Vzc1JlcXVlc3R8UHJvY2Vzc1Jlc3BvbnNlfFByb3ZlbmFuY2V8UXVlc3Rpb25uYWlyZVJlc3BvbnNlfFF1ZXN0aW9ubmFpcmV8UmVmZXJyYWxSZXF1ZXN0fFJlbGF0ZWRQZXJzb258UmVxdWVzdEdyb3VwfFJlc2VhcmNoU3R1ZHl8UmVzZWFyY2hTdWJqZWN0fFJpc2tBc3Nlc3NtZW50fFNjaGVkdWxlfFNlYXJjaFBhcmFtZXRlcnxTZXF1ZW5jZXxTZXJ2aWNlRGVmaW5pdGlvbnxTbG90fFNwZWNpbWVufFN0cnVjdHVyZURlZmluaXRpb258U3RydWN0dXJlTWFwfFN1YnNjcmlwdGlvbnxTdWJzdGFuY2V8U3VwcGx5RGVsaXZlcnl8U3VwcGx5UmVxdWVzdHxUYXNrfFRlc3RSZXBvcnR8VGVzdFNjcmlwdHxWYWx1ZVNldHxWaXNpb25QcmVzY3JpcHRpb24pKFxcLyhbQS1aYS16MC05XFwtXFwuXSspKT8oXFwvX2hpc3RvcnlcXC8oW0EtWmEtejAtOVxcLVxcLl17MSw2NH0pKT8vZztcclxuXHJcbiAgaWYgKGJhc2UgJiYgYmFzZS5sYXN0SW5kZXhPZignLycpID09PSBiYXNlLmxlbmd0aC0xKSB7XHJcbiAgICBiYXNlID0gYmFzZS5zdWJzdHJpbmcoMCwgYmFzZS5sZW5ndGggLSAxKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IG5leHQgPSB1cmwucmVwbGFjZShiYXNlLCAnJyk7XHJcbiAgY29uc3QgbWF0Y2ggPSBwYXJzZVVybFJlZ2V4LmV4ZWMobmV4dCk7XHJcblxyXG4gIGlmIChtYXRjaCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcmVzb3VyY2VUeXBlOiBtYXRjaFsxXSxcclxuICAgICAgaWQ6IG1hdGNoWzNdLFxyXG4gICAgICBoaXN0b3J5SWQ6IG1hdGNoWzVdXHJcbiAgICB9O1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZoaXJTdHUzSW5zdGFuY2UoKSB7XHJcbiAgLy8gVE9ETzogRGV0ZXJtaW5lIHdoaWNoIEZISVIgdmVyc2lvbiB0byBsb2FkXHJcbiAgY29uc3QgcGFyc2VyID0gbmV3IFBhcnNlQ29uZm9ybWFuY2UoZmFsc2UsIEZoaXJWZXJzaW9ucy5TVFUzKTtcclxuICBwYXJzZXIucGFyc2VCdW5kbGUoc3R1M1ZhbHVlU2V0cyk7XHJcbiAgcGFyc2VyLnBhcnNlQnVuZGxlKHN0dTNUeXBlcyk7XHJcbiAgcGFyc2VyLnBhcnNlQnVuZGxlKHN0dTNSZXNvdXJjZXMpO1xyXG4gIGNvbnN0IGZoaXIgPSBuZXcgRmhpcihwYXJzZXIpO1xyXG4gIHJldHVybiBmaGlyO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmhpclI0SW5zdGFuY2UoKSB7XHJcbiAgY29uc3QgZmhpciA9IG5ldyBGaGlyKCk7XHJcbiAgLy8gVE9ETzogQ29uc2lkZXIgbG9hZGluZyBzcGVjaWZpYyBiYXNlIHJlc291cmNlcyBmb3IgRkhJUiBSNC4uLlxyXG4gIHJldHVybiBmaGlyO1xyXG59XHJcbiJdfQ==
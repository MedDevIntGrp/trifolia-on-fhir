"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const request = require("request");
class BaseTools {
    getConformance(server) {
        return new Promise((resolve, reject) => {
            const conformanceUrl = server + (server.endsWith('/') ? '' : '/') + 'metadata';
            request({ url: conformanceUrl, json: true }, (err, response, body) => {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(body);
                }
            });
        });
    }
    getNextResources(url, resourceType) {
        console.log(`Getting next page of resources of type ${resourceType}`);
        return new Promise((resolve, reject) => {
            request({ url: url, json: true }, (err, response, body) => {
                if (err) {
                    reject(err);
                    return;
                }
                console.log(`Found ${body.total} more resources for ${resourceType}`);
                let resources = (body.entry || []).map((entry) => entry.resource);
                const foundNextLink = (body.link || []).find((link) => link.relation === 'next');
                if (foundNextLink) {
                    this.getNextResources(foundNextLink.url, resourceType)
                        .then((nextResources) => {
                        resources = resources.concat(nextResources);
                        resolve(resources);
                    })
                        .catch((nextErr) => reject(nextErr));
                }
                else {
                    resolve(resources);
                }
            });
        });
    }
    getAllResourcesByType(server, resourceTypes) {
        return new Promise((resolve, reject) => {
            const nextResourceType = resourceTypes.pop();
            const url = server + (server.endsWith('/') ? '' : '/') + nextResourceType;
            console.log(`Getting all resources of type ${nextResourceType}`);
            this.getNextResources(url, nextResourceType)
                .then((resources) => {
                if (resourceTypes.length > 0) {
                    this.getAllResourcesByType(server, resourceTypes)
                        .then((nextResources) => {
                        resources = resources.concat(nextResources);
                        resolve(resources);
                    })
                        .catch((err) => reject(err));
                }
                else {
                    resolve(resources);
                }
            })
                .catch((err) => reject(err));
        });
    }
    getAllResources(server) {
        return new Promise((resolve, reject) => {
            this.getConformance(server)
                .then((conformance) => {
                let promises = [];
                const resourceTypes = [];
                (conformance.rest || []).forEach((rest) => {
                    (rest.resource || []).forEach((resource) => resourceTypes.push(resource.type));
                });
                return this.getAllResourcesByType(server, resourceTypes);
            })
                .then((allResources) => allResources)
                .catch((err) => reject(err));
        });
    }
    saveResource(server, resource) {
        return new Promise((resolve, reject) => {
            resolve();
        });
    }
}
exports.BaseTools = BaseTools;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZVRvb2xzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFzZVRvb2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBT25DLE1BQWEsU0FBUztJQUNWLGNBQWMsQ0FBQyxNQUFjO1FBQ3JDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsTUFBTSxjQUFjLEdBQUcsTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUM7WUFDL0UsT0FBTyxDQUFDLEVBQUMsR0FBRyxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFFO2dCQUNqRSxJQUFJLEdBQUcsRUFBRTtvQkFDUCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2I7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNmO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxHQUFXLEVBQUUsWUFBb0I7UUFDeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUV0RSxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLE9BQU8sQ0FBQyxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBQyxFQUFFLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFZLEVBQUUsRUFBRTtnQkFDOUQsSUFBSSxHQUFHLEVBQUU7b0JBQ1AsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUNaLE9B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R0FBRyxFQUFFLENBQUM7Z0JBRXpCLENBQUMsV0FBVyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtvQkFDeEMsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDakYsQ0FBQyxDQUFDLENBQUM7Z0JBRUgsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1lBQzNELENBQUMsQ0FBQztpQkFDRCxJQUFJLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQztpQkFDcEMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFUyxZQUFZLENBQUMsTUFBYyxFQUFFLFFBQXdCO1FBQzdELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQTFGRCw4QkEwRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ3VuZGVyc2NvcmUnO1xyXG5pbXBvcnQge0ZoaXJ9IGZyb20gJy4uL3NlcnZlci9jb250cm9sbGVycy9tb2RlbHMnO1xyXG5pbXBvcnQgQ2FwYWJpbGl0eVN0YXRlbWVudCA9IEZoaXIuQ2FwYWJpbGl0eVN0YXRlbWVudDtcclxuaW1wb3J0IERvbWFpblJlc291cmNlID0gRmhpci5Eb21haW5SZXNvdXJjZTtcclxuaW1wb3J0IEJ1bmRsZSA9IEZoaXIuQnVuZGxlO1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhc2VUb29scyB7XHJcbiAgcHJvdGVjdGVkIGdldENvbmZvcm1hbmNlKHNlcnZlcjogc3RyaW5nKTogUHJvbWlzZTxDYXBhYmlsaXR5U3RhdGVtZW50PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCBjb25mb3JtYW5jZVVybCA9IHNlcnZlciArIChzZXJ2ZXIuZW5kc1dpdGgoJy8nKSA/ICcnIDogJy8nKSArICdtZXRhZGF0YSc7XHJcbiAgICAgIHJlcXVlc3Qoe3VybDogY29uZm9ybWFuY2VVcmwsIGpzb246IHRydWV9LCAoZXJyLCByZXNwb25zZSwgYm9keSkgPT4ge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXNvbHZlKGJvZHkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0TmV4dFJlc291cmNlcyh1cmw6IHN0cmluZywgcmVzb3VyY2VUeXBlOiBzdHJpbmcpOiBQcm9taXNlPERvbWFpblJlc291cmNlW10+IHtcclxuICAgIGNvbnNvbGUubG9nKGBHZXR0aW5nIG5leHQgcGFnZSBvZiByZXNvdXJjZXMgb2YgdHlwZSAke3Jlc291cmNlVHlwZX1gKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICByZXF1ZXN0KHt1cmw6IHVybCwganNvbjogdHJ1ZX0sIChlcnIsIHJlc3BvbnNlLCBib2R5OiBCdW5kbGUpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnNvbGUubG9nKGBGb3VuZCAke2JvZHkudG90YWx9IG1vcmUgcmVzb3VyY2VzIGZvciAke3Jlc291cmNlVHlwZX1gKTtcclxuXHJcbiAgICAgICAgbGV0IHJlc291cmNlcyA9IChib2R5LmVudHJ5IHx8IFtdKS5tYXAoKGVudHJ5KSA9PiBlbnRyeS5yZXNvdXJjZSk7XHJcbiAgICAgICAgY29uc3QgZm91bmROZXh0TGluayA9IChib2R5LmxpbmsgfHwgW10pLmZpbmQoKGxpbmspID0+IGxpbmsucmVsYXRpb24gPT09ICduZXh0Jyk7XHJcblxyXG4gICAgICAgIGlmIChmb3VuZE5leHRMaW5rKSB7XHJcbiAgICAgICAgICB0aGlzLmdldE5leHRSZXNvdXJjZXMoZm91bmROZXh0TGluay51cmwsIHJlc291cmNlVHlwZSlcclxuICAgICAgICAgICAgLnRoZW4oKG5leHRSZXNvdXJjZXMpID0+IHtcclxuICAgICAgICAgICAgICByZXNvdXJjZXMgPSByZXNvdXJjZXMuY29uY2F0KG5leHRSZXNvdXJjZXMpO1xyXG4gICAgICAgICAgICAgIHJlc29sdmUocmVzb3VyY2VzKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKChuZXh0RXJyKSA9PiByZWplY3QobmV4dEVycikpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc291cmNlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRBbGxSZXNvdXJjZXNCeVR5cGUoc2VydmVyOiBzdHJpbmcsIHJlc291cmNlVHlwZXM6IHN0cmluZ1tdKTogUHJvbWlzZTxEb21haW5SZXNvdXJjZVtdPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCBuZXh0UmVzb3VyY2VUeXBlID0gcmVzb3VyY2VUeXBlcy5wb3AoKTtcclxuICAgICAgY29uc3QgdXJsID0gc2VydmVyICsgKHNlcnZlci5lbmRzV2l0aCgnLycpID8gJycgOiAnLycpICsgbmV4dFJlc291cmNlVHlwZTtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGBHZXR0aW5nIGFsbCByZXNvdXJjZXMgb2YgdHlwZSAke25leHRSZXNvdXJjZVR5cGV9YCk7XHJcblxyXG4gICAgICB0aGlzLmdldE5leHRSZXNvdXJjZXModXJsLCBuZXh0UmVzb3VyY2VUeXBlKVxyXG4gICAgICAgIC50aGVuKChyZXNvdXJjZXMpID0+IHtcclxuICAgICAgICAgIGlmIChyZXNvdXJjZVR5cGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5nZXRBbGxSZXNvdXJjZXNCeVR5cGUoc2VydmVyLCByZXNvdXJjZVR5cGVzKVxyXG4gICAgICAgICAgICAgIC50aGVuKChuZXh0UmVzb3VyY2VzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXNvdXJjZXMgPSByZXNvdXJjZXMuY29uY2F0KG5leHRSZXNvdXJjZXMpO1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNvdXJjZXMpO1xyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc29sdmUocmVzb3VyY2VzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBnZXRBbGxSZXNvdXJjZXMoc2VydmVyOiBzdHJpbmcpOiBQcm9taXNlPERvbWFpblJlc291cmNlW10+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuZ2V0Q29uZm9ybWFuY2Uoc2VydmVyKVxyXG4gICAgICAgIC50aGVuKChjb25mb3JtYW5jZSkgPT4ge1xyXG4gICAgICAgICAgbGV0IHByb21pc2VzID0gW107XHJcbiAgICAgICAgICBjb25zdCByZXNvdXJjZVR5cGVzID0gW107XHJcblxyXG4gICAgICAgICAgKGNvbmZvcm1hbmNlLnJlc3QgfHwgW10pLmZvckVhY2goKHJlc3QpID0+IHtcclxuICAgICAgICAgICAgKHJlc3QucmVzb3VyY2UgfHwgW10pLmZvckVhY2goKHJlc291cmNlKSA9PiByZXNvdXJjZVR5cGVzLnB1c2gocmVzb3VyY2UudHlwZSkpO1xyXG4gICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWxsUmVzb3VyY2VzQnlUeXBlKHNlcnZlciwgcmVzb3VyY2VUeXBlcyk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAudGhlbigoYWxsUmVzb3VyY2VzKSA9PiBhbGxSZXNvdXJjZXMpXHJcbiAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIHNhdmVSZXNvdXJjZShzZXJ2ZXI6IHN0cmluZywgcmVzb3VyY2U6IERvbWFpblJlc291cmNlKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICByZXNvbHZlKCk7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const request = require("request");
const _ = require("underscore");
class BaseTools {
    getConformance(server) {
        return new Promise((resolve, reject) => {
            const conformanceUrl = server + (server.endsWith('/') ? '' : '/') + 'metadata';
            request({ url: conformanceUrl, json: true }, (err, response, body) => {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(body);
                }
            });
        });
    }
    getNextResources(url, resourceType) {
        console.log(`Getting next page of resources of type ${resourceType}`);
        return new Promise((resolve, reject) => {
            request({ url: url, json: true }, (err, response, body) => {
                if (err) {
                    reject(err);
                    return;
                }
                console.log(`Found ${body.total} more resources for ${resourceType}`);
                let resources = _.map(body.entry, (entry) => entry.resource);
                const foundNextLink = _.find(body.link, (link) => link.relation === 'next');
                if (foundNextLink) {
                    this.getNextResources(foundNextLink.url, resourceType)
                        .then((nextResources) => {
                        resources = resources.concat(nextResources);
                        resolve(resources);
                    })
                        .catch((nextErr) => reject(nextErr));
                }
                else {
                    resolve(resources);
                }
            });
        });
    }
    getAllResourcesByType(server, resourceTypes) {
        return new Promise((resolve, reject) => {
            const nextResourceType = resourceTypes.pop();
            const url = server + (server.endsWith('/') ? '' : '/') + nextResourceType;
            console.log(`Getting all resources of type ${nextResourceType}`);
            this.getNextResources(url, nextResourceType)
                .then((resources) => {
                if (resourceTypes.length > 0) {
                    this.getAllResourcesByType(server, resourceTypes)
                        .then((nextResources) => {
                        resources = resources.concat(nextResources);
                        resolve(resources);
                    })
                        .catch((err) => reject(err));
                }
                else {
                    resolve(resources);
                }
            })
                .catch((err) => reject(err));
        });
    }
    getAllResources(server) {
        return new Promise((resolve, reject) => {
            this.getConformance(server)
                .then((conformance) => {
                let promises = [];
                const resourceTypes = [];
                _.each(conformance.rest, (rest) => {
                    _.each(rest.resource, (resource) => resourceTypes.push(resource.type));
                });
                return this.getAllResourcesByType(server, resourceTypes);
            })
                .then((allResources) => allResources)
                .catch((err) => reject(err));
        });
    }
    saveResource(server, resource) {
        return new Promise((resolve, reject) => {
            resolve();
        });
    }
}
exports.BaseTools = BaseTools;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZVRvb2xzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFzZVRvb2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLGdDQUFnQztBQU1oQyxNQUFhLFNBQVM7SUFDUixjQUFjLENBQUMsTUFBYztRQUNuQyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ25DLE1BQU0sY0FBYyxHQUFHLE1BQU0sR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDO1lBQy9FLE9BQU8sQ0FBQyxFQUFFLEdBQUcsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDakUsSUFBSSxHQUFHLEVBQUU7b0JBQ0wsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNmO3FCQUFNO29CQUNILE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDakI7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEdBQVcsRUFBRSxZQUFvQjtRQUN0RCxPQUFPLENBQUMsR0FBRyxDQUFDLDBDQUEwQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBRXRFLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsT0FBTyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQVksRUFBRSxFQUFFO2dCQUM5RCxJQUFJLEdBQUcsRUFBRTtvQkFDTCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ1osT0FBTztpQkFDVjtnQkFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSxDQUFDLEtBQUssdUJBQXVCLFlBQVksRUFBRSxDQUFDLENBQUM7Z0JBRXRFLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUM3RCxNQUFNLGFBQWEsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLEtBQUssTUFBTSxDQUFDLENBQUM7Z0JBRTVFLElBQUksYUFBYSxFQUFFO29CQUNmLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQzt5QkFDakQsSUFBSSxDQUFDLENBQUMsYUFBYSxFQUFFLEVBQUU7d0JBQ3BCLFNBQVMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO3dCQUM1QyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ3ZCLENBQUMsQ0FBQzt5QkFDRCxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2lCQUM1QztxQkFBTTtvQkFDSCxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7aUJBQ3RCO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxNQUFjLEVBQUUsYUFBdUI7UUFDakUsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxNQUFNLGdCQUFnQixHQUFHLGFBQWEsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUM3QyxNQUFNLEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLGdCQUFnQixDQUFDO1lBRTFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLGdCQUFnQixFQUFFLENBQUMsQ0FBQztZQUVqRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLGdCQUFnQixDQUFDO2lCQUN2QyxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtnQkFDaEIsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDMUIsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUM7eUJBQzVDLElBQUksQ0FBQyxDQUFDLGFBQWEsRUFBRSxFQUFFO3dCQUNwQixTQUFTLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQzt3QkFDNUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUN2QixDQUFDLENBQUM7eUJBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDcEM7cUJBQU07b0JBQ0gsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUN0QjtZQUNMLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVTLGVBQWUsQ0FBQyxNQUFjO1FBQ3BDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUM7aUJBQ3RCLElBQUksQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO2dCQUNsQixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7Z0JBQ2xCLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQztnQkFFekIsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQzlCLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDM0UsQ0FBQyxDQUFDLENBQUM7Z0JBRUgsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1lBQzdELENBQUMsQ0FBQztpQkFDRCxJQUFJLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQztpQkFDcEMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFUyxZQUFZLENBQUMsTUFBYyxFQUFFLFFBQXdCO1FBQzNELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsT0FBTyxFQUFFLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQTFGRCw4QkEwRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnO1xuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJztcbmltcG9ydCB7Rmhpcn0gZnJvbSAnLi4vc2VydmVyL2NvbnRyb2xsZXJzL21vZGVscyc7XG5pbXBvcnQgQ2FwYWJpbGl0eVN0YXRlbWVudCA9IEZoaXIuQ2FwYWJpbGl0eVN0YXRlbWVudDtcbmltcG9ydCBEb21haW5SZXNvdXJjZSA9IEZoaXIuRG9tYWluUmVzb3VyY2U7XG5pbXBvcnQgQnVuZGxlID0gRmhpci5CdW5kbGU7XG5cbmV4cG9ydCBjbGFzcyBCYXNlVG9vbHMge1xuICAgIHByb3RlY3RlZCBnZXRDb25mb3JtYW5jZShzZXJ2ZXI6IHN0cmluZyk6IFByb21pc2U8Q2FwYWJpbGl0eVN0YXRlbWVudD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29uZm9ybWFuY2VVcmwgPSBzZXJ2ZXIgKyAoc2VydmVyLmVuZHNXaXRoKCcvJykgPyAnJyA6ICcvJykgKyAnbWV0YWRhdGEnO1xuICAgICAgICAgICAgcmVxdWVzdCh7IHVybDogY29uZm9ybWFuY2VVcmwsIGpzb246IHRydWUgfSwgKGVyciwgcmVzcG9uc2UsIGJvZHkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYm9keSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TmV4dFJlc291cmNlcyh1cmw6IHN0cmluZywgcmVzb3VyY2VUeXBlOiBzdHJpbmcpOiBQcm9taXNlPERvbWFpblJlc291cmNlW10+IHtcbiAgICAgICAgY29uc29sZS5sb2coYEdldHRpbmcgbmV4dCBwYWdlIG9mIHJlc291cmNlcyBvZiB0eXBlICR7cmVzb3VyY2VUeXBlfWApO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICByZXF1ZXN0KHsgdXJsOiB1cmwsIGpzb246IHRydWUgfSwgKGVyciwgcmVzcG9uc2UsIGJvZHk6IEJ1bmRsZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgRm91bmQgJHtib2R5LnRvdGFsfSBtb3JlIHJlc291cmNlcyBmb3IgJHtyZXNvdXJjZVR5cGV9YCk7XG5cbiAgICAgICAgICAgICAgICBsZXQgcmVzb3VyY2VzID0gXy5tYXAoYm9keS5lbnRyeSwgKGVudHJ5KSA9PiBlbnRyeS5yZXNvdXJjZSk7XG4gICAgICAgICAgICAgICAgY29uc3QgZm91bmROZXh0TGluayA9IF8uZmluZChib2R5LmxpbmssIChsaW5rKSA9PiBsaW5rLnJlbGF0aW9uID09PSAnbmV4dCcpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGZvdW5kTmV4dExpbmspIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXROZXh0UmVzb3VyY2VzKGZvdW5kTmV4dExpbmsudXJsLCByZXNvdXJjZVR5cGUpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigobmV4dFJlc291cmNlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlcyA9IHJlc291cmNlcy5jb25jYXQobmV4dFJlc291cmNlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNvdXJjZXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgobmV4dEVycikgPT4gcmVqZWN0KG5leHRFcnIpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc291cmNlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0QWxsUmVzb3VyY2VzQnlUeXBlKHNlcnZlcjogc3RyaW5nLCByZXNvdXJjZVR5cGVzOiBzdHJpbmdbXSk6IFByb21pc2U8RG9tYWluUmVzb3VyY2VbXT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV4dFJlc291cmNlVHlwZSA9IHJlc291cmNlVHlwZXMucG9wKCk7XG4gICAgICAgICAgICBjb25zdCB1cmwgPSBzZXJ2ZXIgKyAoc2VydmVyLmVuZHNXaXRoKCcvJykgPyAnJyA6ICcvJykgKyBuZXh0UmVzb3VyY2VUeXBlO1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgR2V0dGluZyBhbGwgcmVzb3VyY2VzIG9mIHR5cGUgJHtuZXh0UmVzb3VyY2VUeXBlfWApO1xuXG4gICAgICAgICAgICB0aGlzLmdldE5leHRSZXNvdXJjZXModXJsLCBuZXh0UmVzb3VyY2VUeXBlKVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNvdXJjZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc291cmNlVHlwZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRBbGxSZXNvdXJjZXNCeVR5cGUoc2VydmVyLCByZXNvdXJjZVR5cGVzKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChuZXh0UmVzb3VyY2VzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlcyA9IHJlc291cmNlcy5jb25jYXQobmV4dFJlc291cmNlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzb3VyY2VzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc291cmNlcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRBbGxSZXNvdXJjZXMoc2VydmVyOiBzdHJpbmcpOiBQcm9taXNlPERvbWFpblJlc291cmNlW10+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q29uZm9ybWFuY2Uoc2VydmVyKVxuICAgICAgICAgICAgICAgIC50aGVuKChjb25mb3JtYW5jZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcHJvbWlzZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VUeXBlcyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChjb25mb3JtYW5jZS5yZXN0LCAocmVzdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHJlc3QucmVzb3VyY2UsIChyZXNvdXJjZSkgPT4gcmVzb3VyY2VUeXBlcy5wdXNoKHJlc291cmNlLnR5cGUpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWxsUmVzb3VyY2VzQnlUeXBlKHNlcnZlciwgcmVzb3VyY2VUeXBlcyk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAudGhlbigoYWxsUmVzb3VyY2VzKSA9PiBhbGxSZXNvdXJjZXMpXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHNhdmVSZXNvdXJjZShzZXJ2ZXI6IHN0cmluZywgcmVzb3VyY2U6IERvbWFpblJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn0iXX0=
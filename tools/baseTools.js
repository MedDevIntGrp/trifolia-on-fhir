"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class BaseTools {
    getConformance(server) {
        const conformanceUrl = server + (server.endsWith('/') ? '' : '/') + 'metadata';
        return new Promise((resolve, reject) => {
            rp({ url: conformanceUrl, json: true })
                .then((results) => resolve(results))
                .catch((err) => reject(err));
        });
    }
    getNextResources(url, resourceType) {
        console.log(`Getting next page of resources of type ${resourceType}`);
        return new Promise((resolve, reject) => {
            rp({ url: url, json: true })
                .then((body) => {
                console.log(`Found ${body.total} more resources for ${resourceType}`);
                let resources = (body.entry || []).map((entry) => entry.resource);
                const foundNextLink = (body.link || []).find((link) => link.relation === 'next');
                if (foundNextLink) {
                    this.getNextResources(foundNextLink.url, resourceType)
                        .then((nextResources) => {
                        resources = resources.concat(nextResources);
                        return resolve(resources);
                    })
                        .catch((nextErr) => reject(nextErr));
                }
                else {
                    return resolve(resources);
                }
            })
                .catch((err) => reject(err));
        });
    }
    getAllResourcesByType(server, resourceTypes) {
        return new Promise((resolve, reject) => {
            const nextResourceType = resourceTypes.pop();
            const url = server + (server.endsWith('/') ? '' : '/') + nextResourceType;
            console.log(`Getting all resources of type ${nextResourceType}`);
            this.getNextResources(url, nextResourceType)
                .then((resources) => {
                if (resourceTypes.length > 0) {
                    this.getAllResourcesByType(server, resourceTypes)
                        .then((nextResources) => {
                        resources = resources.concat(nextResources);
                        resolve(resources);
                    })
                        .catch((err) => reject(err));
                }
                else {
                    resolve(resources);
                }
            })
                .catch((err) => reject(err));
        });
    }
    getAllResources(server) {
        return new Promise((resolve, reject) => {
            this.getConformance(server)
                .then((conformance) => {
                let promises = [];
                const resourceTypes = [];
                (conformance.rest || []).forEach((rest) => {
                    (rest.resource || []).forEach((resource) => resourceTypes.push(resource.type));
                });
                return this.getAllResourcesByType(server, resourceTypes);
            })
                .then((allResources) => allResources)
                .catch((err) => reject(err));
        });
    }
    getResource(server, resourceType, id) {
        const options = {
            method: 'GET',
            url: server + (server.endsWith('/') ? '' : '/') + resourceType + '/' + id,
            json: true
        };
        return new Promise((resolve, reject) => {
            rp(options)
                .then((results) => resolve(results))
                .catch((err) => reject(err));
        });
    }
    saveResource(server, resource) {
        const options = {
            method: 'PUT',
            url: server + (server.endsWith('/') ? '' : '/') + resource.resourceType + '/' + resource.id,
            json: true,
            body: resource
        };
        return rp(options);
    }
    printError(err) {
        if (err.error && err.error.resourceType === 'OperationOutcome') {
            if (err.error.issue && err.error.issue.length > 0) {
                err.error.issue.forEach((issue) => console.error(issue.diagnostics));
            }
            else if (err.err.text && err.error.text.div) {
                console.error(err.error.text.div);
            }
            else {
                console.error(err);
            }
        }
        else {
            console.error(err);
        }
    }
}
exports.BaseTools = BaseTools;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZVRvb2xzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFzZVRvb2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsTUFBYSxTQUFTO0lBQ1YsY0FBYyxDQUFDLE1BQWM7UUFDckMsTUFBTSxjQUFjLEdBQUcsTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUM7UUFDL0UsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztpQkFDcEMsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ25DLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDakMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsR0FBVyxFQUFFLFlBQW9CO1FBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMsMENBQTBDLFlBQVksRUFBRSxDQUFDLENBQUM7UUFFdEUsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztpQkFDekIsSUFBSSxDQUFDLENBQUMsSUFBWSxFQUFFLEVBQUU7Z0JBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLENBQUMsS0FBSyx1QkFBdUIsWUFBWSxFQUFFLENBQUMsQ0FBQztnQkFFdEUsSUFBSSxTQUFTLEdBQXFCLENB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O1lBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNwQjtJQUNILENBQUM7Q0FDRjtBQW5IRCw4QkFtSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0J1bmRsZSwgQ2FwYWJpbGl0eVN0YXRlbWVudCwgRG9tYWluUmVzb3VyY2V9IGZyb20gJy4uL2xpYnMvdG9mLWxpYi9zcmMvbGliL3N0dTMvZmhpcic7XHJcblxyXG5leHBvcnQgY2xhc3MgQmFzZVRvb2xzIHtcclxuICBwcm90ZWN0ZWQgZ2V0Q29uZm9ybWFuY2Uoc2VydmVyOiBzdHJpbmcpOiBQcm9taXNlPENhcGFiaWxpdHlTdGF0ZW1lbnQ+IHtcclxuICAgIGNvbnN0IGNvbmZvcm1hbmNlVXJsID0gc2VydmVyICsgKHNlcnZlci5lbmRzV2l0aCgnLycpID8gJycgOiAnLycpICsgJ21ldGFkYXRhJztcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHJwKHsgdXJsOiBjb25mb3JtYW5jZVVybCwganNvbjogdHJ1ZSB9KVxyXG4gICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXNvbHZlKHJlc3VsdHMpKVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0TmV4dFJlc291cmNlcyh1cmw6IHN0cmluZywgcmVzb3VyY2VUeXBlOiBzdHJpbmcpOiBQcm9taXNlPERvbWFpblJlc291cmNlW10+IHtcclxuICAgIGNvbnNvbGUubG9nKGBHZXR0aW5nIG5leHQgcGFnZSBvZiByZXNvdXJjZXMgb2YgdHlwZSAke3Jlc291cmNlVHlwZX1gKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBycCh7IHVybDogdXJsLCBqc29uOiB0cnVlIH0pXHJcbiAgICAgICAgLnRoZW4oKGJvZHk6IEJ1bmRsZSkgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYEZvdW5kICR7Ym9keS50b3RhbH0gbW9yZSByZXNvdXJjZXMgZm9yICR7cmVzb3VyY2VUeXBlfWApO1xyXG5cclxuICAgICAgICAgIGxldCByZXNvdXJjZXM6IERvbWFpblJlc291cmNlW10gPSAoYm9keS5lbnRyeSB8fCBbXSkubWFwKChlbnRyeSkgPT4gZW50cnkucmVzb3VyY2UpO1xyXG4gICAgICAgICAgY29uc3QgZm91bmROZXh0TGluayA9IChib2R5LmxpbmsgfHwgW10pLmZpbmQoKGxpbmspID0+IGxpbmsucmVsYXRpb24gPT09ICduZXh0Jyk7XHJcblxyXG4gICAgICAgICAgaWYgKGZvdW5kTmV4dExpbmspIHtcclxuICAgICAgICAgICAgdGhpcy5nZXROZXh0UmVzb3VyY2VzKGZvdW5kTmV4dExpbmsudXJsLCByZXNvdXJjZVR5cGUpXHJcbiAgICAgICAgICAgICAgLnRoZW4oKG5leHRSZXNvdXJjZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc291cmNlcyA9IHJlc291cmNlcy5jb25jYXQobmV4dFJlc291cmNlcyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShyZXNvdXJjZXMpO1xyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgLmNhdGNoKChuZXh0RXJyKSA9PiByZWplY3QobmV4dEVycikpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzb3VyY2VzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QWxsUmVzb3VyY2VzQnlUeXBlKHNlcnZlcjogc3RyaW5nLCByZXNvdXJjZVR5cGVzOiBzdHJpbmdbXSk6IFByb21pc2U8RG9tYWluUmVzb3VyY2VbXT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgbmV4dFJlc291cmNlVHlwZSA9IHJlc291cmNlVHlwZXMucG9wKCk7XHJcbiAgICAgIGNvbnN0IHVybCA9IHNlcnZlciArIChzZXJ2ZXIuZW5kc1dpdGgoJy8nKSA/ICcnIDogJy8nKSArIG5leHRSZXNvdXJjZVR5cGU7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhgR2V0dGluZyBhbGwgcmVzb3VyY2VzIG9mIHR5cGUgJHtuZXh0UmVzb3VyY2VUeXBlfWApO1xyXG5cclxuICAgICAgdGhpcy5nZXROZXh0UmVzb3VyY2VzKHVybCwgbmV4dFJlc291cmNlVHlwZSlcclxuICAgICAgICAudGhlbigocmVzb3VyY2VzKSA9PiB7XHJcbiAgICAgICAgICBpZiAocmVzb3VyY2VUeXBlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0QWxsUmVzb3VyY2VzQnlUeXBlKHNlcnZlciwgcmVzb3VyY2VUeXBlcylcclxuICAgICAgICAgICAgICAudGhlbigobmV4dFJlc291cmNlcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzID0gcmVzb3VyY2VzLmNvbmNhdChuZXh0UmVzb3VyY2VzKTtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzb3VyY2VzKTtcclxuICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXNvbHZlKHJlc291cmNlcyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZ2V0QWxsUmVzb3VyY2VzKHNlcnZlcjogc3RyaW5nKTogUHJvbWlzZTxEb21haW5SZXNvdXJjZVtdPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLmdldENvbmZvcm1hbmNlKHNlcnZlcilcclxuICAgICAgICAudGhlbigoY29uZm9ybWFuY2UpID0+IHtcclxuICAgICAgICAgIGxldCBwcm9taXNlcyA9IFtdO1xyXG4gICAgICAgICAgY29uc3QgcmVzb3VyY2VUeXBlcyA9IFtdO1xyXG5cclxuICAgICAgICAgIChjb25mb3JtYW5jZS5yZXN0IHx8IFtdKS5mb3JFYWNoKChyZXN0KSA9PiB7XHJcbiAgICAgICAgICAgIChyZXN0LnJlc291cmNlIHx8IFtdKS5mb3JFYWNoKChyZXNvdXJjZSkgPT4gcmVzb3VyY2VUeXBlcy5wdXNoKHJlc291cmNlLnR5cGUpKTtcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgIHJldHVybiB0aGlzLmdldEFsbFJlc291cmNlc0J5VHlwZShzZXJ2ZXIsIHJlc291cmNlVHlwZXMpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnRoZW4oKGFsbFJlc291cmNlcykgPT4gYWxsUmVzb3VyY2VzKVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBnZXRSZXNvdXJjZShzZXJ2ZXI6IHN0cmluZywgcmVzb3VyY2VUeXBlOiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBQcm9taXNlPERvbWFpblJlc291cmNlPiB7XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBtZXRob2Q6ICdHRVQnLFxyXG4gICAgICB1cmw6IHNlcnZlciArIChzZXJ2ZXIuZW5kc1dpdGgoJy8nKSA/ICcnIDogJy8nKSArIHJlc291cmNlVHlwZSArICcvJyArIGlkLFxyXG4gICAgICBqc29uOiB0cnVlXHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHJwKG9wdGlvbnMpXHJcbiAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlc29sdmUocmVzdWx0cykpXHJcbiAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIHNhdmVSZXNvdXJjZShzZXJ2ZXI6IHN0cmluZywgcmVzb3VyY2U6IERvbWFpblJlc291cmNlKSB7XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBtZXRob2Q6ICdQVVQnLFxyXG4gICAgICB1cmw6IHNlcnZlciArIChzZXJ2ZXIuZW5kc1dpdGgoJy8nKSA/ICcnIDogJy8nKSArIHJlc291cmNlLnJlc291cmNlVHlwZSArICcvJyArIHJlc291cmNlLmlkLFxyXG4gICAgICBqc29uOiB0cnVlLFxyXG4gICAgICBib2R5OiByZXNvdXJjZVxyXG4gICAgfTtcclxuICAgIHJldHVybiBycChvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBwcmludEVycm9yKGVycikge1xyXG4gICAgaWYgKGVyci5lcnJvciAmJiBlcnIuZXJyb3IucmVzb3VyY2VUeXBlID09PSAnT3BlcmF0aW9uT3V0Y29tZScpIHtcclxuICAgICAgaWYgKGVyci5lcnJvci5pc3N1ZSAmJiBlcnIuZXJyb3IuaXNzdWUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGVyci5lcnJvci5pc3N1ZS5mb3JFYWNoKChpc3N1ZTogYW55KSA9PiBjb25zb2xlLmVycm9yKGlzc3VlLmRpYWdub3N0aWNzKSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXJyLmVyci50ZXh0ICYmIGVyci5lcnJvci50ZXh0LmRpdikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLmVycm9yLnRleHQuZGl2KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19
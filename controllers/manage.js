"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const AuthHelper = require("../authHelper");
const _ = require("underscore");
const config = require("config");
const serverConfig = config.get('server');
class ManageController {
    constructor(io, ioConnections) {
        this.io = io;
        this.ioConnections = ioConnections;
    }
    static initRoutes() {
        const router = express.Router();
        router.post('/user/active/message', AuthHelper.checkJwt, (req, res) => {
            if (req.headers['admin-code'] !== serverConfig['admin-code']) {
                return res.status(401).send('You have not authenticated request as an admin');
            }
            const controller = new ManageController(req.io, req.ioConnections);
            controller.sendMessageToActiveUsers(req.body.message)
                .then((results) => res.send(results))
                .catch((err) => res.status(500).send(err));
        });
        router.get('/user/active', AuthHelper.checkJwt, (req, res) => {
            if (req.headers['admin-code'] !== serverConfig['admin-code']) {
                return res.status(401).send('You have not authenticated request as an admin');
            }
            const controller = new ManageController(req.io, req.ioConnections);
            controller.getActiveUsers()
                .then((results) => res.send(results))
                .catch((err) => res.status(500).send(err));
        });
        return router;
    }
    getActiveUsers() {
        return new Promise((resolve) => {
            const connections = _.map(this.ioConnections, (connection) => {
                let name;
                if (connection.practitioner && connection.practitioner.name && connection.practitioner.name.length > 0) {
                    name = connection.practitioner.name[0].family;
                    if (connection.practitioner.name[0].given && connection.practitioner.name[0].given.length > 0) {
                        if (name) {
                            name += ', ';
                        }
                        name += connection.practitioner.name[0].given.join(' ');
                    }
                }
                return {
                    socketId: connection.id,
                    userId: connection.userProfile ? connection.userProfile.user_id : null,
                    email: connection.userProfile ? connection.userProfile.email : null,
                    practitionerReference: connection.practitioner ? `Practitioner/${connection.practitioner.id}` : null,
                    name: name
                };
            });
            resolve(connections);
        });
    }
    sendMessageToActiveUsers(message) {
        return new Promise((resolve) => {
            this.io.emit('message', message);
            resolve();
        });
    }
}
exports.ManageController = ManageController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFuYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDRDQUE0QztBQUU1QyxnQ0FBZ0M7QUFHaEMsaUNBQWlDO0FBR2pDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFFMUM7SUFJSSxZQUFZLEVBQVUsRUFBRSxhQUFnQztRQUNwRCxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO0lBQ3ZDLENBQUM7SUFFTSxNQUFNLENBQUMsVUFBVTtRQUNwQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBbUIsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFrQixHQUFvQixFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ3JILElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsS0FBSyxZQUFZLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQzFELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0RBQWdELENBQUMsQ0FBQzthQUNqRjtZQUVELE1BQU0sVUFBVSxHQUFHLElBQUksZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDbkUsVUFBVSxDQUFDLHdCQUF3QixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO2lCQUNoRCxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ3BDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0s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QyxPQUFPLEVBQUUsRUFBRTtZQUMzQixJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDakMsT0FBTyxFQUFFLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQXpFRCw0Q0F5RUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgKiBhcyBBdXRoSGVscGVyIGZyb20gJy4uL2F1dGhIZWxwZXInO1xyXG5pbXBvcnQge0Nvbm5lY3Rpb25Nb2RlbCwgRXh0ZW5kZWRSZXF1ZXN0LCBJT0Nvbm5lY3Rpb259IGZyb20gJy4vbW9kZWxzJztcclxuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJztcclxuaW1wb3J0IHtTZXJ2ZXJ9IGZyb20gJ3NvY2tldC5pbyc7XHJcbmltcG9ydCB7UmVxdWVzdEhhbmRsZXJ9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgKiBhcyBjb25maWcgZnJvbSAnY29uZmlnJztcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcclxuXHJcbmNvbnN0IHNlcnZlckNvbmZpZyA9IGNvbmZpZy5nZXQoJ3NlcnZlcicpO1xyXG5cclxuZXhwb3J0IGNsYXNzIE1hbmFnZUNvbnRyb2xsZXIge1xyXG4gICAgcHJpdmF0ZSBpbzogU2VydmVyO1xyXG4gICAgcHJpdmF0ZSBpb0Nvbm5lY3Rpb25zOiBDb25uZWN0aW9uTW9kZWxbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihpbzogU2VydmVyLCBpb0Nvbm5lY3Rpb25zOiBDb25uZWN0aW9uTW9kZWxbXSkge1xyXG4gICAgICAgIHRoaXMuaW8gPSBpbztcclxuICAgICAgICB0aGlzLmlvQ29ubmVjdGlvbnMgPSBpb0Nvbm5lY3Rpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdFJvdXRlcygpIHtcclxuICAgICAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG5cclxuICAgICAgICByb3V0ZXIucG9zdCgnL3VzZXIvYWN0aXZlL21lc3NhZ2UnLCA8UmVxdWVzdEhhbmRsZXI+IEF1dGhIZWxwZXIuY2hlY2tKd3QsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogRXh0ZW5kZWRSZXF1ZXN0LCByZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlcS5oZWFkZXJzWydhZG1pbi1jb2RlJ10gIT09IHNlcnZlckNvbmZpZ1snYWRtaW4tY29kZSddKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLnNlbmQoJ1lvdSBoYXZlIG5vdCBhdXRoZW50aWNhdGVkIHJlcXVlc3QgYXMgYW4gYWRtaW4nKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBNYW5hZ2VDb250cm9sbGVyKHJlcS5pbywgcmVxLmlvQ29ubmVjdGlvbnMpO1xyXG4gICAgICAgICAgICBjb250cm9sbGVyLnNlbmRNZXNzYWdlVG9BY3RpdmVVc2VycyhyZXEuYm9keS5tZXNzYWdlKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlcy5zZW5kKHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlcy5zdGF0dXMoNTAwKS5zZW5kKGVycikpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByb3V0ZXIuZ2V0KCcvdXNlci9hY3RpdmUnLCA8UmVxdWVzdEhhbmRsZXI+IEF1dGhIZWxwZXIuY2hlY2tKd3QsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogRXh0ZW5kZWRSZXF1ZXN0LCByZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlcS5oZWFkZXJzWydhZG1pbi1jb2RlJ10gIT09IHNlcnZlckNvbmZpZ1snYWRtaW4tY29kZSddKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLnNlbmQoJ1lvdSBoYXZlIG5vdCBhdXRoZW50aWNhdGVkIHJlcXVlc3QgYXMgYW4gYWRtaW4nKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBNYW5hZ2VDb250cm9sbGVyKHJlcS5pbywgcmVxLmlvQ29ubmVjdGlvbnMpO1xyXG4gICAgICAgICAgICBjb250cm9sbGVyLmdldEFjdGl2ZVVzZXJzKClcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXMuc2VuZChyZXN1bHRzKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZXMuc3RhdHVzKDUwMCkuc2VuZChlcnIpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJvdXRlcjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QWN0aXZlVXNlcnMoKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvbnMgPSBfLm1hcCh0aGlzLmlvQ29ubmVjdGlvbnMsIChjb25uZWN0aW9uOiBJT0Nvbm5lY3Rpb24pID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBuYW1lO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChjb25uZWN0aW9uLnByYWN0aXRpb25lciAmJiBjb25uZWN0aW9uLnByYWN0aXRpb25lci5uYW1lICYmIGNvbm5lY3Rpb24ucHJhY3RpdGlvbmVyLm5hbWUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWUgPSBjb25uZWN0aW9uLnByYWN0aXRpb25lci5uYW1lWzBdLmZhbWlseTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24ucHJhY3RpdGlvbmVyLm5hbWVbMF0uZ2l2ZW4gJiYgY29ubmVjdGlvbi5wcmFjdGl0aW9uZXIubmFtZVswXS5naXZlbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lICs9ICcsICc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgKz0gY29ubmVjdGlvbi5wcmFjdGl0aW9uZXIubmFtZVswXS5naXZlbi5qb2luKCcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc29ja2V0SWQ6IGNvbm5lY3Rpb24uaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkOiBjb25uZWN0aW9uLnVzZXJQcm9maWxlID8gY29ubmVjdGlvbi51c2VyUHJvZmlsZS51c2VyX2lkIDogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICBlbWFpbDogY29ubmVjdGlvbi51c2VyUHJvZmlsZSA/IGNvbm5lY3Rpb24udXNlclByb2ZpbGUuZW1haWwgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHByYWN0aXRpb25lclJlZmVyZW5jZTogY29ubmVjdGlvbi5wcmFjdGl0aW9uZXIgPyBgUHJhY3RpdGlvbmVyLyR7Y29ubmVjdGlvbi5wcmFjdGl0aW9uZXIuaWR9YCA6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXNvbHZlKGNvbm5lY3Rpb25zKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2VuZE1lc3NhZ2VUb0FjdGl2ZVVzZXJzKG1lc3NhZ2U6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaW8uZW1pdCgnbWVzc2FnZScsIG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0iXX0=
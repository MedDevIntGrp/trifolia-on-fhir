"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const AuthHelper = require("../authHelper");
const FhirHelper = require("../fhirHelper");
const rp = require("request-promise");
const _ = require("underscore");
const nanoid = require("nanoid");
const fhirLogic_1 = require("./fhirLogic");
class PractitionerController extends fhirLogic_1.FhirLogic {
    static initRoutes() {
        const router = express.Router();
        router.get('/me', AuthHelper.checkJwt, (req, res) => {
            const controller = new PractitionerController('Practitioner', req.fhirServerBase);
            controller.getMyPractitioner(req.user)
                .then((results) => res.send(results))
                .catch((err) => PractitionerController.handleError(err, null, res));
        });
        router.post('/me', AuthHelper.checkJwt, (req, res) => {
            const controller = new PractitionerController('Practitioner', req.fhirServerBase);
            controller.updateMyPractitioner(req.user, req.body)
                .then((results) => res.send(results))
                .catch((err) => PractitionerController.handleError(err, null, res));
        });
        return super.initRoutes('Practitioner', router);
    }
    updateMyPractitioner(userInfo, practitioner) {
        return new Promise((resolve, reject) => {
            this.getMyPractitioner(userInfo, true)
                .then((existingPractitioner) => {
                const authUser = userInfo.sub;
                let system = '';
                let value = authUser;
                if (authUser.startsWith('auth0|')) {
                    system = 'https://auth0.com';
                    value = authUser.substring(6);
                }
                if (!practitioner.identifier) {
                    practitioner.identifier = [];
                }
                const foundIdentifier = _.find(practitioner.identifier, (identifier) => {
                    return identifier.system === system && identifier.value === value;
                });
                if (!foundIdentifier) {
                    practitioner.identifier.push({
                        system: system,
                        value: value
                    });
                }
                if (existingPractitioner && existingPractitioner.id) {
                    practitioner.id = existingPractitioner.id;
                }
                else {
                    practitioner.id = nanoid(8);
                }
                const practitionerRequest = {
                    url: FhirHelper.buildUrl(this.baseUrl, this.resourceType, practitioner.id),
                    method: 'PUT',
                    body: practitioner,
                    json: true,
                    resolveWithFullResponse: true
                };
                return rp(practitionerRequest);
            })
                .then((results) => {
                const location = results.headers.location || results.headers['content-location'];
                if (!location) {
                    throw new Error(`FHIR server did not respond with a location to the newly created ${this.resourceType}`);
                }
                return rp({
                    url: location,
                    method: 'GET',
                    json: true
                });
            })
                .then((results) => resolve(results))
                .catch((err) => reject(err));
        });
    }
    getMyPractitioner(userInfo, resolveIfNotFound = false) {
        return new Promise((resolve, reject) => {
            let system = '';
            let identifier = userInfo.sub;
            if (identifier.startsWith('auth0|')) {
                system = 'https://auth0.com';
                identifier = identifier.substring(6);
            }
            const url = FhirHelper.buildUrl(this.baseUrl, this.resourceType, null, null, { identifier: system + '|' + identifier });
            const options = {
                url: url,
                json: true,
                headers: {
                    'Cache-Control': 'no-cache'
                }
            };
            rp(options)
                .then((bundle) => {
                if (bundle.total === 0) {
                    if (!resolveIfNotFound) {
                        return reject({
                            statusCode: 404,
                            message: 'No practitioner was found associated with the authenticated user'
                        });
                    }
                    else {
                        return resolve();
                    }
                }
                if (bundle.total > 1) {
                    PractitionerController.log.warn(`Expected a single ${this.resourceType} resource to be found with identifier ${system}|${identifier}`);
                }
                resolve(bundle.entry[0].resource);
            })
                .catch((err) => reject(err));
        });
    }
}
exports.PractitionerController = PractitionerController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJhY3RpdGlvbmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJhY3RpdGlvbmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDRDQUE0QztBQUM1Qyw0Q0FBNEM7QUFDNUMsc0NBQXNDO0FBQ3RDLGdDQUFnQztBQUNoQyxpQ0FBaUM7QUFDakMsMkNBQXNDO0FBSXRDLE1BQWEsc0JBQXVCLFNBQVEscUJBQVM7SUFDMUMsTUFBTSxDQUFDLFVBQVU7UUFDcEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRWhDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFtQixVQUFVLENBQUMsUUFBUSxFQUFFLENBQWtCLEdBQW9CLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDbkcsTUFBTSxVQUFVLEdBQUcsSUFBSSxzQkFBc0IsQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ2xGLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2lCQUNqQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ3BDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsc0JBQXNCLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM1RSxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFtQixVQUFVLENBQUMsUUFBUSxFQUFFLENBQWtCLEdBQW9CLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDcEcsTUFBTSxVQUFVLEdBQUcsSUFBSSxzQkFBc0IsQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ2xGLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFH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TUFBTSxDQUFDLEtBQUssS0FBSyxDQUFDLEVBQUU7b0JBQ3BCLElBQUksQ0FBQyxpQkFBaUIsRUFBRTt3QkFDcEIsT0FBTyxNQUFNLENBQWlCOzRCQUMxQixVQUFVLEVBQUUsR0FBRzs0QkFDZixPQUFPLEVBQUUsa0VBQWtFO3lCQUM5RSxDQUFDLENBQUM7cUJBQ047eUJBQU07d0JBQ0gsT0FBTyxPQUFPLEVBQUUsQ0FBQztxQkFDcEI7aUJBQ0o7Z0JBRUQsSUFBSSxNQUFNLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRTtvQkFDbEIsc0JBQXNCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsSUFBSSxDQUFDLFlBQVkseUNBQXlDLE1BQU0sSUFBSSxVQUFVLEVBQUUsQ0FBQyxDQUFBO2lCQUN6STtnQkFFRCxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QyxDQUFDLENBQUM7aUJBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQTVIRCx3REE0SEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgKiBhcyBBdXRoSGVscGVyIGZyb20gJy4uL2F1dGhIZWxwZXInO1xyXG5pbXBvcnQgKiBhcyBGaGlySGVscGVyIGZyb20gJy4uL2ZoaXJIZWxwZXInO1xyXG5pbXBvcnQgKiBhcyBycCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ3VuZGVyc2NvcmUnO1xyXG5pbXBvcnQgKiBhcyBuYW5vaWQgZnJvbSAnbmFub2lkJztcclxuaW1wb3J0IHtGaGlyTG9naWN9IGZyb20gJy4vZmhpckxvZ2ljJztcclxuaW1wb3J0IHtFeHRlbmRlZFJlcXVlc3QsIEZoaXIsIFJlc3RSZWplY3Rpb24sIFVzZXJJbmZvfSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCB7UmVxdWVzdEhhbmRsZXJ9IGZyb20gJ2V4cHJlc3MnO1xyXG5cclxuZXhwb3J0IGNsYXNzIFByYWN0aXRpb25lckNvbnRyb2xsZXIgZXh0ZW5kcyBGaGlyTG9naWMge1xyXG4gICAgcHVibGljIHN0YXRpYyBpbml0Um91dGVzKCkge1xyXG4gICAgICAgIGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcblxyXG4gICAgICAgIHJvdXRlci5nZXQoJy9tZScsIDxSZXF1ZXN0SGFuZGxlcj4gQXV0aEhlbHBlci5jaGVja0p3dCwgPFJlcXVlc3RIYW5kbGVyPiAocmVxOiBFeHRlbmRlZFJlcXVlc3QsIHJlcykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IFByYWN0aXRpb25lckNvbnRyb2xsZXIoJ1ByYWN0aXRpb25lcicsIHJlcS5maGlyU2VydmVyQmFzZSk7XHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZ2V0TXlQcmFjdGl0aW9uZXIocmVxLnVzZXIpXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4gcmVzLnNlbmQocmVzdWx0cykpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gUHJhY3RpdGlvbmVyQ29udHJvbGxlci5oYW5kbGVFcnJvcihlcnIsIG51bGwsIHJlcykpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByb3V0ZXIucG9zdCgnL21lJywgPFJlcXVlc3RIYW5kbGVyPiBBdXRoSGVscGVyLmNoZWNrSnd0LCA8UmVxdWVzdEhhbmRsZXI+IChyZXE6IEV4dGVuZGVkUmVxdWVzdCwgcmVzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgUHJhY3RpdGlvbmVyQ29udHJvbGxlcignUHJhY3RpdGlvbmVyJywgcmVxLmZoaXJTZXJ2ZXJCYXNlKTtcclxuICAgICAgICAgICAgY29udHJvbGxlci51cGRhdGVNeVByYWN0aXRpb25lcihyZXEudXNlciwgPEZoaXIuUHJhY3RpdGlvbmVyPiByZXEuYm9keSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXMuc2VuZChyZXN1bHRzKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBQcmFjdGl0aW9uZXJDb250cm9sbGVyLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBzdXBlci5pbml0Um91dGVzKCdQcmFjdGl0aW9uZXInLCByb3V0ZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cGRhdGVNeVByYWN0aXRpb25lcih1c2VySW5mbzogVXNlckluZm8sIHByYWN0aXRpb25lcjogRmhpci5QcmFjdGl0aW9uZXIpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TXlQcmFjdGl0aW9uZXIodXNlckluZm8sIHRydWUpXHJcbiAgICAgICAgICAgICAgICAudGhlbigoZXhpc3RpbmdQcmFjdGl0aW9uZXIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhdXRoVXNlciA9IHVzZXJJbmZvLnN1YjtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3lzdGVtID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gYXV0aFVzZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhdXRoVXNlci5zdGFydHNXaXRoKCdhdXRoMHwnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzeXN0ZW0gPSAgJ2h0dHBzOi8vYXV0aDAuY29tJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhdXRoVXNlci5zdWJzdHJpbmcoNik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXByYWN0aXRpb25lci5pZGVudGlmaWVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByYWN0aXRpb25lci5pZGVudGlmaWVyID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3VuZElkZW50aWZpZXIgPSBfLmZpbmQocHJhY3RpdGlvbmVyLmlkZW50aWZpZXIsIChpZGVudGlmaWVyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpZGVudGlmaWVyLnN5c3RlbSA9PT0gc3lzdGVtICYmIGlkZW50aWZpZXIudmFsdWUgPT09IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWZvdW5kSWRlbnRpZmllcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmFjdGl0aW9uZXIuaWRlbnRpZmllci5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN5c3RlbTogc3lzdGVtLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUHJhY3RpdGlvbmVyICYmIGV4aXN0aW5nUHJhY3RpdGlvbmVyLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByYWN0aXRpb25lci5pZCA9IGV4aXN0aW5nUHJhY3RpdGlvbmVyLmlkO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByYWN0aXRpb25lci5pZCA9IG5hbm9pZCg4KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHByYWN0aXRpb25lclJlcXVlc3QgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogRmhpckhlbHBlci5idWlsZFVybCh0aGlzLmJhc2VVcmwsIHRoaXMucmVzb3VyY2VUeXBlLCBwcmFjdGl0aW9uZXIuaWQpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdQVVQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBib2R5OiBwcmFjdGl0aW9uZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGpzb246IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJwKHByYWN0aXRpb25lclJlcXVlc3QpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb24gPSByZXN1bHRzLmhlYWRlcnMubG9jYXRpb24gfHwgcmVzdWx0cy5oZWFkZXJzWydjb250ZW50LWxvY2F0aW9uJ107XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghbG9jYXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGSElSIHNlcnZlciBkaWQgbm90IHJlc3BvbmQgd2l0aCBhIGxvY2F0aW9uIHRvIHRoZSBuZXdseSBjcmVhdGVkICR7dGhpcy5yZXNvdXJjZVR5cGV9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcnAoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGxvY2F0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBqc29uOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlc29sdmUocmVzdWx0cykpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRNeVByYWN0aXRpb25lcih1c2VySW5mbzogVXNlckluZm8sIHJlc29sdmVJZk5vdEZvdW5kID0gZmFsc2UpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBzeXN0ZW0gPSAnJztcclxuICAgICAgICAgICAgbGV0IGlkZW50aWZpZXIgPSB1c2VySW5mby5zdWI7XHJcblxyXG4gICAgICAgICAgICBpZiAoaWRlbnRpZmllci5zdGFydHNXaXRoKCdhdXRoMHwnKSkge1xyXG4gICAgICAgICAgICAgICAgc3lzdGVtID0gICdodHRwczovL2F1dGgwLmNvbSc7XHJcbiAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gaWRlbnRpZmllci5zdWJzdHJpbmcoNik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHVybCA9IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5iYXNlVXJsLCB0aGlzLnJlc291cmNlVHlwZSwgbnVsbCwgbnVsbCwgeyBpZGVudGlmaWVyOiBzeXN0ZW0gKyAnfCcgKyBpZGVudGlmaWVyIH0pO1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgdXJsOiB1cmwsXHJcbiAgICAgICAgICAgICAgICBqc29uOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAgICAgICAgICdDYWNoZS1Db250cm9sJzogJ25vLWNhY2hlJ1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgcnAob3B0aW9ucylcclxuICAgICAgICAgICAgICAgIC50aGVuKChidW5kbGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVuZGxlLnRvdGFsID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzb2x2ZUlmTm90Rm91bmQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoPFJlc3RSZWplY3Rpb24+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNDb2RlOiA0MDQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ05vIHByYWN0aXRpb25lciB3YXMgZm91bmQgYXNzb2NpYXRlZCB3aXRoIHRoZSBhdXRoZW50aWNhdGVkIHVzZXInXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChidW5kbGUudG90YWwgPiAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFByYWN0aXRpb25lckNvbnRyb2xsZXIubG9nLndhcm4oYEV4cGVjdGVkIGEgc2luZ2xlICR7dGhpcy5yZXNvdXJjZVR5cGV9IHJlc291cmNlIHRvIGJlIGZvdW5kIHdpdGggaWRlbnRpZmllciAke3N5c3RlbX18JHtpZGVudGlmaWVyfWApXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGJ1bmRsZS5lbnRyeVswXS5yZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG4iXX0=
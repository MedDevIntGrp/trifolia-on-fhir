"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const AuthHelper = require("../authHelper");
const FhirHelper = require("../fhirHelper");
const rp = require("request-promise");
const _ = require("underscore");
const nanoid = require("nanoid");
const fhirLogic_1 = require("./fhirLogic");
class PractitionerController extends fhirLogic_1.FhirLogic {
    static initRoutes() {
        const router = express.Router();
        router.get('/me', AuthHelper.checkJwt, (req, res) => {
            const controller = new PractitionerController('Practitioner', req.fhirServerBase);
            controller.getMyPractitioner(req.user)
                .then((results) => res.send(results))
                .catch((err) => PractitionerController.handleError(err, null, res));
        });
        router.post('/me', AuthHelper.checkJwt, (req, res) => {
            const controller = new PractitionerController('Practitioner', req.fhirServerBase);
            controller.updateMyPractitioner(req.user, req.body)
                .then((results) => res.send(results))
                .catch((err) => PractitionerController.handleError(err, null, res));
        });
        return super.initRoutes('Practitioner', router);
    }
    updateMyPractitioner(userInfo, practitioner) {
        return new Promise((resolve, reject) => {
            this.getMyPractitioner(userInfo, true)
                .then((existingPractitioner) => {
                const authUser = userInfo.sub;
                let system = '';
                let value = authUser;
                if (authUser.startsWith('auth0|')) {
                    system = 'https://auth0.com';
                    value = authUser.substring(6);
                }
                if (!practitioner.identifier) {
                    practitioner.identifier = [];
                }
                const foundIdentifier = _.find(practitioner.identifier, (identifier) => {
                    return identifier.system === system && identifier.value === value;
                });
                if (!foundIdentifier) {
                    practitioner.identifier.push({
                        system: system,
                        value: value
                    });
                }
                if (existingPractitioner && existingPractitioner.id) {
                    practitioner.id = existingPractitioner.id;
                }
                else {
                    practitioner.id = nanoid(8);
                }
                const practitionerRequest = {
                    url: FhirHelper.buildUrl(this.baseUrl, this.resourceType, practitioner.id),
                    method: 'PUT',
                    body: practitioner,
                    json: true,
                    resolveWithFullResponse: true
                };
                return rp(practitionerRequest);
            })
                .then((results) => {
                const location = results.headers.location || results.headers['content-location'];
                if (!location) {
                    throw new Error(`FHIR server did not respond with a location to the newly created ${this.resourceType}`);
                }
                return rp({
                    url: location,
                    method: 'GET',
                    json: true
                });
            })
                .then((results) => resolve(results))
                .catch((err) => reject(err));
        });
    }
    getMyPractitioner(userInfo, resolveIfNotFound = false) {
        return new Promise((resolve, reject) => {
            let system = '';
            let identifier = userInfo.sub;
            if (identifier.startsWith('auth0|')) {
                system = 'https://auth0.com';
                identifier = identifier.substring(6);
            }
            const url = FhirHelper.buildUrl(this.baseUrl, this.resourceType, null, null, { identifier: system + '|' + identifier });
            const options = {
                url: url,
                json: true,
                headers: {
                    'Cache-Control': 'no-cache'
                }
            };
            rp(options)
                .then((bundle) => {
                if (bundle.total === 0) {
                    if (!resolveIfNotFound) {
                        return reject({
                            statusCode: 404,
                            message: 'No practitioner was found associated with the authenticated user'
                        });
                    }
                    else {
                        return resolve();
                    }
                }
                if (bundle.total > 1) {
                    PractitionerController.log.warn(`Expected a single ${this.resourceType} resource to be found with identifier ${system}|${identifier}`);
                }
                resolve(bundle.entry[0].resource);
            })
                .catch((err) => reject(err));
        });
    }
}
exports.PractitionerController = PractitionerController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJhY3RpdGlvbmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJhY3RpdGlvbmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDRDQUE0QztBQUM1Qyw0Q0FBNEM7QUFDNUMsc0NBQXNDO0FBQ3RDLGdDQUFnQztBQUNoQyxpQ0FBaUM7QUFDakMsMkNBQXNDO0FBSXRDLDRCQUFvQyxTQUFRLHFCQUFTO0lBQzFDLE1BQU0sQ0FBQyxVQUFVO1FBQ3BCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUVoQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBbUIsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFrQixHQUFvQixFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ25HLE1BQU0sVUFBVSxHQUFHLElBQUksc0JBQXNCLENBQUMsY0FBYyxFQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUNsRixVQUFVLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztpQkFDakMsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUNwQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDNUUsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBbUIsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFrQixHQUFvQixFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ3BHLE1BQU0sVUFBVSxHQUFHLElBQUksc0JBQXNCLENBQUMsY0FBYyxFQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUNsRixVQUFVLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFD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Q0FBQyxLQUFLLEtBQUssQ0FBQyxFQUFFO29CQUNwQixJQUFJLENBQUMsaUJBQWlCLEVBQUU7d0JBQ3BCLE9BQU8sTUFBTSxDQUFpQjs0QkFDMUIsVUFBVSxFQUFFLEdBQUc7NEJBQ2YsT0FBTyxFQUFFLGtFQUFrRTt5QkFDOUUsQ0FBQyxDQUFDO3FCQUNOO3lCQUFNO3dCQUNILE9BQU8sT0FBTyxFQUFFLENBQUM7cUJBQ3BCO2lCQUNKO2dCQUVELElBQUksTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUU7b0JBQ2xCLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLElBQUksQ0FBQyxZQUFZLHlDQUF5QyxNQUFNLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQTtpQkFDekk7Z0JBRUQsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEMsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDckMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUE1SEQsd0RBNEhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0ICogYXMgQXV0aEhlbHBlciBmcm9tICcuLi9hdXRoSGVscGVyJztcclxuaW1wb3J0ICogYXMgRmhpckhlbHBlciBmcm9tICcuLi9maGlySGVscGVyJztcclxuaW1wb3J0ICogYXMgcnAgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcclxuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJztcclxuaW1wb3J0ICogYXMgbmFub2lkIGZyb20gJ25hbm9pZCc7XHJcbmltcG9ydCB7RmhpckxvZ2ljfSBmcm9tICcuL2ZoaXJMb2dpYyc7XHJcbmltcG9ydCB7RXh0ZW5kZWRSZXF1ZXN0LCBGaGlyLCBSZXN0UmVqZWN0aW9uLCBVc2VySW5mb30gZnJvbSAnLi9tb2RlbHMnO1xyXG5pbXBvcnQge1JlcXVlc3RIYW5kbGVyfSBmcm9tICdleHByZXNzJztcclxuXHJcbmV4cG9ydCBjbGFzcyBQcmFjdGl0aW9uZXJDb250cm9sbGVyIGV4dGVuZHMgRmhpckxvZ2ljIHtcclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdFJvdXRlcygpIHtcclxuICAgICAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG5cclxuICAgICAgICByb3V0ZXIuZ2V0KCcvbWUnLCA8UmVxdWVzdEhhbmRsZXI+IEF1dGhIZWxwZXIuY2hlY2tKd3QsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogRXh0ZW5kZWRSZXF1ZXN0LCByZXMpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBQcmFjdGl0aW9uZXJDb250cm9sbGVyKCdQcmFjdGl0aW9uZXInLCByZXEuZmhpclNlcnZlckJhc2UpO1xyXG4gICAgICAgICAgICBjb250cm9sbGVyLmdldE15UHJhY3RpdGlvbmVyKHJlcS51c2VyKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlcy5zZW5kKHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IFByYWN0aXRpb25lckNvbnRyb2xsZXIuaGFuZGxlRXJyb3IoZXJyLCBudWxsLCByZXMpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcm91dGVyLnBvc3QoJy9tZScsIDxSZXF1ZXN0SGFuZGxlcj4gQXV0aEhlbHBlci5jaGVja0p3dCwgPFJlcXVlc3RIYW5kbGVyPiAocmVxOiBFeHRlbmRlZFJlcXVlc3QsIHJlcykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IFByYWN0aXRpb25lckNvbnRyb2xsZXIoJ1ByYWN0aXRpb25lcicsIHJlcS5maGlyU2VydmVyQmFzZSk7XHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXIudXBkYXRlTXlQcmFjdGl0aW9uZXIocmVxLnVzZXIsIDxGaGlyLlByYWN0aXRpb25lcj4gcmVxLmJvZHkpXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4gcmVzLnNlbmQocmVzdWx0cykpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gUHJhY3RpdGlvbmVyQ29udHJvbGxlci5oYW5kbGVFcnJvcihlcnIsIG51bGwsIHJlcykpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gc3VwZXIuaW5pdFJvdXRlcygnUHJhY3RpdGlvbmVyJywgcm91dGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdXBkYXRlTXlQcmFjdGl0aW9uZXIodXNlckluZm86IFVzZXJJbmZvLCBwcmFjdGl0aW9uZXI6IEZoaXIuUHJhY3RpdGlvbmVyKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmdldE15UHJhY3RpdGlvbmVyKHVzZXJJbmZvLCB0cnVlKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKGV4aXN0aW5nUHJhY3RpdGlvbmVyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXV0aFVzZXIgPSB1c2VySW5mby5zdWI7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN5c3RlbSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IGF1dGhVc2VyO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aFVzZXIuc3RhcnRzV2l0aCgnYXV0aDB8JykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3lzdGVtID0gICdodHRwczovL2F1dGgwLmNvbSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYXV0aFVzZXIuc3Vic3RyaW5nKDYpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwcmFjdGl0aW9uZXIuaWRlbnRpZmllcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmFjdGl0aW9uZXIuaWRlbnRpZmllciA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm91bmRJZGVudGlmaWVyID0gXy5maW5kKHByYWN0aXRpb25lci5pZGVudGlmaWVyLCAoaWRlbnRpZmllcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWRlbnRpZmllci5zeXN0ZW0gPT09IHN5c3RlbSAmJiBpZGVudGlmaWVyLnZhbHVlID09PSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmb3VuZElkZW50aWZpZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJhY3RpdGlvbmVyLmlkZW50aWZpZXIucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzeXN0ZW06IHN5c3RlbSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1ByYWN0aXRpb25lciAmJiBleGlzdGluZ1ByYWN0aXRpb25lci5pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmFjdGl0aW9uZXIuaWQgPSBleGlzdGluZ1ByYWN0aXRpb25lci5pZDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmFjdGl0aW9uZXIuaWQgPSBuYW5vaWQoOCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmFjdGl0aW9uZXJSZXF1ZXN0ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5iYXNlVXJsLCB0aGlzLnJlc291cmNlVHlwZSwgcHJhY3RpdGlvbmVyLmlkKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnUFVUJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogcHJhY3RpdGlvbmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBqc29uOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBycChwcmFjdGl0aW9uZXJSZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0aW9uID0gcmVzdWx0cy5oZWFkZXJzLmxvY2F0aW9uIHx8IHJlc3VsdHMuaGVhZGVyc1snY29udGVudC1sb2NhdGlvbiddO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWxvY2F0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRkhJUiBzZXJ2ZXIgZGlkIG5vdCByZXNwb25kIHdpdGggYSBsb2NhdGlvbiB0byB0aGUgbmV3bHkgY3JlYXRlZCAke3RoaXMucmVzb3VyY2VUeXBlfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJwKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBsb2NhdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXNvbHZlKHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0TXlQcmFjdGl0aW9uZXIodXNlckluZm86IFVzZXJJbmZvLCByZXNvbHZlSWZOb3RGb3VuZCA9IGZhbHNlKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgc3lzdGVtID0gJyc7XHJcbiAgICAgICAgICAgIGxldCBpZGVudGlmaWVyID0gdXNlckluZm8uc3ViO1xyXG5cclxuICAgICAgICAgICAgaWYgKGlkZW50aWZpZXIuc3RhcnRzV2l0aCgnYXV0aDB8JykpIHtcclxuICAgICAgICAgICAgICAgIHN5c3RlbSA9ICAnaHR0cHM6Ly9hdXRoMC5jb20nO1xyXG4gICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IGlkZW50aWZpZXIuc3Vic3RyaW5nKDYpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuYmFzZVVybCwgdGhpcy5yZXNvdXJjZVR5cGUsIG51bGwsIG51bGwsIHsgaWRlbnRpZmllcjogc3lzdGVtICsgJ3wnICsgaWRlbnRpZmllciB9KTtcclxuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgIHVybDogdXJsLFxyXG4gICAgICAgICAgICAgICAganNvbjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1jYWNoZSdcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHJwKG9wdGlvbnMpXHJcbiAgICAgICAgICAgICAgICAudGhlbigoYnVuZGxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1bmRsZS50b3RhbCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc29sdmVJZk5vdEZvdW5kKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KDxSZXN0UmVqZWN0aW9uPiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogNDA0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdObyBwcmFjdGl0aW9uZXIgd2FzIGZvdW5kIGFzc29jaWF0ZWQgd2l0aCB0aGUgYXV0aGVudGljYXRlZCB1c2VyJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVuZGxlLnRvdGFsID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBQcmFjdGl0aW9uZXJDb250cm9sbGVyLmxvZy53YXJuKGBFeHBlY3RlZCBhIHNpbmdsZSAke3RoaXMucmVzb3VyY2VUeXBlfSByZXNvdXJjZSB0byBiZSBmb3VuZCB3aXRoIGlkZW50aWZpZXIgJHtzeXN0ZW19fCR7aWRlbnRpZmllcn1gKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShidW5kbGUuZW50cnlbMF0ucmVzb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuIl19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const controller_1 = require("./controller");
const express = require("express");
const authHelper_1 = require("../authHelper");
const request = require("request");
const rp = require("request-promise");
const FhirHelper = require("../fhirHelper");
class FhirAPIController extends controller_1.BaseController {
    constructor(baseUrl) {
        super();
        this.baseUrl = baseUrl;
    }
    static initRoutes() {
        const router = express.Router();
        router.post('/:resourceType/:id/([\$])change-id', authHelper_1.checkJwt, (req, res) => {
            const controller = new FhirAPIController(req.fhirServerBase);
            controller.changeId(req.params.resourceType, req.params.id, req.query.newId)
                .then((results) => res.send(results))
                .catch((err) => res.status(500).send(err));
        });
        router.use(authHelper_1.checkJwt, (req, res) => {
            const controller = new FhirAPIController(req.fhirServerBase);
            controller.proxy(req.method, req.url, req.headers, req.query, req.body)
                .then((results) => {
                if (results.contentType) {
                    res.contentType(results.contentType);
                }
                res.status(results.status).send(results.body);
            })
                .catch((err) => res.status(500).send(err));
        });
        return router;
    }
    proxy(method, url, headers, query, body) {
        let proxyUrl = this.baseUrl;
        if (proxyUrl.endsWith('/')) {
            proxyUrl = proxyUrl.substring(0, proxyUrl.length - 1);
        }
        proxyUrl += url;
        const proxyHeaders = JSON.parse(JSON.stringify(headers));
        delete proxyHeaders['authorization'];
        delete proxyHeaders['fhirserver'];
        delete proxyHeaders['host'];
        delete proxyHeaders['origin'];
        delete proxyHeaders['referer'];
        delete proxyHeaders['user-agent'];
        delete proxyHeaders['content-length'];
        delete proxyHeaders['cookie'];
        delete proxyHeaders['connection'];
        proxyHeaders['Cache-Control'] = 'no-cache';
        const options = {
            url: proxyUrl,
            method: method,
            headers: proxyHeaders,
            body: undefined,
            encoding: 'utf8',
            gzip: false
        };
        if (method !== 'GET' && method !== 'DELETE') {
            options.body = body;
        }
        if (proxyHeaders['accept-encoding'] && proxyHeaders['accept-encoding'].indexOf('gzip') >= 0) {
            options.gzip = true;
        }
        return new Promise((resolve, reject) => {
            request(options, (err, response, body) => {
                resolve({
                    status: response.statusCode,
                    body: body,
                    contentType: response.headers ? response.headers['content-type'] : undefined
                });
            });
        });
    }
    changeId(resourceType, currentId, newId) {
        return new Promise((resolve, reject) => {
            if (!newId) {
                return reject({ statusCode: 400, message: 'You must specify a "newId" to change the id of the resource' });
            }
            const currentOptions = {
                url: FhirHelper.buildUrl(this.baseUrl, resourceType, currentId),
                method: 'GET',
                json: true
            };
            FhirAPIController.log.trace(`Request to change id for resource ${resourceType}/${currentId} to ${newId}`);
            // Get the current state of the resource
            rp(currentOptions)
                .then((resource) => {
                if (!resource || !resource.id) {
                    throw new Error(`No resource found for ${resourceType} with id ${currentId}`);
                }
                // Change the id of the resource
                resource.id = newId;
                const createOptions = {
                    url: FhirHelper.buildUrl(this.baseUrl, resourceType, newId),
                    method: 'PUT',
                    json: true,
                    body: resource
                };
                FhirAPIController.log.trace('Sending PUT request to FHIR server with the new resource ID');
                // Create the new resource with the new id
                return rp(createOptions);
            })
                .then(() => {
                const deleteOptions = {
                    url: FhirHelper.buildUrl(this.baseUrl, resourceType, currentId),
                    method: 'DELETE',
                    json: true
                };
                FhirAPIController.log.trace('Sending DELETE request to FHIR server for original resource');
                // Delete the original resource with the original id
                return rp(deleteOptions);
            })
                .then(() => {
                FhirAPIController.log.trace(`Successfully changed the id of ${resourceType}/${currentId} to ${resourceType}/${newId}`);
                resolve(`Successfully changed the id of ${resourceType}/${currentId} to ${resourceType}/${newId}`);
            })
                .catch((err) => reject(err));
        });
    }
}
exports.FhirAPIController = FhirAPIController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmhpckFQSS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZoaXJBUEkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBNEM7QUFDNUMsbUNBQW1DO0FBRW5DLDhDQUF1QztBQUV2QyxtQ0FBbUM7QUFDbkMsc0NBQXNDO0FBQ3RDLDRDQUE0QztBQWtCNUMsTUFBYSxpQkFBa0IsU0FBUSwyQkFBYztJQUlqRCxZQUFZLE9BQU87UUFDZixLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFFTSxNQUFNLENBQUMsVUFBVTtRQUNwQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsRUFBbUIscUJBQVEsRUFBRSxDQUFDLEdBQW9CLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDdkcsTUFBTSxVQUFVLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDN0QsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztpQkFDdkUsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUNwQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsR0FBRyxDQUFrQixxQkFBUSxFQUFFLENBQWtCLEdBQW9CLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDakYsTUFBTSxV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Q0FBQztJQUNQLENBQUM7Q0FDSjtBQTVJRCw4Q0E0SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Jhc2VDb250cm9sbGVyfSBmcm9tICcuL2NvbnRyb2xsZXInO1xyXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQge1JlcXVlc3RIYW5kbGVyfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHtjaGVja0p3dH0gZnJvbSAnLi4vYXV0aEhlbHBlcic7XHJcbmltcG9ydCB7RXh0ZW5kZWRSZXF1ZXN0LCBSZXN0UmVqZWN0aW9ufSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCAqIGFzIHJlcXVlc3QgZnJvbSAncmVxdWVzdCc7XHJcbmltcG9ydCAqIGFzIHJwIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XHJcbmltcG9ydCAqIGFzIEZoaXJIZWxwZXIgZnJvbSAnLi4vZmhpckhlbHBlcic7XHJcblxyXG5pbnRlcmZhY2UgUHJveHlSZXNwb25zZSB7XHJcbiAgICBzdGF0dXM6IG51bWJlcjtcclxuICAgIGJvZHk6IGFueTtcclxuICAgIGNvbnRlbnRUeXBlPzogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgQ2hhbmdlSWRSZXF1ZXN0IGV4dGVuZHMgRXh0ZW5kZWRSZXF1ZXN0IHtcclxuICAgIHBhcmFtczoge1xyXG4gICAgICAgIHJlc291cmNlVHlwZTogc3RyaW5nO1xyXG4gICAgICAgIGlkOiBzdHJpbmc7XHJcbiAgICB9O1xyXG4gICAgcXVlcnk6IHtcclxuICAgICAgICBuZXdJZDogc3RyaW5nO1xyXG4gICAgfTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEZoaXJBUElDb250cm9sbGVyIGV4dGVuZHMgQmFzZUNvbnRyb2xsZXIge1xyXG5cclxuICAgIHByaXZhdGUgYmFzZVVybDogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGJhc2VVcmwpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBpbml0Um91dGVzKCkge1xyXG4gICAgICAgIGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcblxyXG4gICAgICAgIHJvdXRlci5wb3N0KCcvOnJlc291cmNlVHlwZS86aWQvKFtcXCRdKWNoYW5nZS1pZCcsIDxSZXF1ZXN0SGFuZGxlcj4gY2hlY2tKd3QsIChyZXE6IENoYW5nZUlkUmVxdWVzdCwgcmVzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgRmhpckFQSUNvbnRyb2xsZXIocmVxLmZoaXJTZXJ2ZXJCYXNlKTtcclxuICAgICAgICAgICAgY29udHJvbGxlci5jaGFuZ2VJZChyZXEucGFyYW1zLnJlc291cmNlVHlwZSwgcmVxLnBhcmFtcy5pZCwgcmVxLnF1ZXJ5Lm5ld0lkKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlcy5zZW5kKHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlcy5zdGF0dXMoNTAwKS5zZW5kKGVycikpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByb3V0ZXIudXNlKDxSZXF1ZXN0SGFuZGxlcj4gY2hlY2tKd3QsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogRXh0ZW5kZWRSZXF1ZXN0LCByZXMpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBGaGlyQVBJQ29udHJvbGxlcihyZXEuZmhpclNlcnZlckJhc2UpO1xyXG4gICAgICAgICAgICBjb250cm9sbGVyLnByb3h5KHJlcS5tZXRob2QsIHJlcS51cmwsIHJlcS5oZWFkZXJzLCByZXEucXVlcnksIHJlcS5ib2R5KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHM6IFByb3h5UmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5jb250ZW50VHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXMuY29udGVudFR5cGUocmVzdWx0cy5jb250ZW50VHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXMuc3RhdHVzKHJlc3VsdHMuc3RhdHVzKS5zZW5kKHJlc3VsdHMuYm9keSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlcy5zdGF0dXMoNTAwKS5zZW5kKGVycikpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcm91dGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBwcm94eShtZXRob2Q6IHN0cmluZywgdXJsOiBzdHJpbmcsIGhlYWRlcnM6IGFueSwgcXVlcnk6IGFueSwgYm9keTogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICBsZXQgcHJveHlVcmwgPSB0aGlzLmJhc2VVcmw7XHJcblxyXG4gICAgICAgIGlmIChwcm94eVVybC5lbmRzV2l0aCgnLycpKSB7XHJcbiAgICAgICAgICAgIHByb3h5VXJsID0gcHJveHlVcmwuc3Vic3RyaW5nKDAsIHByb3h5VXJsLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJveHlVcmwgKz0gdXJsO1xyXG5cclxuICAgICAgICBjb25zdCBwcm94eUhlYWRlcnMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGhlYWRlcnMpKTtcclxuICAgICAgICBkZWxldGUgcHJveHlIZWFkZXJzWydhdXRob3JpemF0aW9uJ107XHJcbiAgICAgICAgZGVsZXRlIHByb3h5SGVhZGVyc1snZmhpcnNlcnZlciddO1xyXG4gICAgICAgIGRlbGV0ZSBwcm94eUhlYWRlcnNbJ2hvc3QnXTtcclxuICAgICAgICBkZWxldGUgcHJveHlIZWFkZXJzWydvcmlnaW4nXTtcclxuICAgICAgICBkZWxldGUgcHJveHlIZWFkZXJzWydyZWZlcmVyJ107XHJcbiAgICAgICAgZGVsZXRlIHByb3h5SGVhZGVyc1sndXNlci1hZ2VudCddO1xyXG4gICAgICAgIGRlbGV0ZSBwcm94eUhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ107XHJcbiAgICAgICAgZGVsZXRlIHByb3h5SGVhZGVyc1snY29va2llJ107XHJcbiAgICAgICAgZGVsZXRlIHByb3h5SGVhZGVyc1snY29ubmVjdGlvbiddO1xyXG5cclxuICAgICAgICBwcm94eUhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXSA9ICduby1jYWNoZSc7XHJcblxyXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIHVybDogcHJveHlVcmwsXHJcbiAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiBwcm94eUhlYWRlcnMsXHJcbiAgICAgICAgICAgIGJvZHk6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgZW5jb2Rpbmc6ICd1dGY4JyxcclxuICAgICAgICAgICAgZ3ppcDogZmFsc2VcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAobWV0aG9kICE9PSAnR0VUJyAmJiBtZXRob2QgIT09ICdERUxFVEUnKSB7XHJcbiAgICAgICAgICAgIG9wdGlvbnMuYm9keSA9IGJvZHk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocHJveHlIZWFkZXJzWydhY2NlcHQtZW5jb2RpbmcnXSAmJiBwcm94eUhlYWRlcnNbJ2FjY2VwdC1lbmNvZGluZyddLmluZGV4T2YoJ2d6aXAnKSA+PSAwKSB7XHJcbiAgICAgICAgICAgIG9wdGlvbnMuZ3ppcCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8UHJveHlSZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICByZXF1ZXN0KG9wdGlvbnMsIChlcnIsIHJlc3BvbnNlLCBib2R5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHJlc3BvbnNlLnN0YXR1c0NvZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgYm9keTogYm9keSxcclxuICAgICAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogcmVzcG9uc2UuaGVhZGVycyA/IHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddIDogdW5kZWZpbmVkXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNoYW5nZUlkKHJlc291cmNlVHlwZTogc3RyaW5nLCBjdXJyZW50SWQ6IHN0cmluZywgbmV3SWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFuZXdJZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdCg8UmVzdFJlamVjdGlvbj4geyBzdGF0dXNDb2RlOiA0MDAsIG1lc3NhZ2U6ICdZb3UgbXVzdCBzcGVjaWZ5IGEgXCJuZXdJZFwiIHRvIGNoYW5nZSB0aGUgaWQgb2YgdGhlIHJlc291cmNlJyB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgY3VycmVudE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICB1cmw6IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5iYXNlVXJsLCByZXNvdXJjZVR5cGUsIGN1cnJlbnRJZCksXHJcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxyXG4gICAgICAgICAgICAgICAganNvbjogdHJ1ZVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgRmhpckFQSUNvbnRyb2xsZXIubG9nLnRyYWNlKGBSZXF1ZXN0IHRvIGNoYW5nZSBpZCBmb3IgcmVzb3VyY2UgJHtyZXNvdXJjZVR5cGV9LyR7Y3VycmVudElkfSB0byAke25ld0lkfWApO1xyXG5cclxuICAgICAgICAgICAgLy8gR2V0IHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSByZXNvdXJjZVxyXG4gICAgICAgICAgICBycChjdXJyZW50T3B0aW9ucylcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNvdXJjZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVzb3VyY2UgfHwgIXJlc291cmNlLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gcmVzb3VyY2UgZm91bmQgZm9yICR7cmVzb3VyY2VUeXBlfSB3aXRoIGlkICR7Y3VycmVudElkfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2hhbmdlIHRoZSBpZCBvZiB0aGUgcmVzb3VyY2VcclxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZS5pZCA9IG5ld0lkO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVhdGVPcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5iYXNlVXJsLCByZXNvdXJjZVR5cGUsIG5ld0lkKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnUFVUJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogcmVzb3VyY2VcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBGaGlyQVBJQ29udHJvbGxlci5sb2cudHJhY2UoJ1NlbmRpbmcgUFVUIHJlcXVlc3QgdG8gRkhJUiBzZXJ2ZXIgd2l0aCB0aGUgbmV3IHJlc291cmNlIElEJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgbmV3IHJlc291cmNlIHdpdGggdGhlIG5ldyBpZFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBycChjcmVhdGVPcHRpb25zKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVsZXRlT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuYmFzZVVybCwgcmVzb3VyY2VUeXBlLCBjdXJyZW50SWQpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdERUxFVEUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBqc29uOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgRmhpckFQSUNvbnRyb2xsZXIubG9nLnRyYWNlKCdTZW5kaW5nIERFTEVURSByZXF1ZXN0IHRvIEZISVIgc2VydmVyIGZvciBvcmlnaW5hbCByZXNvdXJjZScpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBEZWxldGUgdGhlIG9yaWdpbmFsIHJlc291cmNlIHdpdGggdGhlIG9yaWdpbmFsIGlkXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJwKGRlbGV0ZU9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBGaGlyQVBJQ29udHJvbGxlci5sb2cudHJhY2UoYFN1Y2Nlc3NmdWxseSBjaGFuZ2VkIHRoZSBpZCBvZiAke3Jlc291cmNlVHlwZX0vJHtjdXJyZW50SWR9IHRvICR7cmVzb3VyY2VUeXBlfS8ke25ld0lkfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYFN1Y2Nlc3NmdWxseSBjaGFuZ2VkIHRoZSBpZCBvZiAke3Jlc291cmNlVHlwZX0vJHtjdXJyZW50SWR9IHRvICR7cmVzb3VyY2VUeXBlfS8ke25ld0lkfWApO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0iXX0=
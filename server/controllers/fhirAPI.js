"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const controller_1 = require("./controller");
const express = require("express");
const authHelper_1 = require("../authHelper");
const request = require("request");
const rp = require("request-promise");
const FhirHelper = require("../fhirHelper");
/**
 * This controller is responsible for acting as a proxy to the underlying FHIR server's API.
 * It enforces additional logic (potentially), such as authentication, auditing, and custom operations.
 */
class FhirAPIController extends controller_1.BaseController {
    constructor(baseUrl) {
        super();
        this.baseUrl = baseUrl;
    }
    static initRoutes() {
        const router = express.Router();
        router.post('/:resourceType/:id/([\$])change-id', authHelper_1.checkJwt, (req, res) => {
            const controller = new FhirAPIController(req.fhirServerBase);
            controller.changeId(req.params.resourceType, req.params.id, req.query.newId)
                .then((results) => res.send(results))
                .catch((err) => res.status(500).send(err));
        });
        router.use(authHelper_1.checkJwt, (req, res) => {
            const controller = new FhirAPIController(req.fhirServerBase);
            controller.proxy(req.method, req.url, req.headers, req.query, req.body)
                .then((results) => {
                if (results.contentType) {
                    res.contentType(results.contentType);
                }
                res.status(results.status).send(results.body);
            })
                .catch((err) => res.status(500).send(err));
        });
        return router;
    }
    proxy(method, url, headers, query, body) {
        let proxyUrl = this.baseUrl;
        if (proxyUrl.endsWith('/')) {
            proxyUrl = proxyUrl.substring(0, proxyUrl.length - 1);
        }
        proxyUrl += url;
        const proxyHeaders = JSON.parse(JSON.stringify(headers));
        delete proxyHeaders['authorization'];
        delete proxyHeaders['fhirserver'];
        delete proxyHeaders['host'];
        delete proxyHeaders['origin'];
        delete proxyHeaders['referer'];
        delete proxyHeaders['user-agent'];
        delete proxyHeaders['content-length'];
        delete proxyHeaders['cookie'];
        delete proxyHeaders['connection'];
        proxyHeaders['Cache-Control'] = 'no-cache';
        const options = {
            url: proxyUrl,
            method: method,
            headers: proxyHeaders,
            body: undefined,
            encoding: 'utf8',
            gzip: false,
            json: false
        };
        if (method !== 'GET' && method !== 'DELETE') {
            options.body = body;
            options.json = typeof body === 'object';
        }
        if (proxyHeaders['accept-encoding'] && proxyHeaders['accept-encoding'].indexOf('gzip') >= 0) {
            options.gzip = true;
        }
        return new Promise((resolve, reject) => {
            request(options, (err, response, responseBody) => {
                resolve({
                    status: response.statusCode,
                    body: responseBody,
                    contentType: response.headers ? response.headers['content-type'] : undefined
                });
            });
        });
    }
    changeId(resourceType, currentId, newId) {
        return new Promise((resolve, reject) => {
            if (!newId) {
                return reject({ statusCode: 400, message: 'You must specify a "newId" to change the id of the resource' });
            }
            const currentOptions = {
                url: FhirHelper.buildUrl(this.baseUrl, resourceType, currentId),
                method: 'GET',
                json: true
            };
            FhirAPIController.log.trace(`Request to change id for resource ${resourceType}/${currentId} to ${newId}`);
            // Get the current state of the resource
            rp(currentOptions)
                .then((resource) => {
                if (!resource || !resource.id) {
                    throw new Error(`No resource found for ${resourceType} with id ${currentId}`);
                }
                // Change the id of the resource
                resource.id = newId;
                const createOptions = {
                    url: FhirHelper.buildUrl(this.baseUrl, resourceType, newId),
                    method: 'PUT',
                    json: true,
                    body: resource
                };
                FhirAPIController.log.trace('Sending PUT request to FHIR server with the new resource ID');
                // Create the new resource with the new id
                return rp(createOptions);
            })
                .then(() => {
                const deleteOptions = {
                    url: FhirHelper.buildUrl(this.baseUrl, resourceType, currentId),
                    method: 'DELETE',
                    json: true
                };
                FhirAPIController.log.trace('Sending DELETE request to FHIR server for original resource');
                // Delete the original resource with the original id
                return rp(deleteOptions);
            })
                .then(() => {
                FhirAPIController.log.trace(`Successfully changed the id of ${resourceType}/${currentId} to ${resourceType}/${newId}`);
                resolve(`Successfully changed the id of ${resourceType}/${currentId} to ${resourceType}/${newId}`);
            })
                .catch((err) => reject(err));
        });
    }
}
exports.FhirAPIController = FhirAPIController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmhpckFQSS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZoaXJBUEkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBNEM7QUFDNUMsbUNBQW1DO0FBRW5DLDhDQUF1QztBQUV2QyxtQ0FBbUM7QUFDbkMsc0NBQXNDO0FBQ3RDLDRDQUE0QztBQWtCNUM7OztHQUdHO0FBQ0gsTUFBYSxpQkFBa0IsU0FBUSwyQkFBYztJQUlqRCxZQUFZLE9BQU87UUFDZixLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFFTSxNQUFNLENBQUMsVUFBVTtRQUNwQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsRUFBbUIscUJBQVEsRUFBRSxDQUFDLEdBQW9CLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDdkcsTUFBTSxVQUFVLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDN0QsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztpQkFDdkUsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUNwQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsR0FBRyxDQUFrQixxQkFBUSxFQUFFLENBQWtCLEdBQW9CLEVBQUUsR0FBRyxFQUFFLEVBQUU7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Q0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQTlJRCw4Q0E4SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Jhc2VDb250cm9sbGVyfSBmcm9tICcuL2NvbnRyb2xsZXInO1xyXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQge1JlcXVlc3RIYW5kbGVyfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHtjaGVja0p3dH0gZnJvbSAnLi4vYXV0aEhlbHBlcic7XHJcbmltcG9ydCB7RXh0ZW5kZWRSZXF1ZXN0LCBSZXN0UmVqZWN0aW9ufSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCAqIGFzIHJlcXVlc3QgZnJvbSAncmVxdWVzdCc7XHJcbmltcG9ydCAqIGFzIHJwIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XHJcbmltcG9ydCAqIGFzIEZoaXJIZWxwZXIgZnJvbSAnLi4vZmhpckhlbHBlcic7XHJcblxyXG5pbnRlcmZhY2UgUHJveHlSZXNwb25zZSB7XHJcbiAgICBzdGF0dXM6IG51bWJlcjtcclxuICAgIGJvZHk6IGFueTtcclxuICAgIGNvbnRlbnRUeXBlPzogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgQ2hhbmdlSWRSZXF1ZXN0IGV4dGVuZHMgRXh0ZW5kZWRSZXF1ZXN0IHtcclxuICAgIHBhcmFtczoge1xyXG4gICAgICAgIHJlc291cmNlVHlwZTogc3RyaW5nO1xyXG4gICAgICAgIGlkOiBzdHJpbmc7XHJcbiAgICB9O1xyXG4gICAgcXVlcnk6IHtcclxuICAgICAgICBuZXdJZDogc3RyaW5nO1xyXG4gICAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoaXMgY29udHJvbGxlciBpcyByZXNwb25zaWJsZSBmb3IgYWN0aW5nIGFzIGEgcHJveHkgdG8gdGhlIHVuZGVybHlpbmcgRkhJUiBzZXJ2ZXIncyBBUEkuXHJcbiAqIEl0IGVuZm9yY2VzIGFkZGl0aW9uYWwgbG9naWMgKHBvdGVudGlhbGx5KSwgc3VjaCBhcyBhdXRoZW50aWNhdGlvbiwgYXVkaXRpbmcsIGFuZCBjdXN0b20gb3BlcmF0aW9ucy5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBGaGlyQVBJQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcclxuXHJcbiAgICBwcml2YXRlIGJhc2VVcmw6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihiYXNlVXJsKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLmJhc2VVcmwgPSBiYXNlVXJsO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdFJvdXRlcygpIHtcclxuICAgICAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG5cclxuICAgICAgICByb3V0ZXIucG9zdCgnLzpyZXNvdXJjZVR5cGUvOmlkLyhbXFwkXSljaGFuZ2UtaWQnLCA8UmVxdWVzdEhhbmRsZXI+IGNoZWNrSnd0LCAocmVxOiBDaGFuZ2VJZFJlcXVlc3QsIHJlcykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEZoaXJBUElDb250cm9sbGVyKHJlcS5maGlyU2VydmVyQmFzZSk7XHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuY2hhbmdlSWQocmVxLnBhcmFtcy5yZXNvdXJjZVR5cGUsIHJlcS5wYXJhbXMuaWQsIHJlcS5xdWVyeS5uZXdJZClcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXMuc2VuZChyZXN1bHRzKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZXMuc3RhdHVzKDUwMCkuc2VuZChlcnIpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcm91dGVyLnVzZSg8UmVxdWVzdEhhbmRsZXI+IGNoZWNrSnd0LCA8UmVxdWVzdEhhbmRsZXI+IChyZXE6IEV4dGVuZGVkUmVxdWVzdCwgcmVzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgRmhpckFQSUNvbnRyb2xsZXIocmVxLmZoaXJTZXJ2ZXJCYXNlKTtcclxuICAgICAgICAgICAgY29udHJvbGxlci5wcm94eShyZXEubWV0aG9kLCByZXEudXJsLCByZXEuaGVhZGVycywgcmVxLnF1ZXJ5LCByZXEuYm9keSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzOiBQcm94eVJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMuY29udGVudFR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzLmNvbnRlbnRUeXBlKHJlc3VsdHMuY29udGVudFR5cGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1cyhyZXN1bHRzLnN0YXR1cykuc2VuZChyZXN1bHRzLmJvZHkpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZXMuc3RhdHVzKDUwMCkuc2VuZChlcnIpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJvdXRlcjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcHJveHkobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBoZWFkZXJzOiBhbnksIHF1ZXJ5OiBhbnksIGJvZHk6IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgbGV0IHByb3h5VXJsID0gdGhpcy5iYXNlVXJsO1xyXG5cclxuICAgICAgICBpZiAocHJveHlVcmwuZW5kc1dpdGgoJy8nKSkge1xyXG4gICAgICAgICAgICBwcm94eVVybCA9IHByb3h5VXJsLnN1YnN0cmluZygwLCBwcm94eVVybC5sZW5ndGggLSAxKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByb3h5VXJsICs9IHVybDtcclxuXHJcbiAgICAgICAgY29uc3QgcHJveHlIZWFkZXJzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShoZWFkZXJzKSk7XHJcbiAgICAgICAgZGVsZXRlIHByb3h5SGVhZGVyc1snYXV0aG9yaXphdGlvbiddO1xyXG4gICAgICAgIGRlbGV0ZSBwcm94eUhlYWRlcnNbJ2ZoaXJzZXJ2ZXInXTtcclxuICAgICAgICBkZWxldGUgcHJveHlIZWFkZXJzWydob3N0J107XHJcbiAgICAgICAgZGVsZXRlIHByb3h5SGVhZGVyc1snb3JpZ2luJ107XHJcbiAgICAgICAgZGVsZXRlIHByb3h5SGVhZGVyc1sncmVmZXJlciddO1xyXG4gICAgICAgIGRlbGV0ZSBwcm94eUhlYWRlcnNbJ3VzZXItYWdlbnQnXTtcclxuICAgICAgICBkZWxldGUgcHJveHlIZWFkZXJzWydjb250ZW50LWxlbmd0aCddO1xyXG4gICAgICAgIGRlbGV0ZSBwcm94eUhlYWRlcnNbJ2Nvb2tpZSddO1xyXG4gICAgICAgIGRlbGV0ZSBwcm94eUhlYWRlcnNbJ2Nvbm5lY3Rpb24nXTtcclxuXHJcbiAgICAgICAgcHJveHlIZWFkZXJzWydDYWNoZS1Db250cm9sJ10gPSAnbm8tY2FjaGUnO1xyXG5cclxuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICB1cmw6IHByb3h5VXJsLFxyXG4gICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCxcclxuICAgICAgICAgICAgaGVhZGVyczogcHJveHlIZWFkZXJzLFxyXG4gICAgICAgICAgICBib2R5OiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGVuY29kaW5nOiAndXRmOCcsXHJcbiAgICAgICAgICAgIGd6aXA6IGZhbHNlLFxyXG4gICAgICAgICAgICBqc29uOiBmYWxzZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChtZXRob2QgIT09ICdHRVQnICYmIG1ldGhvZCAhPT0gJ0RFTEVURScpIHtcclxuICAgICAgICAgICAgb3B0aW9ucy5ib2R5ID0gYm9keTtcclxuICAgICAgICAgICAgb3B0aW9ucy5qc29uID0gdHlwZW9mIGJvZHkgPT09ICdvYmplY3QnO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHByb3h5SGVhZGVyc1snYWNjZXB0LWVuY29kaW5nJ10gJiYgcHJveHlIZWFkZXJzWydhY2NlcHQtZW5jb2RpbmcnXS5pbmRleE9mKCdnemlwJykgPj0gMCkge1xyXG4gICAgICAgICAgICBvcHRpb25zLmd6aXAgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFByb3h5UmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgcmVxdWVzdChvcHRpb25zLCAoZXJyLCByZXNwb25zZSwgcmVzcG9uc2VCb2R5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHJlc3BvbnNlLnN0YXR1c0NvZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgYm9keTogcmVzcG9uc2VCb2R5LFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiByZXNwb25zZS5oZWFkZXJzID8gcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10gOiB1bmRlZmluZWRcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2hhbmdlSWQocmVzb3VyY2VUeXBlOiBzdHJpbmcsIGN1cnJlbnRJZDogc3RyaW5nLCBuZXdJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIW5ld0lkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KDxSZXN0UmVqZWN0aW9uPiB7IHN0YXR1c0NvZGU6IDQwMCwgbWVzc2FnZTogJ1lvdSBtdXN0IHNwZWNpZnkgYSBcIm5ld0lkXCIgdG8gY2hhbmdlIHRoZSBpZCBvZiB0aGUgcmVzb3VyY2UnIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50T3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgIHVybDogRmhpckhlbHBlci5idWlsZFVybCh0aGlzLmJhc2VVcmwsIHJlc291cmNlVHlwZSwgY3VycmVudElkKSxcclxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXHJcbiAgICAgICAgICAgICAgICBqc29uOiB0cnVlXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBGaGlyQVBJQ29udHJvbGxlci5sb2cudHJhY2UoYFJlcXVlc3QgdG8gY2hhbmdlIGlkIGZvciByZXNvdXJjZSAke3Jlc291cmNlVHlwZX0vJHtjdXJyZW50SWR9IHRvICR7bmV3SWR9YCk7XHJcblxyXG4gICAgICAgICAgICAvLyBHZXQgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHJlc291cmNlXHJcbiAgICAgICAgICAgIHJwKGN1cnJlbnRPcHRpb25zKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc291cmNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNvdXJjZSB8fCAhcmVzb3VyY2UuaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyByZXNvdXJjZSBmb3VuZCBmb3IgJHtyZXNvdXJjZVR5cGV9IHdpdGggaWQgJHtjdXJyZW50SWR9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBDaGFuZ2UgdGhlIGlkIG9mIHRoZSByZXNvdXJjZVxyXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlLmlkID0gbmV3SWQ7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNyZWF0ZU9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogRmhpckhlbHBlci5idWlsZFVybCh0aGlzLmJhc2VVcmwsIHJlc291cmNlVHlwZSwgbmV3SWQpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdQVVQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBqc29uOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBib2R5OiByZXNvdXJjZVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIEZoaXJBUElDb250cm9sbGVyLmxvZy50cmFjZSgnU2VuZGluZyBQVVQgcmVxdWVzdCB0byBGSElSIHNlcnZlciB3aXRoIHRoZSBuZXcgcmVzb3VyY2UgSUQnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBuZXcgcmVzb3VyY2Ugd2l0aCB0aGUgbmV3IGlkXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJwKGNyZWF0ZU9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWxldGVPcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5iYXNlVXJsLCByZXNvdXJjZVR5cGUsIGN1cnJlbnRJZCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ0RFTEVURScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGpzb246IHRydWVcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBGaGlyQVBJQ29udHJvbGxlci5sb2cudHJhY2UoJ1NlbmRpbmcgREVMRVRFIHJlcXVlc3QgdG8gRkhJUiBzZXJ2ZXIgZm9yIG9yaWdpbmFsIHJlc291cmNlJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIERlbGV0ZSB0aGUgb3JpZ2luYWwgcmVzb3VyY2Ugd2l0aCB0aGUgb3JpZ2luYWwgaWRcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcnAoZGVsZXRlT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIEZoaXJBUElDb250cm9sbGVyLmxvZy50cmFjZShgU3VjY2Vzc2Z1bGx5IGNoYW5nZWQgdGhlIGlkIG9mICR7cmVzb3VyY2VUeXBlfS8ke2N1cnJlbnRJZH0gdG8gJHtyZXNvdXJjZVR5cGV9LyR7bmV3SWR9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShgU3VjY2Vzc2Z1bGx5IGNoYW5nZWQgdGhlIGlkIG9mICR7cmVzb3VyY2VUeXBlfS8ke2N1cnJlbnRJZH0gdG8gJHtyZXNvdXJjZVR5cGV9LyR7bmV3SWR9YCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSJdfQ==
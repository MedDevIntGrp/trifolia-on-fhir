"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const controller_1 = require("./controller");
const authHelper_1 = require("../authHelper");
const express = require("express");
const PhinVadsImporter = require("../import/phinVadsImporter");
const rp = require("request-promise");
const FhirHelper = require("../fhirHelper");
class ImportController extends controller_1.BaseController {
    constructor(baseUrl) {
        super();
        this.vsacBaseUrl = 'https://cts.nlm.nih.gov/fhir/';
        this.baseUrl = baseUrl;
    }
    static initRoutes() {
        const router = express.Router();
        router.get('/phinVads', authHelper_1.checkJwt, (req, res) => {
            const controller = new ImportController(req.fhirServerBase);
            controller.searchPhinVadsValueSet(req.query.searchText)
                .then((results) => res.send(results))
                .catch((err) => this.handleError(err, null, res));
        });
        router.post('/phinVads', authHelper_1.checkJwt, (req, res) => {
            const controller = new ImportController(req.fhirServerBase);
            controller.importPhinVadsValueSet(req.params.id)
                .then((results) => res.send(results))
                .catch((err) => this.handleError(err, null, res));
        });
        router.get('/vsac/:resourceType/:id', authHelper_1.checkJwt, (req, res) => {
            const controller = new ImportController(req.fhirServerBase);
            controller.importVsacValueSet(req.headers.vsacauthorization, req.params.resourceType, req.params.id)
                .then((results) => res.send(results))
                .catch((err) => this.handleError(err, null, res));
        });
        router.post('/', authHelper_1.checkJwt, (req, res) => {
            const controller = new ImportController(req.fhirServerBase);
            controller.importResource(req.body)
                .then((results) => res.send(results))
                .catch((err) => this.handleError(err, null, res));
        });
        return router;
    }
    searchPhinVadsValueSet(searchText) {
        const importer = new PhinVadsImporter();
        return importer.search(searchText);
    }
    importPhinVadsValueSet(id) {
        const importer = new PhinVadsImporter();
        return importer.import(id);
    }
    importVsacValueSet(vsacAuthorization, resourceType, id) {
        const options = {
            method: 'GET',
            url: `${this.vsacBaseUrl}${resourceType}/${id}`,
            headers: {
                'Authorization': vsacAuthorization,
                'Accept': 'application/json'
            },
            json: true,
            resolveWithFullResponse: true
        };
        return new Promise((resolve, reject) => {
            rp(options)
                .then((results) => {
                if (results.statusCode !== 200) {
                    return reject(results.body);
                }
                return this.importResource(results.body);
            })
                .then((results) => resolve(results))
                .catch((err) => reject(err));
        });
    }
    importResource(resource) {
        const resourceType = resource.resourceType;
        const bundle = resource;
        let options;
        if (resource.resourceType === 'Bundle' && bundle.type === 'transaction') {
            options = {
                method: 'POST',
                url: this.baseUrl + (this.baseUrl.endsWith('/') ? '' : '/'),
                body: resource,
                json: true
            };
        }
        else {
            options = {
                method: resource.id ? 'PUT' : 'POST',
                url: FhirHelper.buildUrl(this.baseUrl, resourceType, resource.id),
                body: resource,
                json: true
            };
        }
        return rp(options);
    }
}
exports.ImportController = ImportController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW1wb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQTRDO0FBRzVDLDhDQUF1QztBQUN2QyxtQ0FBbUM7QUFFbkMsK0RBQStEO0FBQy9ELHNDQUFzQztBQUN0Qyw0Q0FBNEM7QUF5QjVDLE1BQWEsZ0JBQWlCLFNBQVEsMkJBQWM7SUFJaEQsWUFBWSxPQUFlO1FBQ3ZCLEtBQUssRUFBRSxDQUFDO1FBSEgsZ0JBQVcsR0FBRywrQkFBK0IsQ0FBQztRQUluRCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUMzQixDQUFDO0lBRU0sTUFBTSxDQUFDLFVBQVU7UUFDcEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRWhDLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFtQixxQkFBUSxFQUFFLENBQUMsR0FBMEIsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNuRixNQUFNLFVBQVUsR0FBRyxJQUFJLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUM1RCxVQUFVLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7aUJBQ2xELElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDcEMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUMxRCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFtQixxQkFBUSxFQUFFLENBQUMsR0FBMEIsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNwRixNQUFNLFVBQVUsR0FBRyxJQUFJLGdCQUFnQixDQUFDLEdB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LEVBQUUsQ0FBQztnQkFDakUsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsSUFBSSxFQUFFLElBQUk7YUFDYixDQUFDO1NBQ0w7UUFFRCxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN2QixDQUFDO0NBQ0o7QUF2R0QsNENBdUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtCYXNlQ29udHJvbGxlcn0gZnJvbSAnLi9jb250cm9sbGVyJztcclxuaW1wb3J0IHtSZXF1ZXN0SGFuZGxlcn0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCB7RXh0ZW5kZWRSZXF1ZXN0fSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCB7Y2hlY2tKd3R9IGZyb20gJy4uL2F1dGhIZWxwZXInO1xyXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQge0J1bmRsZSwgRG9tYWluUmVzb3VyY2V9IGZyb20gJy4uLy4uL3NyYy9hcHAvbW9kZWxzL3N0dTMvZmhpcic7XHJcbmltcG9ydCAqIGFzIFBoaW5WYWRzSW1wb3J0ZXIgZnJvbSAnLi4vaW1wb3J0L3BoaW5WYWRzSW1wb3J0ZXInO1xyXG5pbXBvcnQgKiBhcyBycCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xyXG5pbXBvcnQgKiBhcyBGaGlySGVscGVyIGZyb20gJy4uL2ZoaXJIZWxwZXInO1xyXG5cclxuaW50ZXJmYWNlIFNlYXJjaFBoaW5WYWRzUmVxdWVzdCBleHRlbmRzIEV4dGVuZGVkUmVxdWVzdCB7XHJcbiAgICBxdWVyeToge1xyXG4gICAgICAgIHNlYXJjaFRleHQ6IHN0cmluZztcclxuICAgIH07XHJcbn1cclxuXHJcbmludGVyZmFjZSBJbXBvcnRQaGluVmFkc1JlcXVlc3QgZXh0ZW5kcyBFeHRlbmRlZFJlcXVlc3Qge1xyXG4gICAgcGFyYW1zOiB7XHJcbiAgICAgICAgaWQ6IHN0cmluZztcclxuICAgIH07XHJcbn1cclxuXHJcbmludGVyZmFjZSBJbXBvcnRWc2FjUmVxdWVzdCBleHRlbmRzIEV4dGVuZGVkUmVxdWVzdCB7XHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgZmhpcnNlcnZlcjogc3RyaW5nO1xyXG4gICAgICAgIHZzYWNhdXRob3JpemF0aW9uOiBzdHJpbmc7XHJcbiAgICB9O1xyXG4gICAgcGFyYW1zOiB7XHJcbiAgICAgICAgcmVzb3VyY2VUeXBlOiBzdHJpbmc7XHJcbiAgICAgICAgaWQ6IHN0cmluZztcclxuICAgIH07XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBJbXBvcnRDb250cm9sbGVyIGV4dGVuZHMgQmFzZUNvbnRyb2xsZXIge1xyXG4gICAgcHJpdmF0ZSBiYXNlVXJsOiBzdHJpbmc7XHJcbiAgICByZWFkb25seSB2c2FjQmFzZVVybCA9ICdodHRwczovL2N0cy5ubG0ubmloLmdvdi9maGlyLyc7XHJcblxyXG4gICAgY29uc3RydWN0b3IoYmFzZVVybDogc3RyaW5nKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLmJhc2VVcmwgPSBiYXNlVXJsO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdFJvdXRlcygpIHtcclxuICAgICAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG5cclxuICAgICAgICByb3V0ZXIuZ2V0KCcvcGhpblZhZHMnLCA8UmVxdWVzdEhhbmRsZXI+IGNoZWNrSnd0LCAocmVxOiBTZWFyY2hQaGluVmFkc1JlcXVlc3QsIHJlcykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEltcG9ydENvbnRyb2xsZXIocmVxLmZoaXJTZXJ2ZXJCYXNlKTtcclxuICAgICAgICAgICAgY29udHJvbGxlci5zZWFyY2hQaGluVmFkc1ZhbHVlU2V0KHJlcS5xdWVyeS5zZWFyY2hUZXh0KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlcy5zZW5kKHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyLCBudWxsLCByZXMpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcm91dGVyLnBvc3QoJy9waGluVmFkcycsIDxSZXF1ZXN0SGFuZGxlcj4gY2hlY2tKd3QsIChyZXE6IEltcG9ydFBoaW5WYWRzUmVxdWVzdCwgcmVzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgSW1wb3J0Q29udHJvbGxlcihyZXEuZmhpclNlcnZlckJhc2UpO1xyXG4gICAgICAgICAgICBjb250cm9sbGVyLmltcG9ydFBoaW5WYWRzVmFsdWVTZXQocmVxLnBhcmFtcy5pZClcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXMuc2VuZChyZXN1bHRzKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJvdXRlci5nZXQoJy92c2FjLzpyZXNvdXJjZVR5cGUvOmlkJywgPFJlcXVlc3RIYW5kbGVyPiBjaGVja0p3dCwgKHJlcTogSW1wb3J0VnNhY1JlcXVlc3QsIHJlcykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEltcG9ydENvbnRyb2xsZXIocmVxLmZoaXJTZXJ2ZXJCYXNlKTtcclxuICAgICAgICAgICAgY29udHJvbGxlci5pbXBvcnRWc2FjVmFsdWVTZXQocmVxLmhlYWRlcnMudnNhY2F1dGhvcml6YXRpb24sIHJlcS5wYXJhbXMucmVzb3VyY2VUeXBlLCByZXEucGFyYW1zLmlkKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlcy5zZW5kKHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyLCBudWxsLCByZXMpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcm91dGVyLnBvc3QoJy8nLCA8UmVxdWVzdEhhbmRsZXI+IGNoZWNrSnd0LCAocmVxOiBFeHRlbmRlZFJlcXVlc3QsIHJlcykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEltcG9ydENvbnRyb2xsZXIocmVxLmZoaXJTZXJ2ZXJCYXNlKTtcclxuICAgICAgICAgICAgY29udHJvbGxlci5pbXBvcnRSZXNvdXJjZShyZXEuYm9keSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXMuc2VuZChyZXN1bHRzKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByb3V0ZXI7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNlYXJjaFBoaW5WYWRzVmFsdWVTZXQoc2VhcmNoVGV4dDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgaW1wb3J0ZXIgPSBuZXcgUGhpblZhZHNJbXBvcnRlcigpO1xyXG4gICAgICAgIHJldHVybiBpbXBvcnRlci5zZWFyY2goc2VhcmNoVGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGltcG9ydFBoaW5WYWRzVmFsdWVTZXQoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGltcG9ydGVyID0gbmV3IFBoaW5WYWRzSW1wb3J0ZXIoKTtcclxuICAgICAgICByZXR1cm4gaW1wb3J0ZXIuaW1wb3J0KGlkKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaW1wb3J0VnNhY1ZhbHVlU2V0KHZzYWNBdXRob3JpemF0aW9uOiBzdHJpbmcsIHJlc291cmNlVHlwZTogc3RyaW5nLCBpZDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcclxuICAgICAgICAgICAgdXJsOiBgJHt0aGlzLnZzYWNCYXNlVXJsfSR7cmVzb3VyY2VUeXBlfS8ke2lkfWAsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogdnNhY0F1dGhvcml6YXRpb24sXHJcbiAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGpzb246IHRydWUsXHJcbiAgICAgICAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgcnAob3B0aW9ucylcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMuc3RhdHVzQ29kZSAhPT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QocmVzdWx0cy5ib2R5KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmltcG9ydFJlc291cmNlKHJlc3VsdHMuYm9keSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHJlc29sdmUocmVzdWx0cykpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpbXBvcnRSZXNvdXJjZShyZXNvdXJjZTogRG9tYWluUmVzb3VyY2UpIHtcclxuICAgICAgICBjb25zdCByZXNvdXJjZVR5cGUgPSByZXNvdXJjZS5yZXNvdXJjZVR5cGU7XHJcblxyXG4gICAgICAgIGNvbnN0IGJ1bmRsZSA9IDxCdW5kbGU+IHJlc291cmNlO1xyXG4gICAgICAgIGxldCBvcHRpb25zO1xyXG5cclxuICAgICAgICBpZiAocmVzb3VyY2UucmVzb3VyY2VUeXBlID09PSAnQnVuZGxlJyAmJiBidW5kbGUudHlwZSA9PT0gJ3RyYW5zYWN0aW9uJykge1xyXG4gICAgICAgICAgICBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgICAgICB1cmw6IHRoaXMuYmFzZVVybCArICh0aGlzLmJhc2VVcmwuZW5kc1dpdGgoJy8nKSA/ICcnIDogJy8nKSxcclxuICAgICAgICAgICAgICAgIGJvZHk6IHJlc291cmNlLFxyXG4gICAgICAgICAgICAgICAganNvbjogdHJ1ZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICBtZXRob2Q6IHJlc291cmNlLmlkID8gJ1BVVCcgOiAnUE9TVCcsXHJcbiAgICAgICAgICAgICAgICB1cmw6IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5iYXNlVXJsLCByZXNvdXJjZVR5cGUsIHJlc291cmNlLmlkKSxcclxuICAgICAgICAgICAgICAgIGJvZHk6IHJlc291cmNlLFxyXG4gICAgICAgICAgICAgICAganNvbjogdHJ1ZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJwKG9wdGlvbnMpO1xyXG4gICAgfVxyXG59Il19
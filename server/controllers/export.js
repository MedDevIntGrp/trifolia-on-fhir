"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const tmp = require("tmp");
const path = require("path");
const html_1 = require("../export/html");
const controller_1 = require("./controller");
const bundle_1 = require("../export/bundle");
const promiseHelper_1 = require("../promiseHelper");
var ExportFormats;
(function (ExportFormats) {
    ExportFormats["Bundle"] = "1";
    ExportFormats["Html"] = "2";
})(ExportFormats || (ExportFormats = {}));
class ExportOptions {
    constructor(query) {
        this.executeIgPublisher = true;
        this.useTerminologyServer = false;
        this.useLatest = false;
        this.downloadOutput = true;
        this.format = 'json';
        this.exportFormat = ExportFormats.Bundle;
        if (query) {
            if (query.socketId) {
                this.socketId = query.socketId;
            }
            if (query.hasOwnProperty('executeIgPublisher')) {
                this.executeIgPublisher = query.executeIgPublisher.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useTerminologyServer')) {
                this.useTerminologyServer = query.useTerminologyServer.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useLatest')) {
                this.useLatest = query.useLatest.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('downloadOutput')) {
                this.downloadOutput = query.downloadOutput.toLowerCase === 'true';
            }
            if (query.hasOwnProperty('_format')) {
                this.format = query._format;
            }
            if (query.hasOwnProperty('exportFormat')) {
                this.exportFormat = query.exportFormat;
            }
        }
    }
}
class ExportController extends controller_1.BaseController {
    constructor(baseUrl, fhirServerId, fhir, io) {
        super();
        this.baseUrl = baseUrl;
        this.fhirServerId = fhirServerId;
        this.fhir = fhir;
        this.io = io;
    }
    static initRoutes() {
        const router = express.Router();
        router.post('/:implementationGuideId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhir, req.io);
            controller.exportImplementationGuide(req.params.implementationGuideId, new ExportOptions(req.query))
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        router.get('/:packageId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhir, req.io);
            controller.getExportedPackage(req.params.packageId)
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        return router;
    }
    exportBundle(implementationGuideId, format = 'json') {
        return new Promise((resolve, reject) => {
            const exporter = new bundle_1.BundleExporter(this.baseUrl, this.fhirServerId, this.fhir, implementationGuideId);
            exporter.export(format)
                .then((response) => {
                let fileExt = '.json';
                if (format && format === 'application/xml') {
                    fileExt = '.xml';
                }
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-bundle' + fileExt,
                    content: response
                });
            })
                .catch((err) => reject(err));
        });
    }
    exportHtml(implementationGuideId, options) {
        return new Promise((resolve, reject) => {
            const exporter = new html_1.HtmlExporter(this.baseUrl, this.fhirServerId, this.fhir, this.io, options.socketId, implementationGuideId);
            ExportController.htmlExports.push(exporter);
            exporter.export(options.format, options.executeIgPublisher, options.useTerminologyServer, options.useLatest, options.downloadOutput)
                .then((response) => {
                resolve({
                    content: response
                });
                // Should be moved to a .finally() block when moving to ES2018
                const index = ExportController.htmlExports.indexOf(exporter);
                ExportController.htmlExports.splice(index);
            })
                .catch((err) => {
                reject(err);
                // Should be moved to a .finally() block when moving to ES2018
                const index = ExportController.htmlExports.indexOf(exporter);
                ExportController.htmlExports.splice(index);
            });
        });
    }
    exportImplementationGuide(implementationGuideId, options) {
        switch (options.exportFormat) {
            case ExportFormats.Bundle:
                return this.exportBundle(implementationGuideId, options.format);
                break;
            case ExportFormats.Html:
                return this.exportHtml(implementationGuideId, options);
                break;
            default:
                return Promise.reject('Unexpected export format selected: ' + options.exportFormat);
        }
    }
    getExportedPackage(packageId) {
        return new Promise((resolve, reject) => {
            const rootPath = path.join(tmp.tmpdir, packageId);
            promiseHelper_1.zip(rootPath)
                .then((buffer) => {
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-package.zip',
                    content: buffer
                });
                return promiseHelper_1.emptydir(rootPath);
            })
                .then(() => {
                return promiseHelper_1.rmdir(rootPath);
            })
                .catch((err) => {
                ExportController.log.error(err);
                reject(err);
            });
        });
    }
}
ExportController.htmlExports = [];
exports.ExportController = ExportController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXhwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDJCQUEyQjtBQUMzQiw2QkFBNkI7QUFDN0IseUNBQTRDO0FBRTVDLDZDQUE2RDtBQUc3RCw2Q0FBZ0Q7QUFDaEQsb0RBQXNEO0FBb0J0RCxJQUFLLGFBR0o7QUFIRCxXQUFLLGFBQWE7SUFDZCw2QkFBWSxDQUFBO0lBQ1osMkJBQVUsQ0FBQTtBQUNkLENBQUMsRUFISSxhQUFhLEtBQWIsYUFBYSxRQUdqQjtBQUVELE1BQU0sYUFBYTtJQVNmLFlBQVksS0FBVztRQVBoQix1QkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDMUIseUJBQW9CLEdBQUcsS0FBSyxDQUFDO1FBQzdCLGNBQVMsR0FBRyxLQUFLLENBQUM7UUFDbEIsbUJBQWMsR0FBRyxJQUFJLENBQUM7UUFDdEIsV0FBTSxHQUFxRyxNQUFNLENBQUM7UUFDbEgsaUJBQVksR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDO1FBR3ZDLElBQUksS0FBSyxFQUFFO1lBQ1AsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFO2dCQUNoQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7YUFDbEM7WUFFRCxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsb0JBQW9CLENBQUMsRUFBRTtnQkFDNUMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsS0FBSyxNQUFNLENBQUM7YUFDL0U7WUFFRCxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsc0JBQXNCLENBQUMsRUFBRTtnQkFDOUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsS0FBSyxNQUFNLENBQUM7YUFDbkY7WUFFRCxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ25DLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsS0FBSyxNQUFNLENBQUM7YUFDN0Q7WUFFRCxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtnQkFDeEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLFdBQVcsS0FBSyxNQUFNLENBQUM7YUFDckU7WUFFRCxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQzthQUMvQjtZQUVELElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsRUFBRTtnQkFDdEMsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDO2FBQzFDO1NBQ0o7SUFDTCxDQUFDO0NBQ0o7QUFFRCxNQUFhLGdCQUFpQixTQUFRLDJCQUFjO0lBUWhELFlBQVksT0FBZSxFQUFFLFlBQW9CLEVBQUUsSUFBVSxFQUFFLEVBQVU7UUFDckUsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRU0sTUFBTSxDQUFDLFVBQVU7UUFDcEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRWhDLE1BQU0sQ0FBQyxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBa0IsR0FBcUMsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNuRyxNQUFNLFVBQVUsR0FBRyxJQUFJLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdEcsVUFBVSxDQUFDLHlCQUF5QixDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMscUJBQXFCLEVBQUUsSUFBSSxhQUFhLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUMvRixJQUFJLENBQUMsQ0FBQyxPQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztpQkFDckUsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBa0IsR0FBOEIsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUMvRSxNQUFNLFVBQVUsR0FBRyxJQUFJLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdEcsVUFBVSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO2lCQUM5QyxJQUFJLENBQUMsQ0FBQyxPQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztpQkFDckUsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVPLFlBQVksQ0FBQyxxQkFBNkIsRUFBRSxTQUEyRyxNQUFNO1FBQ2pLLE9BQU8sSUFBSSxPQUFPLENBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUksdUJBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1lBQ3ZHLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO2lCQUNsQixJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtnQkFDZixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUM7Z0JBRXRCLElBQUksTUFBTSxJQUFJLE1BQU0sS0FBSyxpQkFBaUIsRUFBRTtvQkFDeEMsT0FBTyxHQUFHLE1BQU0sQ0FBQztpQkFDcEI7Z0JBRUQsT0FBTyxDQUFDO29CQUNKLFdBQVcsRUFBRSwwQkFBMEI7b0JBQ3ZDLGtCQUFrQixFQUFFLGdDQUFnQyxHQUFHLE9BQU87b0JBQzlELE9BQU8sRUFBRSxRQUFRO2lCQUNwQixDQUFDLENBQUM7WUFDUCxDQUFDLENBQUM7aUJBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxVQUFVLENBQUMscUJBQTZCLEVBQUUsT0FBc0I7UUFDcEUsT0FBTyxJQUFJLE9BQU8sQ0FBa0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDcEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxtQkFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1lBRWhJLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFNUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsb0JBQW9CLEVBQUUsT0FBTyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsY0FBYyxDQUFDO2lCQUMvSCxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtnQkFDZixPQUFPLENBQUM7b0JBQ0osT0FBTyxFQUFFLFFBQVE7aUJBQ3BCLENBQUMsQ0FBQztnQkFFSCw4REFBOEQ7Z0JBQzlELE1BQU0sS0FBSyxHQUFHLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzdELGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDL0MsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNYLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFFWiw4REFBOEQ7Z0JBQzlELE1BQU0sS0FBSyxHQUFHLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzdELGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDL0MsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSx5QkFBeUIsQ0FBQyxxQkFBNkIsRUFBRSxPQUFzQjtRQUNsRixRQUFRLE9BQU8sQ0FBQyxZQUFZLEVBQUU7WUFDMUIsS0FBSyxhQUFhLENBQUMsTUFBTTtnQkFDckIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLHFCQUFxQixFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDaEUsTUFBTTtZQUNWLEtBQUssYUFBYSxDQUFDLElBQUk7Z0JBQ25CLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFDdkQsTUFBTTtZQUNWO2dCQUNJLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxxQ0FBcUMsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDM0Y7SUFDTCxDQUFDO0lBRU0sa0JBQWtCLENBQUMsU0FBaUI7UUFDdkMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFbEQsbUJBQUcsQ0FBQyxRQUFRLENBQUM7aUJBQ1IsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7Z0JBQ2IsT0FBTyxDQUFDO29CQUNKLFdBQVcsRUFBRSwwQkFBMEI7b0JBQ3ZDLGtCQUFrQixFQUFFLHFDQUFxQztvQkFDekQsT0FBTyxFQUFFLE1BQU07aUJBQ2xCLENBQUMsQ0FBQztnQkFFSCxPQUFPLHdCQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDOUIsQ0FBQyxDQUFDO2lCQUNELElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ1AsT0FBTyxxQkFBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNCLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDWCxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNoQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7O0FBckhNLDRCQUFXLEdBQUcsRUFBRSxDQUFDO0FBRDVCLDRDQXVIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCAqIGFzIHRtcCBmcm9tICd0bXAnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQge0h0bWxFeHBvcnRlcn0gZnJvbSAnLi4vZXhwb3J0L2h0bWwnO1xyXG5pbXBvcnQge0V4dGVuZGVkUmVxdWVzdH0gZnJvbSAnLi9tb2RlbHMnO1xyXG5pbXBvcnQge0Jhc2VDb250cm9sbGVyLCBHZW5lcmljUmVzcG9uc2V9IGZyb20gJy4vY29udHJvbGxlcic7XHJcbmltcG9ydCB7Rmhpcn0gZnJvbSAnZmhpci9maGlyJztcclxuaW1wb3J0IHtTZXJ2ZXJ9IGZyb20gJ3NvY2tldC5pbyc7XHJcbmltcG9ydCB7QnVuZGxlRXhwb3J0ZXJ9IGZyb20gJy4uL2V4cG9ydC9idW5kbGUnO1xyXG5pbXBvcnQge2VtcHR5ZGlyLCBybWRpciwgemlwfSBmcm9tICcuLi9wcm9taXNlSGVscGVyJztcclxuXHJcbmludGVyZmFjZSBFeHBvcnRJbXBsZW1lbnRhdGlvbkd1aWRlUmVxdWVzdCBleHRlbmRzIEV4dGVuZGVkUmVxdWVzdCB7XHJcbiAgICBwYXJhbXM6IHtcclxuICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZztcclxuICAgIH07XHJcbiAgICBxdWVyeToge1xyXG4gICAgICAgIF9mb3JtYXQ/OiBzdHJpbmc7XHJcbiAgICB9O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgR2V0RXhwb3J0ZWRQYWNrYWdlUmVxdWVzdCBleHRlbmRzIEV4dGVuZGVkUmVxdWVzdCB7XHJcbiAgICBwYXJhbXM6IHtcclxuICAgICAgICBwYWNrYWdlSWQ6IHN0cmluZztcclxuICAgIH07XHJcbiAgICBxdWVyeToge1xyXG4gICAgICAgIHNvY2tldElkPzogc3RyaW5nO1xyXG4gICAgfTtcclxufVxyXG5cclxuZW51bSBFeHBvcnRGb3JtYXRzIHtcclxuICAgIEJ1bmRsZSA9ICcxJyxcclxuICAgIEh0bWwgPSAnMidcclxufVxyXG5cclxuY2xhc3MgRXhwb3J0T3B0aW9ucyB7XHJcbiAgICBwdWJsaWMgc29ja2V0SWQ/OiBzdHJpbmc7XHJcbiAgICBwdWJsaWMgZXhlY3V0ZUlnUHVibGlzaGVyID0gdHJ1ZTtcclxuICAgIHB1YmxpYyB1c2VUZXJtaW5vbG9neVNlcnZlciA9IGZhbHNlO1xyXG4gICAgcHVibGljIHVzZUxhdGVzdCA9IGZhbHNlO1xyXG4gICAgcHVibGljIGRvd25sb2FkT3V0cHV0ID0gdHJ1ZTtcclxuICAgIHB1YmxpYyBmb3JtYXQ6ICdqc29uJ3wneG1sJ3wnYXBwbGljYXRpb24vanNvbid8J2FwcGxpY2F0aW9uL2ZoaXIranNvbid8J2FwcGxpY2F0aW9uL3htbCd8J2FwcGxpY2F0aW9uL2ZoaXIreG1sJyA9ICdqc29uJztcclxuICAgIHB1YmxpYyBleHBvcnRGb3JtYXQgPSBFeHBvcnRGb3JtYXRzLkJ1bmRsZTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihxdWVyeT86IGFueSkge1xyXG4gICAgICAgIGlmIChxdWVyeSkge1xyXG4gICAgICAgICAgICBpZiAocXVlcnkuc29ja2V0SWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0SWQgPSBxdWVyeS5zb2NrZXRJZDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KCdleGVjdXRlSWdQdWJsaXNoZXInKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5leGVjdXRlSWdQdWJsaXNoZXIgPSBxdWVyeS5leGVjdXRlSWdQdWJsaXNoZXIudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAocXVlcnkuaGFzT3duUHJvcGVydHkoJ3VzZVRlcm1pbm9sb2d5U2VydmVyJykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXNlVGVybWlub2xvZ3lTZXJ2ZXIgPSBxdWVyeS51c2VUZXJtaW5vbG9neVNlcnZlci50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgndXNlTGF0ZXN0JykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXNlTGF0ZXN0ID0gcXVlcnkudXNlTGF0ZXN0LnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KCdkb3dubG9hZE91dHB1dCcpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRvd25sb2FkT3V0cHV0ID0gcXVlcnkuZG93bmxvYWRPdXRwdXQudG9Mb3dlckNhc2UgPT09ICd0cnVlJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KCdfZm9ybWF0JykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0ID0gcXVlcnkuX2Zvcm1hdDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KCdleHBvcnRGb3JtYXQnKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5leHBvcnRGb3JtYXQgPSBxdWVyeS5leHBvcnRGb3JtYXQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBFeHBvcnRDb250cm9sbGVyIGV4dGVuZHMgQmFzZUNvbnRyb2xsZXIge1xyXG4gICAgc3RhdGljIGh0bWxFeHBvcnRzID0gW107XHJcblxyXG4gICAgcmVhZG9ubHkgYmFzZVVybDogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZmhpclNlcnZlcklkOiBzdHJpbmc7XHJcbiAgICByZWFkb25seSBmaGlyOiBGaGlyO1xyXG4gICAgcmVhZG9ubHkgaW86IFNlcnZlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihiYXNlVXJsOiBzdHJpbmcsIGZoaXJTZXJ2ZXJJZDogc3RyaW5nLCBmaGlyOiBGaGlyLCBpbzogU2VydmVyKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLmJhc2VVcmwgPSBiYXNlVXJsO1xyXG4gICAgICAgIHRoaXMuZmhpclNlcnZlcklkID0gZmhpclNlcnZlcklkO1xyXG4gICAgICAgIHRoaXMuZmhpciA9IGZoaXI7XHJcbiAgICAgICAgdGhpcy5pbyA9IGlvO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdFJvdXRlcygpIHtcclxuICAgICAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG5cclxuICAgICAgICByb3V0ZXIucG9zdCgnLzppbXBsZW1lbnRhdGlvbkd1aWRlSWQnLCA8UmVxdWVzdEhhbmRsZXI+IChyZXE6IEV4cG9ydEltcGxlbWVudGF0aW9uR3VpZGVSZXF1ZXN0LCByZXMpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBFeHBvcnRDb250cm9sbGVyKHJlcS5maGlyU2VydmVyQmFzZSwgcmVxLmhlYWRlcnMuZmhpcnNlcnZlciwgcmVxLmZoaXIsIHJlcS5pbyk7XHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZShyZXEucGFyYW1zLmltcGxlbWVudGF0aW9uR3VpZGVJZCwgbmV3IEV4cG9ydE9wdGlvbnMocmVxLnF1ZXJ5KSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzOiBHZW5lcmljUmVzcG9uc2UpID0+IHRoaXMuaGFuZGxlUmVzcG9uc2UocmVzLCByZXN1bHRzKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBFeHBvcnRDb250cm9sbGVyLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJvdXRlci5nZXQoJy86cGFja2FnZUlkJywgPFJlcXVlc3RIYW5kbGVyPiAocmVxOiBHZXRFeHBvcnRlZFBhY2thZ2VSZXF1ZXN0LCByZXMpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBFeHBvcnRDb250cm9sbGVyKHJlcS5maGlyU2VydmVyQmFzZSwgcmVxLmhlYWRlcnMuZmhpcnNlcnZlciwgcmVxLmZoaXIsIHJlcS5pbyk7XHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZ2V0RXhwb3J0ZWRQYWNrYWdlKHJlcS5wYXJhbXMucGFja2FnZUlkKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHM6IEdlbmVyaWNSZXNwb25zZSkgPT4gdGhpcy5oYW5kbGVSZXNwb25zZShyZXMsIHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IEV4cG9ydENvbnRyb2xsZXIuaGFuZGxlRXJyb3IoZXJyLCBudWxsLCByZXMpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJvdXRlcjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGV4cG9ydEJ1bmRsZShpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZywgZm9ybWF0OiAnanNvbid8J3htbCd8J2FwcGxpY2F0aW9uL2pzb24nfCdhcHBsaWNhdGlvbi9maGlyK2pzb24nfCdhcHBsaWNhdGlvbi94bWwnfCdhcHBsaWNhdGlvbi9maGlyK3htbCcgPSAnanNvbicpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEJ1bmRsZUV4cG9ydGVyKHRoaXMuYmFzZVVybCwgdGhpcy5maGlyU2VydmVySWQsIHRoaXMuZmhpciwgaW1wbGVtZW50YXRpb25HdWlkZUlkKTtcclxuICAgICAgICAgICAgZXhwb3J0ZXIuZXhwb3J0KGZvcm1hdClcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlRXh0ID0gJy5qc29uJztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdCAmJiBmb3JtYXQgPT09ICdhcHBsaWNhdGlvbi94bWwnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVFeHQgPSAnLnhtbCc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50RGlzcG9zaXRpb246ICdhdHRhY2htZW50OyBmaWxlbmFtZT1pZy1idW5kbGUnICsgZmlsZUV4dCwgICAgICAvLyBUT0RPOiBEZXRlcm1pbmUgZmlsZSBuYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHJlc3BvbnNlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGV4cG9ydEh0bWwoaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmcsIG9wdGlvbnM6IEV4cG9ydE9wdGlvbnMpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEh0bWxFeHBvcnRlcih0aGlzLmJhc2VVcmwsIHRoaXMuZmhpclNlcnZlcklkLCB0aGlzLmZoaXIsIHRoaXMuaW8sIG9wdGlvbnMuc29ja2V0SWQsIGltcGxlbWVudGF0aW9uR3VpZGVJZCk7XHJcblxyXG4gICAgICAgICAgICBFeHBvcnRDb250cm9sbGVyLmh0bWxFeHBvcnRzLnB1c2goZXhwb3J0ZXIpO1xyXG5cclxuICAgICAgICAgICAgZXhwb3J0ZXIuZXhwb3J0KG9wdGlvbnMuZm9ybWF0LCBvcHRpb25zLmV4ZWN1dGVJZ1B1Ymxpc2hlciwgb3B0aW9ucy51c2VUZXJtaW5vbG9neVNlcnZlciwgb3B0aW9ucy51c2VMYXRlc3QsIG9wdGlvbnMuZG93bmxvYWRPdXRwdXQpXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogcmVzcG9uc2VcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gU2hvdWxkIGJlIG1vdmVkIHRvIGEgLmZpbmFsbHkoKSBibG9jayB3aGVuIG1vdmluZyB0byBFUzIwMThcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IEV4cG9ydENvbnRyb2xsZXIuaHRtbEV4cG9ydHMuaW5kZXhPZihleHBvcnRlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgRXhwb3J0Q29udHJvbGxlci5odG1sRXhwb3J0cy5zcGxpY2UoaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFNob3VsZCBiZSBtb3ZlZCB0byBhIC5maW5hbGx5KCkgYmxvY2sgd2hlbiBtb3ZpbmcgdG8gRVMyMDE4XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBFeHBvcnRDb250cm9sbGVyLmh0bWxFeHBvcnRzLmluZGV4T2YoZXhwb3J0ZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIEV4cG9ydENvbnRyb2xsZXIuaHRtbEV4cG9ydHMuc3BsaWNlKGluZGV4KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBleHBvcnRJbXBsZW1lbnRhdGlvbkd1aWRlKGltcGxlbWVudGF0aW9uR3VpZGVJZDogc3RyaW5nLCBvcHRpb25zOiBFeHBvcnRPcHRpb25zKTogUHJvbWlzZTxHZW5lcmljUmVzcG9uc2U+IHtcclxuICAgICAgICBzd2l0Y2ggKG9wdGlvbnMuZXhwb3J0Rm9ybWF0KSB7XHJcbiAgICAgICAgICAgIGNhc2UgRXhwb3J0Rm9ybWF0cy5CdW5kbGU6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leHBvcnRCdW5kbGUoaW1wbGVtZW50YXRpb25HdWlkZUlkLCBvcHRpb25zLmZvcm1hdCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBFeHBvcnRGb3JtYXRzLkh0bWw6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leHBvcnRIdG1sKGltcGxlbWVudGF0aW9uR3VpZGVJZCwgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnVW5leHBlY3RlZCBleHBvcnQgZm9ybWF0IHNlbGVjdGVkOiAnICsgb3B0aW9ucy5leHBvcnRGb3JtYXQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0RXhwb3J0ZWRQYWNrYWdlKHBhY2thZ2VJZDogc3RyaW5nKTogUHJvbWlzZTxHZW5lcmljUmVzcG9uc2U+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByb290UGF0aCA9IHBhdGguam9pbih0bXAudG1wZGlyLCBwYWNrYWdlSWQpO1xyXG5cclxuICAgICAgICAgICAgemlwKHJvb3RQYXRoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKGJ1ZmZlcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnREaXNwb3NpdGlvbjogJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPWlnLXBhY2thZ2UuemlwJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogYnVmZmVyXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlbXB0eWRpcihyb290UGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBybWRpcihyb290UGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBFeHBvcnRDb250cm9sbGVyLmxvZy5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0iXX0=
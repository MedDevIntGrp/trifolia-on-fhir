"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const tmp = require("tmp");
const zipdir = require("zip-dir");
const fs = require("fs-extra");
const HtmlExporter = require("../export/html");
const path = require("path");
const controller_1 = require("./controller");
const bundle_1 = require("../export/bundle");
var ExportFormats;
(function (ExportFormats) {
    ExportFormats["Bundle"] = "1";
    ExportFormats["Html"] = "2";
})(ExportFormats || (ExportFormats = {}));
class ExportOptions {
    constructor(query) {
        this.executeIgPublisher = true;
        this.useTerminologyServer = false;
        this.useLatest = false;
        this.downloadOutput = true;
        this.format = 'json';
        this.exportFormat = ExportFormats.Bundle;
        if (query) {
            if (query.socketId) {
                this.socketId = query.socketId;
            }
            if (query.hasOwnProperty('executeIgPublisher')) {
                this.executeIgPublisher = query.executeIgPublisher.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useTerminologyServer')) {
                this.useTerminologyServer = query.useTerminologyServer.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useLatest')) {
                this.useLatest = query.useLatest.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('downloadOutput')) {
                this.downloadOutput = query.downloadOutput.toLowerCase === 'true';
            }
            if (query.hasOwnProperty('_format')) {
                this.format = query._format;
            }
            if (query.hasOwnProperty('exportFormat')) {
                this.exportFormat = query.exportFormat;
            }
        }
    }
}
class ExportController extends controller_1.BaseController {
    constructor(baseUrl, fhirServerId, fhir, io) {
        super();
        this.baseUrl = baseUrl;
        this.fhirServerId = fhirServerId;
        this.fhir = fhir;
        this.io = io;
    }
    static initRoutes() {
        const router = express.Router();
        router.post('/:implementationGuideId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhir, req.io);
            controller.exportImplementationGuide(req.params.implementationGuideId, new ExportOptions(req.query))
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        router.get('/:packageId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhir, req.io);
            controller.getExportedPackage(req.params.packageId)
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        return router;
    }
    exportBundle(implementationGuideId, format = 'json') {
        return new Promise((resolve, reject) => {
            const exporter = new bundle_1.BundleExporter(this.baseUrl, this.fhirServerId, this.fhir, implementationGuideId);
            exporter.export(format)
                .then((response) => {
                let fileExt = '.json';
                if (format && format === 'application/xml') {
                    fileExt = '.xml';
                }
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-bundle' + fileExt,
                    content: response
                });
            })
                .catch((err) => reject(err));
        });
    }
    exportHtml(implementationGuideId, options) {
        return new Promise((resolve, reject) => {
            const exporter = new HtmlExporter(this.baseUrl, this.fhirServerId, this.fhir, this.io, options.socketId, implementationGuideId);
            ExportController.htmlExports.push(exporter);
            exporter.export(options.format, options.executeIgPublisher, options.useTerminologyServer, options.useLatest, options.downloadOutput)
                .then((response) => {
                resolve({
                    content: response
                });
            })
                .catch((err) => reject(err))
                .finally(() => {
                const index = ExportController.htmlExports.indexOf(exporter);
                ExportController.htmlExports.splice(index);
            });
        });
    }
    exportImplementationGuide(implementationGuideId, options) {
        switch (options.exportFormat) {
            case ExportFormats.Bundle:
                return this.exportBundle(implementationGuideId, options.format);
                break;
            case ExportFormats.Html:
                return this.exportHtml(implementationGuideId, options);
                break;
            default:
                return Promise.reject('Unexpected export format selected: ' + options.exportFormat);
        }
    }
    getExportedPackage(packageId) {
        return new Promise((resolve, reject) => {
            const rootPath = path.join(tmp.tmpdir, packageId);
            zipdir(rootPath, (err, buffer) => {
                if (err) {
                    ExportController.log.error(err);
                    fs.emptyDir(rootPath); // Asynchronously removes the temporary folder
                    return reject('An error occurred while zipping the package');
                }
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-package.zip',
                    content: buffer
                });
                fs.emptyDir(rootPath);
                fs.rmdir(rootPath);
            });
        });
    }
}
ExportController.htmlExports = [];
exports.ExportController = ExportController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXhwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDJCQUEyQjtBQUMzQixrQ0FBa0M7QUFDbEMsK0JBQStCO0FBQy9CLCtDQUErQztBQUMvQyw2QkFBNkI7QUFFN0IsNkNBQTZEO0FBRzdELDZDQUFnRDtBQW9CaEQsSUFBSyxhQUdKO0FBSEQsV0FBSyxhQUFhO0lBQ2QsNkJBQVksQ0FBQTtJQUNaLDJCQUFVLENBQUE7QUFDZCxDQUFDLEVBSEksYUFBYSxLQUFiLGFBQWEsUUFHakI7QUFFRCxNQUFNLGFBQWE7SUFTZixZQUFZLEtBQVc7UUFQaEIsdUJBQWtCLEdBQUcsSUFBSSxDQUFDO1FBQzFCLHlCQUFvQixHQUFHLEtBQUssQ0FBQztRQUM3QixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLFdBQU0sR0FBcUcsTUFBTSxDQUFDO1FBQ2xILGlCQUFZLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQztRQUd2QyxJQUFJLEtBQUssRUFBRTtZQUNQLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO2FBQ2xDO1lBRUQsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLEVBQUU7Z0JBQzVDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxDQUFDO2FBQy9FO1lBRUQsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLHNCQUFzQixDQUFDLEVBQUU7Z0JBQzlDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxDQUFDO2FBQ25GO1lBRUQsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLFdBQVcs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TUFBTSxFQUFFLEVBQUU7WUFDbkMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBRWxELE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQzdCLElBQUksR0FBRyxFQUFFO29CQUNMLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2hDLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBYSw4Q0FBOEM7b0JBQ2pGLE9BQU8sTUFBTSxDQUFDLDZDQUE2QyxDQUFDLENBQUM7aUJBQ2hFO2dCQUVELE9BQU8sQ0FBQztvQkFDSixXQUFXLEVBQUUsMEJBQTBCO29CQUN2QyxrQkFBa0IsRUFBRSxxQ0FBcUM7b0JBQ3pELE9BQU8sRUFBRSxNQUFNO2lCQUNsQixDQUFDLENBQUM7Z0JBRUgsRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDdEIsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN2QixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7QUE5R00sNEJBQVcsR0FBRyxFQUFFLENBQUM7QUFENUIsNENBZ0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCAqIGFzIHRtcCBmcm9tICd0bXAnO1xuaW1wb3J0ICogYXMgemlwZGlyIGZyb20gJ3ppcC1kaXInO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgSHRtbEV4cG9ydGVyIGZyb20gJy4uL2V4cG9ydC9odG1sJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge0V4dGVuZGVkUmVxdWVzdH0gZnJvbSAnLi9tb2RlbHMnO1xuaW1wb3J0IHtCYXNlQ29udHJvbGxlciwgR2VuZXJpY1Jlc3BvbnNlfSBmcm9tICcuL2NvbnRyb2xsZXInO1xuaW1wb3J0IHtGaGlyfSBmcm9tICdmaGlyL2ZoaXInO1xuaW1wb3J0IHtTZXJ2ZXJ9IGZyb20gJ3NvY2tldC5pbyc7XG5pbXBvcnQge0J1bmRsZUV4cG9ydGVyfSBmcm9tICcuLi9leHBvcnQvYnVuZGxlJztcblxuaW50ZXJmYWNlIEV4cG9ydEltcGxlbWVudGF0aW9uR3VpZGVSZXF1ZXN0IGV4dGVuZHMgRXh0ZW5kZWRSZXF1ZXN0IHtcbiAgICBwYXJhbXM6IHtcbiAgICAgICAgaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmc7XG4gICAgfTtcbiAgICBxdWVyeToge1xuICAgICAgICBfZm9ybWF0Pzogc3RyaW5nO1xuICAgIH07XG59XG5cbmludGVyZmFjZSBHZXRFeHBvcnRlZFBhY2thZ2VSZXF1ZXN0IGV4dGVuZHMgRXh0ZW5kZWRSZXF1ZXN0IHtcbiAgICBwYXJhbXM6IHtcbiAgICAgICAgcGFja2FnZUlkOiBzdHJpbmc7XG4gICAgfTtcbiAgICBxdWVyeToge1xuICAgICAgICBzb2NrZXRJZD86IHN0cmluZztcbiAgICB9O1xufVxuXG5lbnVtIEV4cG9ydEZvcm1hdHMge1xuICAgIEJ1bmRsZSA9ICcxJyxcbiAgICBIdG1sID0gJzInXG59XG5cbmNsYXNzIEV4cG9ydE9wdGlvbnMge1xuICAgIHB1YmxpYyBzb2NrZXRJZD86IHN0cmluZztcbiAgICBwdWJsaWMgZXhlY3V0ZUlnUHVibGlzaGVyID0gdHJ1ZTtcbiAgICBwdWJsaWMgdXNlVGVybWlub2xvZ3lTZXJ2ZXIgPSBmYWxzZTtcbiAgICBwdWJsaWMgdXNlTGF0ZXN0ID0gZmFsc2U7XG4gICAgcHVibGljIGRvd25sb2FkT3V0cHV0ID0gdHJ1ZTtcbiAgICBwdWJsaWMgZm9ybWF0OiAnanNvbid8J3htbCd8J2FwcGxpY2F0aW9uL2pzb24nfCdhcHBsaWNhdGlvbi9maGlyK2pzb24nfCdhcHBsaWNhdGlvbi94bWwnfCdhcHBsaWNhdGlvbi9maGlyK3htbCcgPSAnanNvbic7XG4gICAgcHVibGljIGV4cG9ydEZvcm1hdCA9IEV4cG9ydEZvcm1hdHMuQnVuZGxlO1xuXG4gICAgY29uc3RydWN0b3IocXVlcnk/OiBhbnkpIHtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICBpZiAocXVlcnkuc29ja2V0SWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNvY2tldElkID0gcXVlcnkuc29ja2V0SWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnZXhlY3V0ZUlnUHVibGlzaGVyJykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVJZ1B1Ymxpc2hlciA9IHF1ZXJ5LmV4ZWN1dGVJZ1B1Ymxpc2hlci50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgndXNlVGVybWlub2xvZ3lTZXJ2ZXInKSkge1xuICAgICAgICAgICAgICAgIHRoaXMudXNlVGVybWlub2xvZ3lTZXJ2ZXIgPSBxdWVyeS51c2VUZXJtaW5vbG9neVNlcnZlci50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgndXNlTGF0ZXN0JykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZUxhdGVzdCA9IHF1ZXJ5LnVzZUxhdGVzdC50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnZG93bmxvYWRPdXRwdXQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZG93bmxvYWRPdXRwdXQgPSBxdWVyeS5kb3dubG9hZE91dHB1dC50b0xvd2VyQ2FzZSA9PT0gJ3RydWUnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocXVlcnkuaGFzT3duUHJvcGVydHkoJ19mb3JtYXQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0ID0gcXVlcnkuX2Zvcm1hdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KCdleHBvcnRGb3JtYXQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZXhwb3J0Rm9ybWF0ID0gcXVlcnkuZXhwb3J0Rm9ybWF0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgRXhwb3J0Q29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgICBzdGF0aWMgaHRtbEV4cG9ydHMgPSBbXTtcblxuICAgIHJlYWRvbmx5IGJhc2VVcmw6IHN0cmluZztcbiAgICByZWFkb25seSBmaGlyU2VydmVySWQ6IHN0cmluZztcbiAgICByZWFkb25seSBmaGlyOiBGaGlyO1xuICAgIHJlYWRvbmx5IGlvOiBTZXJ2ZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihiYXNlVXJsOiBzdHJpbmcsIGZoaXJTZXJ2ZXJJZDogc3RyaW5nLCBmaGlyOiBGaGlyLCBpbzogU2VydmVyKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7XG4gICAgICAgIHRoaXMuZmhpclNlcnZlcklkID0gZmhpclNlcnZlcklkO1xuICAgICAgICB0aGlzLmZoaXIgPSBmaGlyO1xuICAgICAgICB0aGlzLmlvID0gaW87XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBpbml0Um91dGVzKCkge1xuICAgICAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4gICAgICAgIHJvdXRlci5wb3N0KCcvOmltcGxlbWVudGF0aW9uR3VpZGVJZCcsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogRXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZVJlcXVlc3QsIHJlcykgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBFeHBvcnRDb250cm9sbGVyKHJlcS5maGlyU2VydmVyQmFzZSwgcmVxLmhlYWRlcnMuZmhpcnNlcnZlciwgcmVxLmZoaXIsIHJlcS5pbyk7XG4gICAgICAgICAgICBjb250cm9sbGVyLmV4cG9ydEltcGxlbWVudGF0aW9uR3VpZGUocmVxLnBhcmFtcy5pbXBsZW1lbnRhdGlvbkd1aWRlSWQsIG5ldyBFeHBvcnRPcHRpb25zKHJlcS5xdWVyeSkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHM6IEdlbmVyaWNSZXNwb25zZSkgPT4gdGhpcy5oYW5kbGVSZXNwb25zZShyZXMsIHJlc3VsdHMpKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBFeHBvcnRDb250cm9sbGVyLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJvdXRlci5nZXQoJy86cGFja2FnZUlkJywgPFJlcXVlc3RIYW5kbGVyPiAocmVxOiBHZXRFeHBvcnRlZFBhY2thZ2VSZXF1ZXN0LCByZXMpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgRXhwb3J0Q29udHJvbGxlcihyZXEuZmhpclNlcnZlckJhc2UsIHJlcS5oZWFkZXJzLmZoaXJzZXJ2ZXIsIHJlcS5maGlyLCByZXEuaW8pO1xuICAgICAgICAgICAgY29udHJvbGxlci5nZXRFeHBvcnRlZFBhY2thZ2UocmVxLnBhcmFtcy5wYWNrYWdlSWQpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHM6IEdlbmVyaWNSZXNwb25zZSkgPT4gdGhpcy5oYW5kbGVSZXNwb25zZShyZXMsIHJlc3VsdHMpKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBFeHBvcnRDb250cm9sbGVyLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByb3V0ZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleHBvcnRCdW5kbGUoaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmcsIGZvcm1hdDogJ2pzb24nfCd4bWwnfCdhcHBsaWNhdGlvbi9qc29uJ3wnYXBwbGljYXRpb24vZmhpcitqc29uJ3wnYXBwbGljYXRpb24veG1sJ3wnYXBwbGljYXRpb24vZmhpcit4bWwnID0gJ2pzb24nKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxHZW5lcmljUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEJ1bmRsZUV4cG9ydGVyKHRoaXMuYmFzZVVybCwgdGhpcy5maGlyU2VydmVySWQsIHRoaXMuZmhpciwgaW1wbGVtZW50YXRpb25HdWlkZUlkKTtcbiAgICAgICAgICAgIGV4cG9ydGVyLmV4cG9ydChmb3JtYXQpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlRXh0ID0gJy5qc29uJztcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0ICYmIGZvcm1hdCA9PT0gJ2FwcGxpY2F0aW9uL3htbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVFeHQgPSAnLnhtbCc7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnREaXNwb3NpdGlvbjogJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPWlnLWJ1bmRsZScgKyBmaWxlRXh0LCAgICAgIC8vIFRPRE86IERldGVybWluZSBmaWxlIG5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHJlc3BvbnNlXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleHBvcnRIdG1sKGltcGxlbWVudGF0aW9uR3VpZGVJZDogc3RyaW5nLCBvcHRpb25zOiBFeHBvcnRPcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxHZW5lcmljUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEh0bWxFeHBvcnRlcih0aGlzLmJhc2VVcmwsIHRoaXMuZmhpclNlcnZlcklkLCB0aGlzLmZoaXIsIHRoaXMuaW8sIG9wdGlvbnMuc29ja2V0SWQsIGltcGxlbWVudGF0aW9uR3VpZGVJZCk7XG5cbiAgICAgICAgICAgIEV4cG9ydENvbnRyb2xsZXIuaHRtbEV4cG9ydHMucHVzaChleHBvcnRlcik7XG5cbiAgICAgICAgICAgIGV4cG9ydGVyLmV4cG9ydChvcHRpb25zLmZvcm1hdCwgb3B0aW9ucy5leGVjdXRlSWdQdWJsaXNoZXIsIG9wdGlvbnMudXNlVGVybWlub2xvZ3lTZXJ2ZXIsIG9wdGlvbnMudXNlTGF0ZXN0LCBvcHRpb25zLmRvd25sb2FkT3V0cHV0KVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHJlc3BvbnNlXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKVxuICAgICAgICAgICAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBFeHBvcnRDb250cm9sbGVyLmh0bWxFeHBvcnRzLmluZGV4T2YoZXhwb3J0ZXIpO1xuICAgICAgICAgICAgICAgICAgICBFeHBvcnRDb250cm9sbGVyLmh0bWxFeHBvcnRzLnNwbGljZShpbmRleCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBleHBvcnRJbXBsZW1lbnRhdGlvbkd1aWRlKGltcGxlbWVudGF0aW9uR3VpZGVJZDogc3RyaW5nLCBvcHRpb25zOiBFeHBvcnRPcHRpb25zKTogUHJvbWlzZTxHZW5lcmljUmVzcG9uc2U+IHtcbiAgICAgICAgc3dpdGNoIChvcHRpb25zLmV4cG9ydEZvcm1hdCkge1xuICAgICAgICAgICAgY2FzZSBFeHBvcnRGb3JtYXRzLkJ1bmRsZTpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leHBvcnRCdW5kbGUoaW1wbGVtZW50YXRpb25HdWlkZUlkLCBvcHRpb25zLmZvcm1hdCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIEV4cG9ydEZvcm1hdHMuSHRtbDpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leHBvcnRIdG1sKGltcGxlbWVudGF0aW9uR3VpZGVJZCwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnVW5leHBlY3RlZCBleHBvcnQgZm9ybWF0IHNlbGVjdGVkOiAnICsgb3B0aW9ucy5leHBvcnRGb3JtYXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldEV4cG9ydGVkUGFja2FnZShwYWNrYWdlSWQ6IHN0cmluZyk6IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCByb290UGF0aCA9IHBhdGguam9pbih0bXAudG1wZGlyLCBwYWNrYWdlSWQpO1xuXG4gICAgICAgICAgICB6aXBkaXIocm9vdFBhdGgsIChlcnIsIGJ1ZmZlcikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgRXhwb3J0Q29udHJvbGxlci5sb2cuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgZnMuZW1wdHlEaXIocm9vdFBhdGgpOyAgICAgICAgICAgICAvLyBBc3luY2hyb25vdXNseSByZW1vdmVzIHRoZSB0ZW1wb3JhcnkgZm9sZGVyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHppcHBpbmcgdGhlIHBhY2thZ2UnKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50RGlzcG9zaXRpb246ICdhdHRhY2htZW50OyBmaWxlbmFtZT1pZy1wYWNrYWdlLnppcCcsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGJ1ZmZlclxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgZnMuZW1wdHlEaXIocm9vdFBhdGgpO1xuICAgICAgICAgICAgICAgIGZzLnJtZGlyKHJvb3RQYXRoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59Il19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const tmp = require("tmp");
const path = require("path");
const html_1 = require("../export/html");
const controller_1 = require("./controller");
const bundle_1 = require("../export/bundle");
const promiseHelper_1 = require("../promiseHelper");
var ExportFormats;
(function (ExportFormats) {
    ExportFormats["Bundle"] = "1";
    ExportFormats["Html"] = "2";
})(ExportFormats || (ExportFormats = {}));
class ExportOptions {
    constructor(query) {
        this.executeIgPublisher = true;
        this.useTerminologyServer = false;
        this.useLatest = false;
        this.downloadOutput = true;
        this.format = 'json';
        this.exportFormat = ExportFormats.Bundle;
        this.includeIgPublisherJar = false;
        if (query) {
            if (query.socketId) {
                this.socketId = query.socketId;
            }
            if (query.hasOwnProperty('executeIgPublisher')) {
                this.executeIgPublisher = query.executeIgPublisher.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useTerminologyServer')) {
                this.useTerminologyServer = query.useTerminologyServer.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useLatest')) {
                this.useLatest = query.useLatest.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('downloadOutput')) {
                this.downloadOutput = query.downloadOutput.toLowerCase === 'true';
            }
            if (query.hasOwnProperty('_format')) {
                this.format = query._format;
            }
            if (query.hasOwnProperty('exportFormat')) {
                this.exportFormat = query.exportFormat;
            }
            if (query.hasOwnProperty('includeIgPublisherJar')) {
                this.includeIgPublisherJar = query.includeIgPublisherJar.toLowerCase() === 'true';
            }
        }
    }
}
class ExportController extends controller_1.BaseController {
    constructor(baseUrl, fhirServerId, fhir, io) {
        super();
        this.baseUrl = baseUrl;
        this.fhirServerId = fhirServerId;
        this.fhir = fhir;
        this.io = io;
    }
    static initRoutes() {
        const router = express.Router();
        router.post('/:implementationGuideId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhir, req.io);
            controller.exportImplementationGuide(req.params.implementationGuideId, new ExportOptions(req.query))
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        router.get('/:packageId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhir, req.io);
            controller.getExportedPackage(req.params.packageId)
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        return router;
    }
    exportBundle(implementationGuideId, format = 'json') {
        return new Promise((resolve, reject) => {
            const exporter = new bundle_1.BundleExporter(this.baseUrl, this.fhirServerId, this.fhir, implementationGuideId);
            exporter.export(format)
                .then((response) => {
                let fileExt = '.json';
                if (format && format === 'application/xml') {
                    fileExt = '.xml';
                }
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-bundle' + fileExt,
                    content: response
                });
            })
                .catch((err) => reject(err));
        });
    }
    exportHtml(implementationGuideId, options) {
        return new Promise((resolve, reject) => {
            const exporter = new html_1.HtmlExporter(this.baseUrl, this.fhirServerId, this.fhir, this.io, options.socketId, implementationGuideId);
            ExportController.htmlExports.push(exporter);
            exporter.export(options.format, options.executeIgPublisher, options.useTerminologyServer, options.useLatest, options.downloadOutput, options.includeIgPublisherJar)
                .then((response) => {
                resolve({
                    content: response
                });
                // Should be moved to a .finally() block when moving to ES2018
                const index = ExportController.htmlExports.indexOf(exporter);
                ExportController.htmlExports.splice(index);
            })
                .catch((err) => {
                reject(err);
                // Should be moved to a .finally() block when moving to ES2018
                const index = ExportController.htmlExports.indexOf(exporter);
                ExportController.htmlExports.splice(index);
            });
        });
    }
    exportImplementationGuide(implementationGuideId, options) {
        switch (options.exportFormat) {
            case ExportFormats.Bundle:
                return this.exportBundle(implementationGuideId, options.format);
                break;
            case ExportFormats.Html:
                return this.exportHtml(implementationGuideId, options);
                break;
            default:
                return Promise.reject('Unexpected export format selected: ' + options.exportFormat);
        }
    }
    getExportedPackage(packageId) {
        return new Promise((resolve, reject) => {
            const rootPath = path.join(tmp.tmpdir, packageId);
            promiseHelper_1.zip(rootPath)
                .then((buffer) => {
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-package.zip',
                    content: buffer
                });
                return promiseHelper_1.emptydir(rootPath);
            })
                .then(() => {
                return promiseHelper_1.rmdir(rootPath);
            })
                .catch((err) => {
                ExportController.log.error(err);
                reject(err);
            });
        });
    }
}
ExportController.htmlExports = [];
exports.ExportController = ExportController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXhwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDJCQUEyQjtBQUMzQiw2QkFBNkI7QUFDN0IseUNBQTRDO0FBRTVDLDZDQUE2RDtBQUc3RCw2Q0FBZ0Q7QUFDaEQsb0RBQXNEO0FBb0J0RCxJQUFLLGFBR0o7QUFIRCxXQUFLLGFBQWE7SUFDZCw2QkFBWSxDQUFBO0lBQ1osMkJBQVUsQ0FBQTtBQUNkLENBQUMsRUFISSxhQUFhLEtBQWIsYUFBYSxRQUdqQjtBQUVELE1BQU0sYUFBYTtJQVVmLFlBQVksS0FBVztRQVJoQix1QkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDMUIseUJBQW9CLEdBQUcsS0FBSyxDQUFDO1FBQzdCLGNBQVMsR0FBRyxLQUFLLENBQUM7UUFDbEIsbUJBQWMsR0FBRyxJQUFJLENBQUM7UUFDdEIsV0FBTSxHQUFxRyxNQUFNLENBQUM7UUFDbEgsaUJBQVksR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDO1FBQ3BDLDBCQUFxQixHQUFHLEtBQUssQ0FBQztRQUdqQyxJQUFJLEtBQUssRUFBRTtZQUNQLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO2FBQ2xDO1lBRUQsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLEVBQUU7Z0JBQzVDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxDQUFDO2FBQy9FO1lBRUQsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLHNCQUFzQixDQUFDLEVBQUU7Z0JBQzlDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxDQUFDO2FBQ25GO1lBRUQsSUFBSSxLQUFLLENBQUMs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cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCAqIGFzIHRtcCBmcm9tICd0bXAnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7SHRtbEV4cG9ydGVyfSBmcm9tICcuLi9leHBvcnQvaHRtbCc7XG5pbXBvcnQge0V4dGVuZGVkUmVxdWVzdH0gZnJvbSAnLi9tb2RlbHMnO1xuaW1wb3J0IHtCYXNlQ29udHJvbGxlciwgR2VuZXJpY1Jlc3BvbnNlfSBmcm9tICcuL2NvbnRyb2xsZXInO1xuaW1wb3J0IHtGaGlyfSBmcm9tICdmaGlyL2ZoaXInO1xuaW1wb3J0IHtTZXJ2ZXJ9IGZyb20gJ3NvY2tldC5pbyc7XG5pbXBvcnQge0J1bmRsZUV4cG9ydGVyfSBmcm9tICcuLi9leHBvcnQvYnVuZGxlJztcbmltcG9ydCB7ZW1wdHlkaXIsIHJtZGlyLCB6aXB9IGZyb20gJy4uL3Byb21pc2VIZWxwZXInO1xuXG5pbnRlcmZhY2UgRXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZVJlcXVlc3QgZXh0ZW5kcyBFeHRlbmRlZFJlcXVlc3Qge1xuICAgIHBhcmFtczoge1xuICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZztcbiAgICB9O1xuICAgIHF1ZXJ5OiB7XG4gICAgICAgIF9mb3JtYXQ/OiBzdHJpbmc7XG4gICAgfTtcbn1cblxuaW50ZXJmYWNlIEdldEV4cG9ydGVkUGFja2FnZVJlcXVlc3QgZXh0ZW5kcyBFeHRlbmRlZFJlcXVlc3Qge1xuICAgIHBhcmFtczoge1xuICAgICAgICBwYWNrYWdlSWQ6IHN0cmluZztcbiAgICB9O1xuICAgIHF1ZXJ5OiB7XG4gICAgICAgIHNvY2tldElkPzogc3RyaW5nO1xuICAgIH07XG59XG5cbmVudW0gRXhwb3J0Rm9ybWF0cyB7XG4gICAgQnVuZGxlID0gJzEnLFxuICAgIEh0bWwgPSAnMidcbn1cblxuY2xhc3MgRXhwb3J0T3B0aW9ucyB7XG4gICAgcHVibGljIHNvY2tldElkPzogc3RyaW5nO1xuICAgIHB1YmxpYyBleGVjdXRlSWdQdWJsaXNoZXIgPSB0cnVlO1xuICAgIHB1YmxpYyB1c2VUZXJtaW5vbG9neVNlcnZlciA9IGZhbHNlO1xuICAgIHB1YmxpYyB1c2VMYXRlc3QgPSBmYWxzZTtcbiAgICBwdWJsaWMgZG93bmxvYWRPdXRwdXQgPSB0cnVlO1xuICAgIHB1YmxpYyBmb3JtYXQ6ICdqc29uJ3wneG1sJ3wnYXBwbGljYXRpb24vanNvbid8J2FwcGxpY2F0aW9uL2ZoaXIranNvbid8J2FwcGxpY2F0aW9uL3htbCd8J2FwcGxpY2F0aW9uL2ZoaXIreG1sJyA9ICdqc29uJztcbiAgICBwdWJsaWMgZXhwb3J0Rm9ybWF0ID0gRXhwb3J0Rm9ybWF0cy5CdW5kbGU7XG4gICAgcHVibGljIGluY2x1ZGVJZ1B1Ymxpc2hlckphciA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IocXVlcnk/OiBhbnkpIHtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICBpZiAocXVlcnkuc29ja2V0SWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNvY2tldElkID0gcXVlcnkuc29ja2V0SWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnZXhlY3V0ZUlnUHVibGlzaGVyJykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVJZ1B1Ymxpc2hlciA9IHF1ZXJ5LmV4ZWN1dGVJZ1B1Ymxpc2hlci50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgndXNlVGVybWlub2xvZ3lTZXJ2ZXInKSkge1xuICAgICAgICAgICAgICAgIHRoaXMudXNlVGVybWlub2xvZ3lTZXJ2ZXIgPSBxdWVyeS51c2VUZXJtaW5vbG9neVNlcnZlci50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgndXNlTGF0ZXN0JykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZUxhdGVzdCA9IHF1ZXJ5LnVzZUxhdGVzdC50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnZG93bmxvYWRPdXRwdXQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZG93bmxvYWRPdXRwdXQgPSBxdWVyeS5kb3dubG9hZE91dHB1dC50b0xvd2VyQ2FzZSA9PT0gJ3RydWUnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocXVlcnkuaGFzT3duUHJvcGVydHkoJ19mb3JtYXQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0ID0gcXVlcnkuX2Zvcm1hdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KCdleHBvcnRGb3JtYXQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZXhwb3J0Rm9ybWF0ID0gcXVlcnkuZXhwb3J0Rm9ybWF0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocXVlcnkuaGFzT3duUHJvcGVydHkoJ2luY2x1ZGVJZ1B1Ymxpc2hlckphcicpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbmNsdWRlSWdQdWJsaXNoZXJKYXIgPSBxdWVyeS5pbmNsdWRlSWdQdWJsaXNoZXJKYXIudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgRXhwb3J0Q29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgICBzdGF0aWMgaHRtbEV4cG9ydHMgPSBbXTtcblxuICAgIHJlYWRvbmx5IGJhc2VVcmw6IHN0cmluZztcbiAgICByZWFkb25seSBmaGlyU2VydmVySWQ6IHN0cmluZztcbiAgICByZWFkb25seSBmaGlyOiBGaGlyO1xuICAgIHJlYWRvbmx5IGlvOiBTZXJ2ZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihiYXNlVXJsOiBzdHJpbmcsIGZoaXJTZXJ2ZXJJZDogc3RyaW5nLCBmaGlyOiBGaGlyLCBpbzogU2VydmVyKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7XG4gICAgICAgIHRoaXMuZmhpclNlcnZlcklkID0gZmhpclNlcnZlcklkO1xuICAgICAgICB0aGlzLmZoaXIgPSBmaGlyO1xuICAgICAgICB0aGlzLmlvID0gaW87XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBpbml0Um91dGVzKCkge1xuICAgICAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4gICAgICAgIHJvdXRlci5wb3N0KCcvOmltcGxlbWVudGF0aW9uR3VpZGVJZCcsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogRXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZVJlcXVlc3QsIHJlcykgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBFeHBvcnRDb250cm9sbGVyKHJlcS5maGlyU2VydmVyQmFzZSwgcmVxLmhlYWRlcnMuZmhpcnNlcnZlciwgcmVxLmZoaXIsIHJlcS5pbyk7XG4gICAgICAgICAgICBjb250cm9sbGVyLmV4cG9ydEltcGxlbWVudGF0aW9uR3VpZGUocmVxLnBhcmFtcy5pbXBsZW1lbnRhdGlvbkd1aWRlSWQsIG5ldyBFeHBvcnRPcHRpb25zKHJlcS5xdWVyeSkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHM6IEdlbmVyaWNSZXNwb25zZSkgPT4gdGhpcy5oYW5kbGVSZXNwb25zZShyZXMsIHJlc3VsdHMpKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBFeHBvcnRDb250cm9sbGVyLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJvdXRlci5nZXQoJy86cGFja2FnZUlkJywgPFJlcXVlc3RIYW5kbGVyPiAocmVxOiBHZXRFeHBvcnRlZFBhY2thZ2VSZXF1ZXN0LCByZXMpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgRXhwb3J0Q29udHJvbGxlcihyZXEuZmhpclNlcnZlckJhc2UsIHJlcS5oZWFkZXJzLmZoaXJzZXJ2ZXIsIHJlcS5maGlyLCByZXEuaW8pO1xuICAgICAgICAgICAgY29udHJvbGxlci5nZXRFeHBvcnRlZFBhY2thZ2UocmVxLnBhcmFtcy5wYWNrYWdlSWQpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHM6IEdlbmVyaWNSZXNwb25zZSkgPT4gdGhpcy5oYW5kbGVSZXNwb25zZShyZXMsIHJlc3VsdHMpKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBFeHBvcnRDb250cm9sbGVyLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByb3V0ZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleHBvcnRCdW5kbGUoaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmcsIGZvcm1hdDogJ2pzb24nfCd4bWwnfCdhcHBsaWNhdGlvbi9qc29uJ3wnYXBwbGljYXRpb24vZmhpcitqc29uJ3wnYXBwbGljYXRpb24veG1sJ3wnYXBwbGljYXRpb24vZmhpcit4bWwnID0gJ2pzb24nKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxHZW5lcmljUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEJ1bmRsZUV4cG9ydGVyKHRoaXMuYmFzZVVybCwgdGhpcy5maGlyU2VydmVySWQsIHRoaXMuZmhpciwgaW1wbGVtZW50YXRpb25HdWlkZUlkKTtcbiAgICAgICAgICAgIGV4cG9ydGVyLmV4cG9ydChmb3JtYXQpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlRXh0ID0gJy5qc29uJztcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0ICYmIGZvcm1hdCA9PT0gJ2FwcGxpY2F0aW9uL3htbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVFeHQgPSAnLnhtbCc7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnREaXNwb3NpdGlvbjogJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPWlnLWJ1bmRsZScgKyBmaWxlRXh0LCAgICAgIC8vIFRPRE86IERldGVybWluZSBmaWxlIG5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHJlc3BvbnNlXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleHBvcnRIdG1sKGltcGxlbWVudGF0aW9uR3VpZGVJZDogc3RyaW5nLCBvcHRpb25zOiBFeHBvcnRPcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxHZW5lcmljUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEh0bWxFeHBvcnRlcih0aGlzLmJhc2VVcmwsIHRoaXMuZmhpclNlcnZlcklkLCB0aGlzLmZoaXIsIHRoaXMuaW8sIG9wdGlvbnMuc29ja2V0SWQsIGltcGxlbWVudGF0aW9uR3VpZGVJZCk7XG5cbiAgICAgICAgICAgIEV4cG9ydENvbnRyb2xsZXIuaHRtbEV4cG9ydHMucHVzaChleHBvcnRlcik7XG5cbiAgICAgICAgICAgIGV4cG9ydGVyLmV4cG9ydChvcHRpb25zLmZvcm1hdCwgb3B0aW9ucy5leGVjdXRlSWdQdWJsaXNoZXIsIG9wdGlvbnMudXNlVGVybWlub2xvZ3lTZXJ2ZXIsIG9wdGlvbnMudXNlTGF0ZXN0LCBvcHRpb25zLmRvd25sb2FkT3V0cHV0LCBvcHRpb25zLmluY2x1ZGVJZ1B1Ymxpc2hlckphcilcbiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiByZXNwb25zZVxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBTaG91bGQgYmUgbW92ZWQgdG8gYSAuZmluYWxseSgpIGJsb2NrIHdoZW4gbW92aW5nIHRvIEVTMjAxOFxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IEV4cG9ydENvbnRyb2xsZXIuaHRtbEV4cG9ydHMuaW5kZXhPZihleHBvcnRlcik7XG4gICAgICAgICAgICAgICAgICAgIEV4cG9ydENvbnRyb2xsZXIuaHRtbEV4cG9ydHMuc3BsaWNlKGluZGV4KTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIFNob3VsZCBiZSBtb3ZlZCB0byBhIC5maW5hbGx5KCkgYmxvY2sgd2hlbiBtb3ZpbmcgdG8gRVMyMDE4XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gRXhwb3J0Q29udHJvbGxlci5odG1sRXhwb3J0cy5pbmRleE9mKGV4cG9ydGVyKTtcbiAgICAgICAgICAgICAgICAgICAgRXhwb3J0Q29udHJvbGxlci5odG1sRXhwb3J0cy5zcGxpY2UoaW5kZXgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZShpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZywgb3B0aW9uczogRXhwb3J0T3B0aW9ucyk6IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPiB7XG4gICAgICAgIHN3aXRjaCAob3B0aW9ucy5leHBvcnRGb3JtYXQpIHtcbiAgICAgICAgICAgIGNhc2UgRXhwb3J0Rm9ybWF0cy5CdW5kbGU6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0QnVuZGxlKGltcGxlbWVudGF0aW9uR3VpZGVJZCwgb3B0aW9ucy5mb3JtYXQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBFeHBvcnRGb3JtYXRzLkh0bWw6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0SHRtbChpbXBsZW1lbnRhdGlvbkd1aWRlSWQsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ1VuZXhwZWN0ZWQgZXhwb3J0IGZvcm1hdCBzZWxlY3RlZDogJyArIG9wdGlvbnMuZXhwb3J0Rm9ybWF0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRFeHBvcnRlZFBhY2thZ2UocGFja2FnZUlkOiBzdHJpbmcpOiBQcm9taXNlPEdlbmVyaWNSZXNwb25zZT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgcm9vdFBhdGggPSBwYXRoLmpvaW4odG1wLnRtcGRpciwgcGFja2FnZUlkKTtcblxuICAgICAgICAgICAgemlwKHJvb3RQYXRoKVxuICAgICAgICAgICAgICAgIC50aGVuKChidWZmZXIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50RGlzcG9zaXRpb246ICdhdHRhY2htZW50OyBmaWxlbmFtZT1pZy1wYWNrYWdlLnppcCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBidWZmZXJcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5ZGlyKHJvb3RQYXRoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJtZGlyKHJvb3RQYXRoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIEV4cG9ydENvbnRyb2xsZXIubG9nLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59Il19
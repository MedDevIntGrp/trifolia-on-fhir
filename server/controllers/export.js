"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const tmp = require("tmp");
const path = require("path");
const rp = require("request-promise");
const _ = require("underscore");
const html_1 = require("../export/html");
const controller_1 = require("./controller");
const bundle_1 = require("../export/bundle");
const promiseHelper_1 = require("../promiseHelper");
const authHelper_1 = require("../authHelper");
const FhirHelper = require("../fhirHelper");
var ExportFormats;
(function (ExportFormats) {
    ExportFormats["Bundle"] = "1";
    ExportFormats["Html"] = "2";
})(ExportFormats || (ExportFormats = {}));
class ExportOptions {
    constructor(query) {
        this.executeIgPublisher = true;
        this.useTerminologyServer = false;
        this.useLatest = false;
        this.downloadOutput = true;
        this.format = 'json';
        this.exportFormat = ExportFormats.Bundle;
        this.includeIgPublisherJar = false;
        if (query) {
            if (query.socketId) {
                this.socketId = query.socketId;
            }
            if (query.hasOwnProperty('executeIgPublisher')) {
                this.executeIgPublisher = query.executeIgPublisher.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useTerminologyServer')) {
                this.useTerminologyServer = query.useTerminologyServer.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('useLatest')) {
                this.useLatest = query.useLatest.toLowerCase() === 'true';
            }
            if (query.hasOwnProperty('downloadOutput')) {
                this.downloadOutput = query.downloadOutput.toLowerCase === 'true';
            }
            if (query.hasOwnProperty('_format')) {
                this.format = query._format;
            }
            if (query.hasOwnProperty('exportFormat')) {
                this.exportFormat = query.exportFormat;
            }
            if (query.hasOwnProperty('includeIgPublisherJar')) {
                this.includeIgPublisherJar = query.includeIgPublisherJar.toLowerCase() === 'true';
            }
        }
    }
}
class ExportController extends controller_1.BaseController {
    constructor(baseUrl, fhirServerId, fhirVersion, fhir, io) {
        super();
        this.baseUrl = baseUrl;
        this.fhirServerId = fhirServerId;
        this.fhirVersion = fhirVersion;
        this.fhir = fhir;
        this.io = io;
    }
    static initRoutes() {
        const router = express.Router();
        router.post('/:implementationGuideId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhirServerVersion, req.fhir, req.io);
            controller.exportImplementationGuide(req.params.implementationGuideId, new ExportOptions(req.query))
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        router.get('/:packageId', (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhirServerVersion, req.fhir, req.io);
            controller.getExportedPackage(req.params.packageId)
                .then((results) => this.handleResponse(res, results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        router.get('/:implementationGuideId/([$])validate', authHelper_1.checkJwt, (req, res) => {
            const controller = new ExportController(req.fhirServerBase, req.headers.fhirserver, req.fhirServerVersion, req.fhir, req.io);
            controller.validate(req.params.implementationGuideId)
                .then((results) => res.send(results))
                .catch((err) => ExportController.handleError(err, null, res));
        });
        return router;
    }
    validate(implementationGuideId) {
        return new Promise((resolve, reject) => {
            const bundleExporter = new bundle_1.BundleExporter(this.baseUrl, this.fhirServerId, this.fhirVersion, this.fhir, implementationGuideId);
            let validationRequests = [];
            bundleExporter.getBundle(true)
                .then((results) => {
                validationRequests = _.map(results.entry, (entry) => {
                    const options = {
                        url: FhirHelper.buildUrl(this.baseUrl, entry.resource.resourceType, null, '$validate'),
                        method: 'POST',
                        body: entry.resource,
                        json: true,
                        simple: false,
                        resolveWithFullResponse: true
                    };
                    return {
                        resourceReference: `${entry.resource.resourceType}/${entry.resource.id}`,
                        promise: rp(options)
                    };
                });
                const promises = _.map(validationRequests, (validationRequest) => validationRequest.promise);
                return Promise.all(promises);
            })
                .then((resultSets) => {
                let validationResults = [];
                _.each(resultSets, (resultSet, index) => {
                    if (resultSet.body && resultSet.body.resourceType === 'OperationOutcome') {
                        const oo = resultSet.body;
                        const next = _.map(oo.issue, (issue) => {
                            return {
                                resourceReference: validationRequests[index].resourceReference,
                                severity: issue.severity,
                                details: issue.diagnostics
                            };
                        });
                        validationResults = validationResults.concat(next);
                    }
                });
                validationResults = _.sortBy(validationResults, (validationResult) => validationResult.severity);
                resolve(validationResults);
            })
                .catch((err) => {
                if (err.statusCode === 412) {
                    resolve(err.error);
                }
                else {
                    reject(err);
                }
            });
        });
    }
    exportBundle(implementationGuideId, format = 'json') {
        return new Promise((resolve, reject) => {
            const exporter = new bundle_1.BundleExporter(this.baseUrl, this.fhirServerId, this.fhirVersion, this.fhir, implementationGuideId);
            exporter.export(format)
                .then((response) => {
                let fileExt = '.json';
                if (format && format === 'application/xml') {
                    fileExt = '.xml';
                }
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-bundle' + fileExt,
                    content: response
                });
            })
                .catch((err) => reject(err));
        });
    }
    exportHtml(implementationGuideId, options) {
        return new Promise((resolve, reject) => {
            const exporter = new html_1.HtmlExporter(this.baseUrl, this.fhirServerId, this.fhirVersion, this.fhir, this.io, options.socketId, implementationGuideId);
            ExportController.htmlExports.push(exporter);
            exporter.export(options.format, options.executeIgPublisher, options.useTerminologyServer, options.useLatest, options.downloadOutput, options.includeIgPublisherJar)
                .then((response) => {
                resolve({
                    content: response
                });
                // Should be moved to a .finally() block when moving to ES2018
                const index = ExportController.htmlExports.indexOf(exporter);
                ExportController.htmlExports.splice(index);
            })
                .catch((err) => {
                reject(err);
                // Should be moved to a .finally() block when moving to ES2018
                const index = ExportController.htmlExports.indexOf(exporter);
                ExportController.htmlExports.splice(index);
            });
        });
    }
    exportImplementationGuide(implementationGuideId, options) {
        switch (options.exportFormat) {
            case ExportFormats.Bundle:
                return this.exportBundle(implementationGuideId, options.format);
                break;
            case ExportFormats.Html:
                return this.exportHtml(implementationGuideId, options);
                break;
            default:
                return Promise.reject('Unexpected export format selected: ' + options.exportFormat);
        }
    }
    getExportedPackage(packageId) {
        return new Promise((resolve, reject) => {
            const rootPath = path.join(tmp.tmpdir, packageId);
            promiseHelper_1.zip(rootPath)
                .then((buffer) => {
                resolve({
                    contentType: 'application/octet-stream',
                    contentDisposition: 'attachment; filename=ig-package.zip',
                    content: buffer
                });
                return promiseHelper_1.emptydir(rootPath);
            })
                .then(() => {
                return promiseHelper_1.rmdir(rootPath);
            })
                .catch((err) => {
                ExportController.log.error(err);
                reject(err);
            });
        });
    }
}
ExportController.htmlExports = [];
exports.ExportController = ExportController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXhwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDJCQUEyQjtBQUMzQiw2QkFBNkI7QUFDN0Isc0NBQXNDO0FBQ3RDLGdDQUFnQztBQUNoQyx5Q0FBNEM7QUFFNUMsNkNBQTZEO0FBRzdELDZDQUFnRDtBQUNoRCxvREFBc0Q7QUFDdEQsOENBQXVDO0FBRXZDLDRDQUE0QztBQTRCNUMsSUFBSyxhQUdKO0FBSEQsV0FBSyxhQUFhO0lBQ2QsNkJBQVksQ0FBQTtJQUNaLDJCQUFVLENBQUE7QUFDZCxDQUFDLEVBSEksYUFBYSxLQUFiLGFBQWEsUUFHakI7QUFFRCxNQUFNLGFBQWE7SUFVZixZQUFZLEtBQVc7UUFSaEIsdUJBQWtCLEdBQUcsSUFBSSxDQUFDO1FBQzFCLHlCQUFvQixHQUFHLEtBQUssQ0FBQztRQUM3QixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLFdBQU0sR0FBcUcsTUFBTSxDQUFDO1FBQ2xILGlCQUFZLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQztRQUNwQywwQkFBcUIsR0FBRyxLQUFLLENBQUM7UUFHakMsSUFBSSxLQUFLLEVBQUU7WUFDUCxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUU7Z0JBQ2hCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQzthQUNsQztZQUVELElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFO2dCQUM1QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxLQUFLLE1BQU0sQ0FBQzthQUMvRTtZQUVELElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFO2dCQUM5QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsS0FBSyxDQUFDLG9CQUFvQixDQUFD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T0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLHFCQUFxQixFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUN2RCxNQUFNO1lBQ1Y7Z0JBQ0ksT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLHFDQUFxQyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUMzRjtJQUNMLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxTQUFpQjtRQUN2QyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ25DLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztZQUVsRCxtQkFBRyxDQUFDLFFBQVEsQ0FBQztpQkFDUixJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFDYixPQUFPLENBQUM7b0JBQ0osV0FBVyxFQUFFLDBCQUEwQjtvQkFDdkMsa0JBQWtCLEVBQUUscUNBQXFDO29CQUN6RCxPQUFPLEVBQUUsTUFBTTtpQkFDbEIsQ0FBQyxDQUFDO2dCQUVILE9BQU8sd0JBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QixDQUFDLENBQUM7aUJBQ0QsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDUCxPQUFPLHFCQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0IsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNYLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2hDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztRQUNYLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7QUF0TE0sNEJBQVcsR0FBRyxFQUFFLENBQUM7QUFENUIsNENBd0xDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0ICogYXMgdG1wIGZyb20gJ3RtcCc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCAqIGFzIHJwIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XHJcbmltcG9ydCB7SHRtbEV4cG9ydGVyfSBmcm9tICcuLi9leHBvcnQvaHRtbCc7XHJcbmltcG9ydCB7RXh0ZW5kZWRSZXF1ZXN0fSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCB7QmFzZUNvbnRyb2xsZXIsIEdlbmVyaWNSZXNwb25zZX0gZnJvbSAnLi9jb250cm9sbGVyJztcclxuaW1wb3J0IHtGaGlyfSBmcm9tICdmaGlyL2ZoaXInO1xyXG5pbXBvcnQge1NlcnZlcn0gZnJvbSAnc29ja2V0LmlvJztcclxuaW1wb3J0IHtCdW5kbGVFeHBvcnRlcn0gZnJvbSAnLi4vZXhwb3J0L2J1bmRsZSc7XHJcbmltcG9ydCB7ZW1wdHlkaXIsIHJtZGlyLCB6aXB9IGZyb20gJy4uL3Byb21pc2VIZWxwZXInO1xyXG5pbXBvcnQge2NoZWNrSnd0fSBmcm9tICcuLi9hdXRoSGVscGVyJztcclxuaW1wb3J0IHtSZXF1ZXN0SGFuZGxlcn0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCAqIGFzIEZoaXJIZWxwZXIgZnJvbSAnLi4vZmhpckhlbHBlcic7XHJcbmltcG9ydCB7QnVuZGxlLCBPcGVyYXRpb25PdXRjb21lfSBmcm9tICcuLi8uLi9zcmMvYXBwL21vZGVscy9zdHUzL2ZoaXInO1xyXG5pbXBvcnQge1NlcnZlclZhbGlkYXRpb25SZXN1bHR9IGZyb20gJy4uLy4uL3NyYy9hcHAvbW9kZWxzL3NlcnZlci12YWxpZGF0aW9uLXJlc3VsdCc7XHJcblxyXG5pbnRlcmZhY2UgRXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZVJlcXVlc3QgZXh0ZW5kcyBFeHRlbmRlZFJlcXVlc3Qge1xyXG4gICAgcGFyYW1zOiB7XHJcbiAgICAgICAgaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmc7XHJcbiAgICB9O1xyXG4gICAgcXVlcnk6IHtcclxuICAgICAgICBfZm9ybWF0Pzogc3RyaW5nO1xyXG4gICAgfTtcclxufVxyXG5cclxuaW50ZXJmYWNlIEdldEV4cG9ydGVkUGFja2FnZVJlcXVlc3QgZXh0ZW5kcyBFeHRlbmRlZFJlcXVlc3Qge1xyXG4gICAgcGFyYW1zOiB7XHJcbiAgICAgICAgcGFja2FnZUlkOiBzdHJpbmc7XHJcbiAgICB9O1xyXG4gICAgcXVlcnk6IHtcclxuICAgICAgICBzb2NrZXRJZD86IHN0cmluZztcclxuICAgIH07XHJcbn1cclxuXHJcbmludGVyZmFjZSBHZXRWYWxpZGF0aW9uUmVxdWVzdCBleHRlbmRzIEV4dGVuZGVkUmVxdWVzdCB7XHJcbiAgICBwYXJhbXM6IHtcclxuICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZztcclxuICAgIH07XHJcbn1cclxuXHJcbmVudW0gRXhwb3J0Rm9ybWF0cyB7XHJcbiAgICBCdW5kbGUgPSAnMScsXHJcbiAgICBIdG1sID0gJzInXHJcbn1cclxuXHJcbmNsYXNzIEV4cG9ydE9wdGlvbnMge1xyXG4gICAgcHVibGljIHNvY2tldElkPzogc3RyaW5nO1xyXG4gICAgcHVibGljIGV4ZWN1dGVJZ1B1Ymxpc2hlciA9IHRydWU7XHJcbiAgICBwdWJsaWMgdXNlVGVybWlub2xvZ3lTZXJ2ZXIgPSBmYWxzZTtcclxuICAgIHB1YmxpYyB1c2VMYXRlc3QgPSBmYWxzZTtcclxuICAgIHB1YmxpYyBkb3dubG9hZE91dHB1dCA9IHRydWU7XHJcbiAgICBwdWJsaWMgZm9ybWF0OiAnanNvbid8J3htbCd8J2FwcGxpY2F0aW9uL2pzb24nfCdhcHBsaWNhdGlvbi9maGlyK2pzb24nfCdhcHBsaWNhdGlvbi94bWwnfCdhcHBsaWNhdGlvbi9maGlyK3htbCcgPSAnanNvbic7XHJcbiAgICBwdWJsaWMgZXhwb3J0Rm9ybWF0ID0gRXhwb3J0Rm9ybWF0cy5CdW5kbGU7XHJcbiAgICBwdWJsaWMgaW5jbHVkZUlnUHVibGlzaGVySmFyID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IocXVlcnk/OiBhbnkpIHtcclxuICAgICAgICBpZiAocXVlcnkpIHtcclxuICAgICAgICAgICAgaWYgKHF1ZXJ5LnNvY2tldElkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNvY2tldElkID0gcXVlcnkuc29ja2V0SWQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnZXhlY3V0ZUlnUHVibGlzaGVyJykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXhlY3V0ZUlnUHVibGlzaGVyID0gcXVlcnkuZXhlY3V0ZUlnUHVibGlzaGVyLnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KCd1c2VUZXJtaW5vbG9neVNlcnZlcicpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVzZVRlcm1pbm9sb2d5U2VydmVyID0gcXVlcnkudXNlVGVybWlub2xvZ3lTZXJ2ZXIudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAocXVlcnkuaGFzT3duUHJvcGVydHkoJ3VzZUxhdGVzdCcpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVzZUxhdGVzdCA9IHF1ZXJ5LnVzZUxhdGVzdC50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnZG93bmxvYWRPdXRwdXQnKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZE91dHB1dCA9IHF1ZXJ5LmRvd25sb2FkT3V0cHV0LnRvTG93ZXJDYXNlID09PSAndHJ1ZSc7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnX2Zvcm1hdCcpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdCA9IHF1ZXJ5Ll9mb3JtYXQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChxdWVyeS5oYXNPd25Qcm9wZXJ0eSgnZXhwb3J0Rm9ybWF0JykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXhwb3J0Rm9ybWF0ID0gcXVlcnkuZXhwb3J0Rm9ybWF0O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAocXVlcnkuaGFzT3duUHJvcGVydHkoJ2luY2x1ZGVJZ1B1Ymxpc2hlckphcicpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmluY2x1ZGVJZ1B1Ymxpc2hlckphciA9IHF1ZXJ5LmluY2x1ZGVJZ1B1Ymxpc2hlckphci50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBFeHBvcnRDb250cm9sbGVyIGV4dGVuZHMgQmFzZUNvbnRyb2xsZXIge1xyXG4gICAgc3RhdGljIGh0bWxFeHBvcnRzID0gW107XHJcblxyXG4gICAgcmVhZG9ubHkgYmFzZVVybDogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZmhpclNlcnZlcklkOiBzdHJpbmc7XHJcbiAgICByZWFkb25seSBmaGlyVmVyc2lvbjogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZmhpcjogRmhpcjtcclxuICAgIHJlYWRvbmx5IGlvOiBTZXJ2ZXI7XHJcblxyXG4gICAgY29uc3RydWN0b3IoYmFzZVVybDogc3RyaW5nLCBmaGlyU2VydmVySWQ6IHN0cmluZywgZmhpclZlcnNpb246IHN0cmluZywgZmhpcjogRmhpciwgaW86IFNlcnZlcikge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5iYXNlVXJsID0gYmFzZVVybDtcclxuICAgICAgICB0aGlzLmZoaXJTZXJ2ZXJJZCA9IGZoaXJTZXJ2ZXJJZDtcclxuICAgICAgICB0aGlzLmZoaXJWZXJzaW9uID0gZmhpclZlcnNpb247XHJcbiAgICAgICAgdGhpcy5maGlyID0gZmhpcjtcclxuICAgICAgICB0aGlzLmlvID0gaW87XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBpbml0Um91dGVzKCkge1xyXG4gICAgICAgIGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcblxyXG4gICAgICAgIHJvdXRlci5wb3N0KCcvOmltcGxlbWVudGF0aW9uR3VpZGVJZCcsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogRXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZVJlcXVlc3QsIHJlcykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEV4cG9ydENvbnRyb2xsZXIocmVxLmZoaXJTZXJ2ZXJCYXNlLCByZXEuaGVhZGVycy5maGlyc2VydmVyLCByZXEuZmhpclNlcnZlclZlcnNpb24sIHJlcS5maGlyLCByZXEuaW8pO1xyXG4gICAgICAgICAgICBjb250cm9sbGVyLmV4cG9ydEltcGxlbWVudGF0aW9uR3VpZGUocmVxLnBhcmFtcy5pbXBsZW1lbnRhdGlvbkd1aWRlSWQsIG5ldyBFeHBvcnRPcHRpb25zKHJlcS5xdWVyeSkpXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0czogR2VuZXJpY1Jlc3BvbnNlKSA9PiB0aGlzLmhhbmRsZVJlc3BvbnNlKHJlcywgcmVzdWx0cykpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gRXhwb3J0Q29udHJvbGxlci5oYW5kbGVFcnJvcihlcnIsIG51bGwsIHJlcykpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByb3V0ZXIuZ2V0KCcvOnBhY2thZ2VJZCcsIDxSZXF1ZXN0SGFuZGxlcj4gKHJlcTogR2V0RXhwb3J0ZWRQYWNrYWdlUmVxdWVzdCwgcmVzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgRXhwb3J0Q29udHJvbGxlcihyZXEuZmhpclNlcnZlckJhc2UsIHJlcS5oZWFkZXJzLmZoaXJzZXJ2ZXIsIHJlcS5maGlyU2VydmVyVmVyc2lvbiwgcmVxLmZoaXIsIHJlcS5pbyk7XHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZ2V0RXhwb3J0ZWRQYWNrYWdlKHJlcS5wYXJhbXMucGFja2FnZUlkKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHM6IEdlbmVyaWNSZXNwb25zZSkgPT4gdGhpcy5oYW5kbGVSZXNwb25zZShyZXMsIHJlc3VsdHMpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IEV4cG9ydENvbnRyb2xsZXIuaGFuZGxlRXJyb3IoZXJyLCBudWxsLCByZXMpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcm91dGVyLmdldCgnLzppbXBsZW1lbnRhdGlvbkd1aWRlSWQvKFskXSl2YWxpZGF0ZScsIDxSZXF1ZXN0SGFuZGxlcj4gY2hlY2tKd3QsIChyZXE6IEdldFZhbGlkYXRpb25SZXF1ZXN0LCByZXMpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBFeHBvcnRDb250cm9sbGVyKHJlcS5maGlyU2VydmVyQmFzZSwgcmVxLmhlYWRlcnMuZmhpcnNlcnZlciwgcmVxLmZoaXJTZXJ2ZXJWZXJzaW9uLCByZXEuZmhpciwgcmVxLmlvKTtcclxuICAgICAgICAgICAgY29udHJvbGxlci52YWxpZGF0ZShyZXEucGFyYW1zLmltcGxlbWVudGF0aW9uR3VpZGVJZClcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiByZXMuc2VuZChyZXN1bHRzKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBFeHBvcnRDb250cm9sbGVyLmhhbmRsZUVycm9yKGVyciwgbnVsbCwgcmVzKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByb3V0ZXI7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHZhbGlkYXRlKGltcGxlbWVudGF0aW9uR3VpZGVJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgYnVuZGxlRXhwb3J0ZXIgPSBuZXcgQnVuZGxlRXhwb3J0ZXIodGhpcy5iYXNlVXJsLCB0aGlzLmZoaXJTZXJ2ZXJJZCwgdGhpcy5maGlyVmVyc2lvbiwgdGhpcy5maGlyLCBpbXBsZW1lbnRhdGlvbkd1aWRlSWQpO1xyXG4gICAgICAgICAgICBsZXQgdmFsaWRhdGlvblJlcXVlc3RzID0gW107XHJcblxyXG4gICAgICAgICAgICBidW5kbGVFeHBvcnRlci5nZXRCdW5kbGUodHJ1ZSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzOiBCdW5kbGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uUmVxdWVzdHMgPSBfLm1hcChyZXN1bHRzLmVudHJ5LCAoZW50cnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogRmhpckhlbHBlci5idWlsZFVybCh0aGlzLmJhc2VVcmwsIGVudHJ5LnJlc291cmNlLnJlc291cmNlVHlwZSwgbnVsbCwgJyR2YWxpZGF0ZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5OiBlbnRyeS5yZXNvdXJjZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb246IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW1wbGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlUmVmZXJlbmNlOiBgJHtlbnRyeS5yZXNvdXJjZS5yZXNvdXJjZVR5cGV9LyR7ZW50cnkucmVzb3VyY2UuaWR9YCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2U6IHJwKG9wdGlvbnMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBfLm1hcCh2YWxpZGF0aW9uUmVxdWVzdHMsICh2YWxpZGF0aW9uUmVxdWVzdCkgPT4gdmFsaWRhdGlvblJlcXVlc3QucHJvbWlzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0U2V0czogT3BlcmF0aW9uT3V0Y29tZVtdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHZhbGlkYXRpb25SZXN1bHRzOiBTZXJ2ZXJWYWxpZGF0aW9uUmVzdWx0W10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHJlc3VsdFNldHMsIChyZXN1bHRTZXQ6IGFueSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdFNldC5ib2R5ICYmIHJlc3VsdFNldC5ib2R5LnJlc291cmNlVHlwZSA9PT0gJ09wZXJhdGlvbk91dGNvbWUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvbyA9IDxPcGVyYXRpb25PdXRjb21lPiByZXN1bHRTZXQuYm9keTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHQgPSBfLm1hcChvby5pc3N1ZSwgKGlzc3VlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDxTZXJ2ZXJWYWxpZGF0aW9uUmVzdWx0PntcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VSZWZlcmVuY2U6IHZhbGlkYXRpb25SZXF1ZXN0c1tpbmRleF0ucmVzb3VyY2VSZWZlcmVuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldmVyaXR5OiBpc3N1ZS5zZXZlcml0eSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsczogaXNzdWUuZGlhZ25vc3RpY3NcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvblJlc3VsdHMgPSB2YWxpZGF0aW9uUmVzdWx0cy5jb25jYXQobmV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvblJlc3VsdHMgPSBfLnNvcnRCeSh2YWxpZGF0aW9uUmVzdWx0cywgKHZhbGlkYXRpb25SZXN1bHQpID0+IHZhbGlkYXRpb25SZXN1bHQuc2V2ZXJpdHkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHZhbGlkYXRpb25SZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIuc3RhdHVzQ29kZSA9PT0gNDEyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZXJyLmVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGV4cG9ydEJ1bmRsZShpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZywgZm9ybWF0OiAnanNvbid8J3htbCd8J2FwcGxpY2F0aW9uL2pzb24nfCdhcHBsaWNhdGlvbi9maGlyK2pzb24nfCdhcHBsaWNhdGlvbi94bWwnfCdhcHBsaWNhdGlvbi9maGlyK3htbCcgPSAnanNvbicpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEJ1bmRsZUV4cG9ydGVyKHRoaXMuYmFzZVVybCwgdGhpcy5maGlyU2VydmVySWQsIHRoaXMuZmhpclZlcnNpb24sIHRoaXMuZmhpciwgaW1wbGVtZW50YXRpb25HdWlkZUlkKTtcclxuICAgICAgICAgICAgZXhwb3J0ZXIuZXhwb3J0KGZvcm1hdClcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlRXh0ID0gJy5qc29uJztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdCAmJiBmb3JtYXQgPT09ICdhcHBsaWNhdGlvbi94bWwnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVFeHQgPSAnLnhtbCc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50RGlzcG9zaXRpb246ICdhdHRhY2htZW50OyBmaWxlbmFtZT1pZy1idW5kbGUnICsgZmlsZUV4dCwgICAgICAvLyBUT0RPOiBEZXRlcm1pbmUgZmlsZSBuYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHJlc3BvbnNlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGV4cG9ydEh0bWwoaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmcsIG9wdGlvbnM6IEV4cG9ydE9wdGlvbnMpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVyID0gbmV3IEh0bWxFeHBvcnRlcih0aGlzLmJhc2VVcmwsIHRoaXMuZmhpclNlcnZlcklkLCB0aGlzLmZoaXJWZXJzaW9uLCB0aGlzLmZoaXIsIHRoaXMuaW8sIG9wdGlvbnMuc29ja2V0SWQsIGltcGxlbWVudGF0aW9uR3VpZGVJZCk7XHJcblxyXG4gICAgICAgICAgICBFeHBvcnRDb250cm9sbGVyLmh0bWxFeHBvcnRzLnB1c2goZXhwb3J0ZXIpO1xyXG5cclxuICAgICAgICAgICAgZXhwb3J0ZXIuZXhwb3J0KG9wdGlvbnMuZm9ybWF0LCBvcHRpb25zLmV4ZWN1dGVJZ1B1Ymxpc2hlciwgb3B0aW9ucy51c2VUZXJtaW5vbG9neVNlcnZlciwgb3B0aW9ucy51c2VMYXRlc3QsIG9wdGlvbnMuZG93bmxvYWRPdXRwdXQsIG9wdGlvbnMuaW5jbHVkZUlnUHVibGlzaGVySmFyKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHJlc3BvbnNlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFNob3VsZCBiZSBtb3ZlZCB0byBhIC5maW5hbGx5KCkgYmxvY2sgd2hlbiBtb3ZpbmcgdG8gRVMyMDE4XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBFeHBvcnRDb250cm9sbGVyLmh0bWxFeHBvcnRzLmluZGV4T2YoZXhwb3J0ZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIEV4cG9ydENvbnRyb2xsZXIuaHRtbEV4cG9ydHMuc3BsaWNlKGluZGV4KTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBTaG91bGQgYmUgbW92ZWQgdG8gYSAuZmluYWxseSgpIGJsb2NrIHdoZW4gbW92aW5nIHRvIEVTMjAxOFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gRXhwb3J0Q29udHJvbGxlci5odG1sRXhwb3J0cy5pbmRleE9mKGV4cG9ydGVyKTtcclxuICAgICAgICAgICAgICAgICAgICBFeHBvcnRDb250cm9sbGVyLmh0bWxFeHBvcnRzLnNwbGljZShpbmRleCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZXhwb3J0SW1wbGVtZW50YXRpb25HdWlkZShpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZywgb3B0aW9uczogRXhwb3J0T3B0aW9ucyk6IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPiB7XHJcbiAgICAgICAgc3dpdGNoIChvcHRpb25zLmV4cG9ydEZvcm1hdCkge1xyXG4gICAgICAgICAgICBjYXNlIEV4cG9ydEZvcm1hdHMuQnVuZGxlOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0QnVuZGxlKGltcGxlbWVudGF0aW9uR3VpZGVJZCwgb3B0aW9ucy5mb3JtYXQpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgRXhwb3J0Rm9ybWF0cy5IdG1sOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0SHRtbChpbXBsZW1lbnRhdGlvbkd1aWRlSWQsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ1VuZXhwZWN0ZWQgZXhwb3J0IGZvcm1hdCBzZWxlY3RlZDogJyArIG9wdGlvbnMuZXhwb3J0Rm9ybWF0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEV4cG9ydGVkUGFja2FnZShwYWNrYWdlSWQ6IHN0cmluZyk6IFByb21pc2U8R2VuZXJpY1Jlc3BvbnNlPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgcm9vdFBhdGggPSBwYXRoLmpvaW4odG1wLnRtcGRpciwgcGFja2FnZUlkKTtcclxuXHJcbiAgICAgICAgICAgIHppcChyb290UGF0aClcclxuICAgICAgICAgICAgICAgIC50aGVuKChidWZmZXIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50RGlzcG9zaXRpb246ICdhdHRhY2htZW50OyBmaWxlbmFtZT1pZy1wYWNrYWdlLnppcCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGJ1ZmZlclxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW1wdHlkaXIocm9vdFBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcm1kaXIocm9vdFBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgRXhwb3J0Q29udHJvbGxlci5sb2cuZXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59Il19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("underscore");
const rp = require("request-promise");
const FhirHelper = require("../fhirHelper");
const log4js = require("log4js");
const config = require("config");
const globals_1 = require("../../src/app/globals");
class BundleExporter {
    constructor(fhirServerBase, fhirServerId, fhirVersion, fhir, implementationGuideId) {
        this.log = log4js.getLogger();
        this.fhirServerBase = fhirServerBase;
        this.fhirServerId = fhirServerId;
        this.fhirVersion = fhirVersion;
        this.fhir = fhir;
        this.implementationGuideId = implementationGuideId;
        this.fhirConfig = config.get('fhir');
    }
    static removeExtensions(object, clone = true) {
        if (clone) {
            object = JSON.parse(JSON.stringify(object));
        }
        if (object) {
            const extensionUrls = _.map(new globals_1.Globals().extensionUrls, (extUrl) => extUrl);
            const keys = _.allKeys(object);
            _.each(keys, (key) => {
                if (key === 'extension') {
                    const extensions = object[key];
                    const removeExtensions = _.filter(extensions, (extension) => extensionUrls.indexOf(extension.url) >= 0);
                    // Remove any extensions from the resource that are for Trifolia
                    _.each(removeExtensions, (removeExtension) => {
                        const index = extensions.indexOf(removeExtension);
                        extensions.splice(index, 1);
                    });
                }
                else if (typeof object[key] === 'object') {
                    this.removeExtensions(object[key], false);
                }
            });
        }
        return object;
    }
    _getStu3Resources(implementationGuide) {
        const promises = [];
        _.each(implementationGuide.package, (igPackage) => {
            const references = _.chain(igPackage.resource)
                .filter((resource) => !!resource.sourceReference && !!resource.sourceReference.reference)
                .map((resource) => resource.sourceReference.reference)
                .value();
            _.each(references, (reference) => {
                const parsed = FhirHelper.parseUrl(reference);
                const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
                const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
                promises.push(resourcePromise);
            });
        });
        return Promise.all(promises);
    }
    _getR4Resources(implementationGuide) {
        if (!implementationGuide.definition) {
            return Promise.resolve([]);
        }
        const promises = _.chain(implementationGuide.definition.resource)
            .filter((resource) => !!resource.reference && !!resource.reference.reference)
            .map((resource) => {
            const reference = resource.reference.reference;
            const parsed = FhirHelper.parseUrl(reference);
            const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
            const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
            return resourcePromise;
        })
            .value();
        return Promise.all(promises);
    }
    getBundle(removeExtensions = false) {
        return new Promise((resolve, reject) => {
            const igUrl = FhirHelper.buildUrl(this.fhirServerBase, 'ImplementationGuide', this.implementationGuideId);
            const fhirServerConfig = _.find(this.fhirConfig.servers, (serverConfig) => {
                return serverConfig.id === this.fhirServerId;
            });
            let implementationGuide;
            let implementationGuideFullUrl;
            rp({ url: igUrl, json: true, resolveWithFullResponse: true })
                .then((response) => {
                implementationGuide = response.body;
                implementationGuideFullUrl = response.headers['content-location'];
                if (fhirServerConfig.version === 'stu3') {
                    return this._getStu3Resources(implementationGuide);
                }
                return this._getR4Resources(implementationGuide);
            })
                .then((responses) => {
                const resourceEntries = _.chain(responses)
                    .filter((response) => {
                    return !!response.body && !!response.body.resourceType;
                })
                    .map((response) => {
                    let fullUrl = response.headers['content-location'];
                    if (!fullUrl) {
                        fullUrl = FhirHelper.joinUrl(this.fhirServerBase, response.body.resourceType, response.body.id);
                        if (response.body.meta && response.body.meta.versionId) {
                            fullUrl = FhirHelper.joinUrl(fullUrl, '_history', response.body.meta.versionId);
                        }
                    }
                    return {
                        fullUrl: fullUrl,
                        resource: response.body
                    };
                })
                    .value();
                if (responses.length !== resourceEntries.length) {
                    this.log.error(`Expected ${responses.length} entries in the export bundle, but only returning ${resourceEntries.length}. Some resources could not be returned in the bundle due to the response from the server.`);
                }
                const bundle = {
                    resourceType: 'Bundle',
                    type: 'collection',
                    total: resourceEntries.length + 1,
                    entry: [{ fullUrl: implementationGuideFullUrl, resource: implementationGuide }].concat(resourceEntries)
                };
                if (removeExtensions) {
                    BundleExporter.removeExtensions(bundle, false);
                }
                resolve(bundle);
            })
                .catch((err) => {
                if (err && err.response && err.response.body) {
                    const errBody = err.response.body;
                    const issueTexts = _.map(errBody.issue, (issue) => issue.diagnostics);
                    if (issueTexts.length > 0) {
                        reject(issueTexts.join(' & '));
                    }
                    else if (errBody.text && errBody.text.div) {
                        reject(errBody.text.div);
                    }
                    else {
                        this.log.error(errBody);
                        reject('Unknown error returned by FHIR server when getting resources for implementation guide');
                    }
                }
                else {
                    this.log.error(err);
                    reject(err);
                }
            });
        });
    }
    export(format = 'json', removeExtensions = false) {
        return new Promise((resolve, reject) => {
            this.getBundle(removeExtensions)
                .then((results) => {
                let response = results;
                if (format === 'xml' || format === 'application/xml') {
                    response = this.fhir.objToXml(results);
                }
                resolve(response);
            })
                .catch((err) => {
                reject(err);
            });
        });
    }
}
exports.BundleExporter = BundleExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVuZGxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsZ0NBQWdDO0FBQ2hDLHNDQUFzQztBQUN0Qyw0Q0FBNEM7QUFDNUMsaUNBQWlDO0FBQ2pDLGlDQUFpQztBQUVqQyxtREFBOEM7QUFHOUMsTUFBYSxjQUFjO0lBVXZCLFlBQVksY0FBc0IsRUFBRSxZQUFvQixFQUFFLFdBQW1CLEVBQUUsSUFBVSxFQUFFLHFCQUE2QjtRQVQvRyxRQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBVTlCLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxxQkFBcUIsQ0FBQztRQUNuRCxJQUFJLENBQUMsVUFBVSxHQUFnQixNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFTSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBVyxFQUFFLEtBQUssR0FBRyxJQUFJO1FBQ3BELElBQUksS0FBSyxFQUFFO1lBQ1AsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQy9DO1FBRUQsSUFBSSxNQUFNLEVBQUU7WUFDUixNQUFNLGFBQWEsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksaUJBQU8sRUFBRSxDQUFDLGFBQWEsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDN0UsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUvQixDQUFD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QUMsT0FBTyxDQUFDLENBQUM7aUJBQzFDO2dCQUVELE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QixDQUFDLENBQUM7aUJBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ1gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ1gsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUF4TEQsd0NBd0xDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGaGlyfSBmcm9tICdmaGlyL2ZoaXInO1xyXG5pbXBvcnQge0J1bmRsZSwgSW1wbGVtZW50YXRpb25HdWlkZSBhcyBTVFUzSW1wbGVtZW50YXRpb25HdWlkZSwgT3BlcmF0aW9uT3V0Y29tZX0gZnJvbSAnLi4vLi4vc3JjL2FwcC9tb2RlbHMvc3R1My9maGlyJztcclxuaW1wb3J0IHtJbXBsZW1lbnRhdGlvbkd1aWRlIGFzIFI0SW1wbGVtZW50YXRpb25HdWlkZX0gZnJvbSAnLi4vLi4vc3JjL2FwcC9tb2RlbHMvcjQvZmhpcic7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XHJcbmltcG9ydCAqIGFzIHJwIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XHJcbmltcG9ydCAqIGFzIEZoaXJIZWxwZXIgZnJvbSAnLi4vZmhpckhlbHBlcic7XHJcbmltcG9ydCAqIGFzIGxvZzRqcyBmcm9tICdsb2c0anMnO1xyXG5pbXBvcnQgKiBhcyBjb25maWcgZnJvbSAnY29uZmlnJztcclxuaW1wb3J0IHtGaGlyIGFzIEZoaXJNb2RlbCwgRmhpckNvbmZpZ30gZnJvbSAnLi4vY29udHJvbGxlcnMvbW9kZWxzJztcclxuaW1wb3J0IHtHbG9iYWxzfSBmcm9tICcuLi8uLi9zcmMvYXBwL2dsb2JhbHMnO1xyXG5pbXBvcnQgRXh0ZW5zaW9uID0gRmhpck1vZGVsLkV4dGVuc2lvbjtcclxuXHJcbmV4cG9ydCBjbGFzcyBCdW5kbGVFeHBvcnRlciB7XHJcbiAgICByZWFkb25seSBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCk7XHJcbiAgICByZWFkb25seSBmaGlyU2VydmVyQmFzZTogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZmhpclNlcnZlcklkOiBzdHJpbmc7XHJcbiAgICByZWFkb25seSBmaGlyVmVyc2lvbjogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZmhpcjogRmhpcjtcclxuICAgIHJlYWRvbmx5IGltcGxlbWVudGF0aW9uR3VpZGVJZDogc3RyaW5nO1xyXG5cclxuICAgIHB1YmxpYyBmaGlyQ29uZmlnOiBGaGlyQ29uZmlnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGZoaXJTZXJ2ZXJCYXNlOiBzdHJpbmcsIGZoaXJTZXJ2ZXJJZDogc3RyaW5nLCBmaGlyVmVyc2lvbjogc3RyaW5nLCBmaGlyOiBGaGlyLCBpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuZmhpclNlcnZlckJhc2UgPSBmaGlyU2VydmVyQmFzZTtcclxuICAgICAgICB0aGlzLmZoaXJTZXJ2ZXJJZCA9IGZoaXJTZXJ2ZXJJZDtcclxuICAgICAgICB0aGlzLmZoaXJWZXJzaW9uID0gZmhpclZlcnNpb247XHJcbiAgICAgICAgdGhpcy5maGlyID0gZmhpcjtcclxuICAgICAgICB0aGlzLmltcGxlbWVudGF0aW9uR3VpZGVJZCA9IGltcGxlbWVudGF0aW9uR3VpZGVJZDtcclxuICAgICAgICB0aGlzLmZoaXJDb25maWcgPSA8RmhpckNvbmZpZz4gY29uZmlnLmdldCgnZmhpcicpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgcmVtb3ZlRXh0ZW5zaW9ucyhvYmplY3Q6IGFueSwgY2xvbmUgPSB0cnVlKSB7XHJcbiAgICAgICAgaWYgKGNsb25lKSB7XHJcbiAgICAgICAgICAgIG9iamVjdCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqZWN0KSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAob2JqZWN0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4dGVuc2lvblVybHMgPSBfLm1hcChuZXcgR2xvYmFscygpLmV4dGVuc2lvblVybHMsIChleHRVcmwpID0+IGV4dFVybCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBfLmFsbEtleXMob2JqZWN0KTtcclxuXHJcbiAgICAgICAgICAgIF8uZWFjaChrZXlzLCAoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnZXh0ZW5zaW9uJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4dGVuc2lvbnM6IEV4dGVuc2lvbltdID0gb2JqZWN0W2tleV07XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlRXh0ZW5zaW9ucyA9IF8uZmlsdGVyKGV4dGVuc2lvbnMsIChleHRlbnNpb24pID0+IGV4dGVuc2lvblVybHMuaW5kZXhPZihleHRlbnNpb24udXJsKSA+PSAwKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFueSBleHRlbnNpb25zIGZyb20gdGhlIHJlc291cmNlIHRoYXQgYXJlIGZvciBUcmlmb2xpYVxyXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChyZW1vdmVFeHRlbnNpb25zLCAocmVtb3ZlRXh0ZW5zaW9uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gZXh0ZW5zaW9ucy5pbmRleE9mKHJlbW92ZUV4dGVuc2lvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iamVjdFtrZXldID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRXh0ZW5zaW9ucyhvYmplY3Rba2V5XSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBvYmplY3Q7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZ2V0U3R1M1Jlc291cmNlcyhpbXBsZW1lbnRhdGlvbkd1aWRlOiBTVFUzSW1wbGVtZW50YXRpb25HdWlkZSkge1xyXG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gW107XHJcblxyXG4gICAgICAgIF8uZWFjaChpbXBsZW1lbnRhdGlvbkd1aWRlLnBhY2thZ2UsIChpZ1BhY2thZ2UpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcmVmZXJlbmNlcyA9IF8uY2hhaW4oaWdQYWNrYWdlLnJlc291cmNlKVxyXG4gICAgICAgICAgICAgICAgLmZpbHRlcigocmVzb3VyY2UpID0+ICEhcmVzb3VyY2Uuc291cmNlUmVmZXJlbmNlICYmICEhcmVzb3VyY2Uuc291cmNlUmVmZXJlbmNlLnJlZmVyZW5jZSlcclxuICAgICAgICAgICAgICAgIC5tYXAoKHJlc291cmNlKSA9PiByZXNvdXJjZS5zb3VyY2VSZWZlcmVuY2UucmVmZXJlbmNlKVxyXG4gICAgICAgICAgICAgICAgLnZhbHVlKCk7XHJcblxyXG4gICAgICAgICAgICBfLmVhY2gocmVmZXJlbmNlcywgKHJlZmVyZW5jZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gRmhpckhlbHBlci5wYXJzZVVybChyZWZlcmVuY2UpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VVcmwgPSBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuZmhpclNlcnZlckJhc2UsIHBhcnNlZC5yZXNvdXJjZVR5cGUsIHBhcnNlZC5pZCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZVByb21pc2UgPSBycCh7IHVybDogcmVzb3VyY2VVcmwsIGpzb246IHRydWUsIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaChyZXNvdXJjZVByb21pc2UpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9nZXRSNFJlc291cmNlcyhpbXBsZW1lbnRhdGlvbkd1aWRlOiBSNEltcGxlbWVudGF0aW9uR3VpZGUpIHtcclxuICAgICAgICBpZiAoIWltcGxlbWVudGF0aW9uR3VpZGUuZGVmaW5pdGlvbikge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gXy5jaGFpbihpbXBsZW1lbnRhdGlvbkd1aWRlLmRlZmluaXRpb24ucmVzb3VyY2UpXHJcbiAgICAgICAgICAgIC5maWx0ZXIoKHJlc291cmNlKSA9PiAhIXJlc291cmNlLnJlZmVyZW5jZSAmJiAhIXJlc291cmNlLnJlZmVyZW5jZS5yZWZlcmVuY2UpXHJcbiAgICAgICAgICAgIC5tYXAoKHJlc291cmNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZWZlcmVuY2UgPSByZXNvdXJjZS5yZWZlcmVuY2UucmVmZXJlbmNlO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gRmhpckhlbHBlci5wYXJzZVVybChyZWZlcmVuY2UpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VVcmwgPSBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuZmhpclNlcnZlckJhc2UsIHBhcnNlZC5yZXNvdXJjZVR5cGUsIHBhcnNlZC5pZCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZVByb21pc2UgPSBycCh7IHVybDogcmVzb3VyY2VVcmwsIGpzb246IHRydWUsIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc291cmNlUHJvbWlzZTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnZhbHVlKCk7XHJcblxyXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEJ1bmRsZShyZW1vdmVFeHRlbnNpb25zID0gZmFsc2UpOiBQcm9taXNlPEJ1bmRsZT4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlnVXJsID0gRmhpckhlbHBlci5idWlsZFVybCh0aGlzLmZoaXJTZXJ2ZXJCYXNlLCAnSW1wbGVtZW50YXRpb25HdWlkZScsIHRoaXMuaW1wbGVtZW50YXRpb25HdWlkZUlkKTtcclxuICAgICAgICAgICAgY29uc3QgZmhpclNlcnZlckNvbmZpZyA9IF8uZmluZCh0aGlzLmZoaXJDb25maWcuc2VydmVycywgKHNlcnZlckNvbmZpZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZlckNvbmZpZy5pZCA9PT0gdGhpcy5maGlyU2VydmVySWQ7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBsZXQgaW1wbGVtZW50YXRpb25HdWlkZTtcclxuICAgICAgICAgICAgbGV0IGltcGxlbWVudGF0aW9uR3VpZGVGdWxsVXJsO1xyXG5cclxuICAgICAgICAgICAgcnAoeyB1cmw6IGlnVXJsLCBqc29uOiB0cnVlLCByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW1wbGVtZW50YXRpb25HdWlkZSA9IHJlc3BvbnNlLmJvZHk7XHJcbiAgICAgICAgICAgICAgICAgICAgaW1wbGVtZW50YXRpb25HdWlkZUZ1bGxVcmwgPSByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LWxvY2F0aW9uJ107XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaGlyU2VydmVyQ29uZmlnLnZlcnNpb24gPT09ICdzdHUzJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0U3R1M1Jlc291cmNlcyhpbXBsZW1lbnRhdGlvbkd1aWRlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRSNFJlc291cmNlcyhpbXBsZW1lbnRhdGlvbkd1aWRlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2VzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VFbnRyaWVzID0gXy5jaGFpbihyZXNwb25zZXMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gISFyZXNwb25zZS5ib2R5ICYmICEhcmVzcG9uc2UuYm9keS5yZXNvdXJjZVR5cGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZnVsbFVybCA9IHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbG9jYXRpb24nXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZ1bGxVcmwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsVXJsID0gRmhpckhlbHBlci5qb2luVXJsKHRoaXMuZmhpclNlcnZlckJhc2UsIHJlc3BvbnNlLmJvZHkucmVzb3VyY2VUeXBlLCByZXNwb25zZS5ib2R5LmlkKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmJvZHkubWV0YSAmJiByZXNwb25zZS5ib2R5Lm1ldGEudmVyc2lvbklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxVcmwgPSBGaGlySGVscGVyLmpvaW5VcmwoZnVsbFVybCwgJ19oaXN0b3J5JywgcmVzcG9uc2UuYm9keS5tZXRhLnZlcnNpb25JZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFVybDogZnVsbFVybCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZTogcmVzcG9uc2UuYm9keVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZXMubGVuZ3RoICE9PSByZXNvdXJjZUVudHJpZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGBFeHBlY3RlZCAke3Jlc3BvbnNlcy5sZW5ndGh9IGVudHJpZXMgaW4gdGhlIGV4cG9ydCBidW5kbGUsIGJ1dCBvbmx5IHJldHVybmluZyAke3Jlc291cmNlRW50cmllcy5sZW5ndGh9LiBTb21lIHJlc291cmNlcyBjb3VsZCBub3QgYmUgcmV0dXJuZWQgaW4gdGhlIGJ1bmRsZSBkdWUgdG8gdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlci5gKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ1bmRsZSA9IDxCdW5kbGU+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VUeXBlOiAnQnVuZGxlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2NvbGxlY3Rpb24nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogcmVzb3VyY2VFbnRyaWVzLmxlbmd0aCArIDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5OiBbeyBmdWxsVXJsOiBpbXBsZW1lbnRhdGlvbkd1aWRlRnVsbFVybCwgcmVzb3VyY2U6IGltcGxlbWVudGF0aW9uR3VpZGUgfV0uY29uY2F0KHJlc291cmNlRW50cmllcylcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlRXh0ZW5zaW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBCdW5kbGVFeHBvcnRlci5yZW1vdmVFeHRlbnNpb25zKGJ1bmRsZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShidW5kbGUpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVyciAmJiBlcnIucmVzcG9uc2UgJiYgZXJyLnJlc3BvbnNlLmJvZHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyQm9keSA9IDxPcGVyYXRpb25PdXRjb21lPiBlcnIucmVzcG9uc2UuYm9keTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNzdWVUZXh0cyA9IF8ubWFwKGVyckJvZHkuaXNzdWUsIChpc3N1ZSkgPT4gaXNzdWUuZGlhZ25vc3RpY3MpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzc3VlVGV4dHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGlzc3VlVGV4dHMuam9pbignICYgJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVyckJvZHkudGV4dCAmJiBlcnJCb2R5LnRleHQuZGl2KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyQm9keS50ZXh0LmRpdik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihlcnJCb2R5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCgnVW5rbm93biBlcnJvciByZXR1cm5lZCBieSBGSElSIHNlcnZlciB3aGVuIGdldHRpbmcgcmVzb3VyY2VzIGZvciBpbXBsZW1lbnRhdGlvbiBndWlkZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGV4cG9ydChmb3JtYXQ6ICdqc29uJ3wneG1sJ3wnYXBwbGljYXRpb24vanNvbid8J2FwcGxpY2F0aW9uL2ZoaXIranNvbid8J2FwcGxpY2F0aW9uL3htbCd8J2FwcGxpY2F0aW9uL2ZoaXIreG1sJyA9ICdqc29uJywgcmVtb3ZlRXh0ZW5zaW9ucyA9IGZhbHNlKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5nZXRCdW5kbGUocmVtb3ZlRXh0ZW5zaW9ucylcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlOiBCdW5kbGUgfCBzdHJpbmcgPSByZXN1bHRzO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0ID09PSAneG1sJyB8fCBmb3JtYXQgPT09ICdhcHBsaWNhdGlvbi94bWwnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5maGlyLm9ialRvWG1sKHJlc3VsdHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59Il19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("underscore");
const rp = require("request-promise");
const FhirHelper = require("../fhirHelper");
const log4js = require("log4js");
const config = require("config");
class BundleExporter {
    constructor(fhirServerBase, fhirServerId, fhir, implementationGuideId) {
        this.log = log4js.getLogger();
        this.fhirServerBase = fhirServerBase;
        this.fhirServerId = fhirServerId;
        this.fhir = fhir;
        this.implementationGuideId = implementationGuideId;
        this.fhirConfig = config.get('fhir');
    }
    _getStu3Resources(implementationGuide) {
        const promises = [];
        _.each(implementationGuide.package, (igPackage) => {
            const references = _.chain(igPackage.resource)
                .filter((resource) => !!resource.sourceReference && !!resource.sourceReference.reference)
                .map((resource) => resource.sourceReference.reference)
                .value();
            _.each(references, (reference) => {
                const parsed = FhirHelper.parseUrl(reference);
                const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
                const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
                promises.push(resourcePromise);
            });
        });
        return Promise.all(promises);
    }
    _getR4Resources(implementationGuide) {
        if (!implementationGuide.definition) {
            return Promise.resolve([]);
        }
        const promises = _.chain(implementationGuide.definition.resource)
            .filter((resource) => !!resource.reference && !!resource.reference.reference)
            .map((resource) => {
            const reference = resource.reference.reference;
            const parsed = FhirHelper.parseUrl(reference);
            const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
            const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
            return resourcePromise;
        })
            .value();
        return Promise.all(promises);
    }
    getBundle() {
        return new Promise((resolve, reject) => {
            const igUrl = FhirHelper.buildUrl(this.fhirServerBase, 'ImplementationGuide', this.implementationGuideId);
            const fhirServerConfig = _.find(this.fhirConfig.servers, (serverConfig) => {
                return serverConfig.id === this.fhirServerId;
            });
            let implementationGuide;
            let implementationGuideFullUrl;
            rp({ url: igUrl, json: true, resolveWithFullResponse: true })
                .then((response) => {
                implementationGuide = response.body;
                implementationGuideFullUrl = response.headers['content-location'];
                if (fhirServerConfig.version === 'stu3') {
                    return this._getStu3Resources(implementationGuide);
                }
                return this._getR4Resources(implementationGuide);
            })
                .then((responses) => {
                const resourceEntries = _.chain(responses)
                    .filter((response) => {
                    return !!response.body && !!response.body.resourceType;
                })
                    .map((response) => {
                    let fullUrl = response.headers['content-location'];
                    if (!fullUrl) {
                        fullUrl = FhirHelper.joinUrl(this.fhirServerBase, response.body.resourceType, response.body.id);
                        if (response.body.meta && response.body.meta.versionId) {
                            fullUrl = FhirHelper.joinUrl(fullUrl, '_history', response.body.meta.versionId);
                        }
                    }
                    return {
                        fullUrl: fullUrl,
                        resource: response.body
                    };
                })
                    .value();
                if (responses.length !== resourceEntries.length) {
                    this.log.error(`Expected ${responses.length} entries in the export bundle, but only returning ${resourceEntries.length}. Some resources could not be returned in the bundle due to the response from the server.`);
                }
                const bundle = {
                    resourceType: 'Bundle',
                    type: 'collection',
                    total: resourceEntries.length + 1,
                    entry: [{ fullUrl: implementationGuideFullUrl, resource: implementationGuide }].concat(resourceEntries)
                };
                resolve(bundle);
            })
                .catch((err) => {
                if (err && err.response && err.response.body) {
                    const errBody = err.response.body;
                    const issueTexts = _.map(errBody.issue, (issue) => issue.diagnostics);
                    if (issueTexts.length > 0) {
                        reject(issueTexts.join(' & '));
                    }
                    else if (errBody.text && errBody.text.div) {
                        reject(errBody.text.div);
                    }
                    else {
                        this.log.error(errBody);
                        reject('Unknown error returned by FHIR server when getting resources for implementation guide');
                    }
                }
                else {
                    this.log.error(err);
                    reject(err);
                }
            });
        });
    }
    export(format = 'json') {
        return new Promise((resolve, reject) => {
            this.getBundle()
                .then((results) => {
                let response = results;
                if (format === 'xml' || format === 'application/xml') {
                    response = this.fhir.objToXml(results);
                }
                resolve(response);
            })
                .catch((err) => {
                reject(err);
            });
        });
    }
}
exports.BundleExporter = BundleExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVuZGxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsZ0NBQWdDO0FBQ2hDLHNDQUFzQztBQUN0Qyw0Q0FBNEM7QUFDNUMsaUNBQWlDO0FBQ2pDLGlDQUFpQztBQUdqQyxNQUFhLGNBQWM7SUFTdkIsWUFBWSxjQUFzQixFQUFFLFlBQW9CLEVBQUUsSUFBVSxFQUFFLHFCQUE2QjtRQVIxRixRQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBUzlCLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxxQkFBcUIsQ0FBQztRQUNuRCxJQUFJLENBQUMsVUFBVSxHQUFnQixNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxtQkFBNEM7UUFDbEUsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBRXBCLENBQUMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDOUMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO2lCQUN6QyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsZUFBZSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztpQkFDeEYsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztpQkFDckQsS0FBSyxFQUFFLENBQUM7WUFFYixDQUFDLENBQUMsSUFBSSxD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LEVBQUU7d0JBQ3pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUM1Qjt5QkFBTTt3QkFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQzt3QkFDeEIsTUFBTSxDQUFDLHVGQUF1RixDQUFDLENBQUM7cUJBQ25HO2lCQUNKO3FCQUFNO29CQUNILElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUNwQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2Y7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLE1BQU0sQ0FBQyxTQUEyRyxNQUFNO1FBQzNILE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFNBQVMsRUFBRTtpQkFDWCxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDZCxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUM7Z0JBRXZCLElBQUksTUFBTSxLQUFLLEtBQUssSUFBSSxNQUFNLEtBQUssaUJBQWlCLEVBQUU7b0JBQ2xELFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDMUM7Z0JBRUQsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3RCLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDWCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQXRKRCx3Q0FzSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0ZoaXJ9IGZyb20gJ2ZoaXIvZmhpcic7XHJcbmltcG9ydCB7SW1wbGVtZW50YXRpb25HdWlkZSBhcyBTVFUzSW1wbGVtZW50YXRpb25HdWlkZSwgT3BlcmF0aW9uT3V0Y29tZX0gZnJvbSAnLi4vLi4vc3JjL2FwcC9tb2RlbHMvc3R1My9maGlyJztcclxuaW1wb3J0IHtJbXBsZW1lbnRhdGlvbkd1aWRlIGFzIFI0SW1wbGVtZW50YXRpb25HdWlkZX0gZnJvbSAnLi4vLi4vc3JjL2FwcC9tb2RlbHMvcjQvZmhpcic7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XHJcbmltcG9ydCAqIGFzIHJwIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XHJcbmltcG9ydCAqIGFzIEZoaXJIZWxwZXIgZnJvbSAnLi4vZmhpckhlbHBlcic7XHJcbmltcG9ydCAqIGFzIGxvZzRqcyBmcm9tICdsb2c0anMnO1xyXG5pbXBvcnQgKiBhcyBjb25maWcgZnJvbSAnY29uZmlnJztcclxuaW1wb3J0IHtGaGlyQ29uZmlnfSBmcm9tICcuLi9jb250cm9sbGVycy9tb2RlbHMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEJ1bmRsZUV4cG9ydGVyIHtcclxuICAgIHJlYWRvbmx5IGxvZyA9IGxvZzRqcy5nZXRMb2dnZXIoKTtcclxuICAgIHJlYWRvbmx5IGZoaXJTZXJ2ZXJCYXNlOiBzdHJpbmc7XHJcbiAgICByZWFkb25seSBmaGlyU2VydmVySWQ6IHN0cmluZztcclxuICAgIHJlYWRvbmx5IGZoaXI6IEZoaXI7XHJcbiAgICByZWFkb25seSBpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZztcclxuXHJcbiAgICBwdWJsaWMgZmhpckNvbmZpZzogRmhpckNvbmZpZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihmaGlyU2VydmVyQmFzZTogc3RyaW5nLCBmaGlyU2VydmVySWQ6IHN0cmluZywgZmhpcjogRmhpciwgaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLmZoaXJTZXJ2ZXJCYXNlID0gZmhpclNlcnZlckJhc2U7XHJcbiAgICAgICAgdGhpcy5maGlyU2VydmVySWQgPSBmaGlyU2VydmVySWQ7XHJcbiAgICAgICAgdGhpcy5maGlyID0gZmhpcjtcclxuICAgICAgICB0aGlzLmltcGxlbWVudGF0aW9uR3VpZGVJZCA9IGltcGxlbWVudGF0aW9uR3VpZGVJZDtcclxuICAgICAgICB0aGlzLmZoaXJDb25maWcgPSA8RmhpckNvbmZpZz4gY29uZmlnLmdldCgnZmhpcicpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2dldFN0dTNSZXNvdXJjZXMoaW1wbGVtZW50YXRpb25HdWlkZTogU1RVM0ltcGxlbWVudGF0aW9uR3VpZGUpIHtcclxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xyXG5cclxuICAgICAgICBfLmVhY2goaW1wbGVtZW50YXRpb25HdWlkZS5wYWNrYWdlLCAoaWdQYWNrYWdlKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZXMgPSBfLmNoYWluKGlnUGFja2FnZS5yZXNvdXJjZSlcclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoKHJlc291cmNlKSA9PiAhIXJlc291cmNlLnNvdXJjZVJlZmVyZW5jZSAmJiAhIXJlc291cmNlLnNvdXJjZVJlZmVyZW5jZS5yZWZlcmVuY2UpXHJcbiAgICAgICAgICAgICAgICAubWFwKChyZXNvdXJjZSkgPT4gcmVzb3VyY2Uuc291cmNlUmVmZXJlbmNlLnJlZmVyZW5jZSlcclxuICAgICAgICAgICAgICAgIC52YWx1ZSgpO1xyXG5cclxuICAgICAgICAgICAgXy5lYWNoKHJlZmVyZW5jZXMsIChyZWZlcmVuY2UpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IEZoaXJIZWxwZXIucGFyc2VVcmwocmVmZXJlbmNlKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc291cmNlVXJsID0gRmhpckhlbHBlci5idWlsZFVybCh0aGlzLmZoaXJTZXJ2ZXJCYXNlLCBwYXJzZWQucmVzb3VyY2VUeXBlLCBwYXJzZWQuaWQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VQcm9taXNlID0gcnAoeyB1cmw6IHJlc291cmNlVXJsLCBqc29uOiB0cnVlLCByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2gocmVzb3VyY2VQcm9taXNlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZ2V0UjRSZXNvdXJjZXMoaW1wbGVtZW50YXRpb25HdWlkZTogUjRJbXBsZW1lbnRhdGlvbkd1aWRlKSB7XHJcbiAgICAgICAgaWYgKCFpbXBsZW1lbnRhdGlvbkd1aWRlLmRlZmluaXRpb24pIHtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IF8uY2hhaW4oaW1wbGVtZW50YXRpb25HdWlkZS5kZWZpbml0aW9uLnJlc291cmNlKVxyXG4gICAgICAgICAgICAuZmlsdGVyKChyZXNvdXJjZSkgPT4gISFyZXNvdXJjZS5yZWZlcmVuY2UgJiYgISFyZXNvdXJjZS5yZWZlcmVuY2UucmVmZXJlbmNlKVxyXG4gICAgICAgICAgICAubWFwKChyZXNvdXJjZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlbmNlID0gcmVzb3VyY2UucmVmZXJlbmNlLnJlZmVyZW5jZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IEZoaXJIZWxwZXIucGFyc2VVcmwocmVmZXJlbmNlKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc291cmNlVXJsID0gRmhpckhlbHBlci5idWlsZFVybCh0aGlzLmZoaXJTZXJ2ZXJCYXNlLCBwYXJzZWQucmVzb3VyY2VUeXBlLCBwYXJzZWQuaWQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VQcm9taXNlID0gcnAoeyB1cmw6IHJlc291cmNlVXJsLCBqc29uOiB0cnVlLCByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNvdXJjZVByb21pc2U7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC52YWx1ZSgpO1xyXG5cclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRCdW5kbGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaWdVcmwgPSBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuZmhpclNlcnZlckJhc2UsICdJbXBsZW1lbnRhdGlvbkd1aWRlJywgdGhpcy5pbXBsZW1lbnRhdGlvbkd1aWRlSWQpO1xyXG4gICAgICAgICAgICBjb25zdCBmaGlyU2VydmVyQ29uZmlnID0gXy5maW5kKHRoaXMuZmhpckNvbmZpZy5zZXJ2ZXJzLCAoc2VydmVyQ29uZmlnKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmVyQ29uZmlnLmlkID09PSB0aGlzLmZoaXJTZXJ2ZXJJZDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGxldCBpbXBsZW1lbnRhdGlvbkd1aWRlO1xyXG4gICAgICAgICAgICBsZXQgaW1wbGVtZW50YXRpb25HdWlkZUZ1bGxVcmw7XHJcblxyXG4gICAgICAgICAgICBycCh7IHVybDogaWdVcmwsIGpzb246IHRydWUsIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlID0gcmVzcG9uc2UuYm9keTtcclxuICAgICAgICAgICAgICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlRnVsbFVybCA9IHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbG9jYXRpb24nXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZoaXJTZXJ2ZXJDb25maWcudmVyc2lvbiA9PT0gJ3N0dTMnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRTdHUzUmVzb3VyY2VzKGltcGxlbWVudGF0aW9uR3VpZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFI0UmVzb3VyY2VzKGltcGxlbWVudGF0aW9uR3VpZGUpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZUVudHJpZXMgPSBfLmNoYWluKHJlc3BvbnNlcylcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigocmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXJlc3BvbnNlLmJvZHkgJiYgISFyZXNwb25zZS5ib2R5LnJlc291cmNlVHlwZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgocmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmdWxsVXJsID0gcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC1sb2NhdGlvbiddO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZnVsbFVybCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxVcmwgPSBGaGlySGVscGVyLmpvaW5VcmwodGhpcy5maGlyU2VydmVyQmFzZSwgcmVzcG9uc2UuYm9keS5yZXNvdXJjZVR5cGUsIHJlc3BvbnNlLmJvZHkuaWQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuYm9keS5tZXRhICYmIHJlc3BvbnNlLmJvZHkubWV0YS52ZXJzaW9uSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFVybCA9IEZoaXJIZWxwZXIuam9pblVybChmdWxsVXJsLCAnX2hpc3RvcnknLCByZXNwb25zZS5ib2R5Lm1ldGEudmVyc2lvbklkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsVXJsOiBmdWxsVXJsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiByZXNwb25zZS5ib2R5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudmFsdWUoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlcy5sZW5ndGggIT09IHJlc291cmNlRW50cmllcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYEV4cGVjdGVkICR7cmVzcG9uc2VzLmxlbmd0aH0gZW50cmllcyBpbiB0aGUgZXhwb3J0IGJ1bmRsZSwgYnV0IG9ubHkgcmV0dXJuaW5nICR7cmVzb3VyY2VFbnRyaWVzLmxlbmd0aH0uIFNvbWUgcmVzb3VyY2VzIGNvdWxkIG5vdCBiZSByZXR1cm5lZCBpbiB0aGUgYnVuZGxlIGR1ZSB0byB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLmApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnVuZGxlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZVR5cGU6ICdCdW5kbGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY29sbGVjdGlvbicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiByZXNvdXJjZUVudHJpZXMubGVuZ3RoICsgMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW50cnk6IFt7IGZ1bGxVcmw6IGltcGxlbWVudGF0aW9uR3VpZGVGdWxsVXJsLCByZXNvdXJjZTogaW1wbGVtZW50YXRpb25HdWlkZSB9XS5jb25jYXQocmVzb3VyY2VFbnRyaWVzKVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYnVuZGxlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIgJiYgZXJyLnJlc3BvbnNlICYmIGVyci5yZXNwb25zZS5ib2R5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVyckJvZHkgPSA8T3BlcmF0aW9uT3V0Y29tZT4gZXJyLnJlc3BvbnNlLmJvZHk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlVGV4dHMgPSBfLm1hcChlcnJCb2R5Lmlzc3VlLCAoaXNzdWUpID0+IGlzc3VlLmRpYWdub3N0aWNzKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc3N1ZVRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChpc3N1ZVRleHRzLmpvaW4oJyAmICcpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJCb2R5LnRleHQgJiYgZXJyQm9keS50ZXh0LmRpdikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVyckJvZHkudGV4dC5kaXYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoZXJyQm9keSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoJ1Vua25vd24gZXJyb3IgcmV0dXJuZWQgYnkgRkhJUiBzZXJ2ZXIgd2hlbiBnZXR0aW5nIHJlc291cmNlcyBmb3IgaW1wbGVtZW50YXRpb24gZ3VpZGUnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBleHBvcnQoZm9ybWF0OiAnanNvbid8J3htbCd8J2FwcGxpY2F0aW9uL2pzb24nfCdhcHBsaWNhdGlvbi9maGlyK2pzb24nfCdhcHBsaWNhdGlvbi94bWwnfCdhcHBsaWNhdGlvbi9maGlyK3htbCcgPSAnanNvbicpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmdldEJ1bmRsZSgpXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCByZXNwb25zZSA9IHJlc3VsdHM7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JtYXQgPT09ICd4bWwnIHx8IGZvcm1hdCA9PT0gJ2FwcGxpY2F0aW9uL3htbCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgPSB0aGlzLmZoaXIub2JqVG9YbWwocmVzdWx0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0iXX0=
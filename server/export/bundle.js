"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("underscore");
const rp = require("request-promise");
const FhirHelper = require("../fhirHelper");
const log4js = require("log4js");
const config = require("config");
const globals_1 = require("../../src/app/globals");
class BundleExporter {
    constructor(fhirServerBase, fhirServerId, fhirVersion, fhir, implementationGuideId) {
        this.log = log4js.getLogger();
        this.fhirServerBase = fhirServerBase;
        this.fhirServerId = fhirServerId;
        this.fhirVersion = fhirVersion;
        this.fhir = fhir;
        this.implementationGuideId = implementationGuideId;
        this.fhirConfig = config.get('fhir');
    }
    /**
     * Performs any fixes to the resources that are being exported, such as removing ToF-specific extensions from the resource
     * and converting ImplementationGuide.definition.page.nameReference to nameUrl
     * @param object The resource to cleanup
     * @param clone
     */
    static cleanupResource(object, clone = true) {
        if (object) {
            if (clone) {
                object = JSON.parse(JSON.stringify(object));
            }
            const extensionUrls = _.map(new globals_1.Globals().extensionUrls, (extUrl) => extUrl);
            const keys = _.allKeys(object);
            // Convert page.nameReference to page.nameTitle
            if (object.resourceType === 'ImplementationGuide' && object.definition && object.definition.page) {
                const fixPage = (page) => {
                    if (page.nameReference && page.title) {
                        delete page.nameReference;
                        page.nameUrl = page.title.replace(/ /g, '_') + '.html';
                    }
                    _.each(page.page, (next) => fixPage(next));
                };
                fixPage(object.definition.page);
            }
            // Remove ToF-specific extensions
            _.each(keys, (key) => {
                if (key === 'extension') {
                    const extensions = object[key];
                    const removeExtensions = _.filter(extensions, (extension) => extensionUrls.indexOf(extension.url) >= 0);
                    // Remove any extensions from the resource that are for Trifolia
                    _.each(removeExtensions, (removeExtension) => {
                        const index = extensions.indexOf(removeExtension);
                        extensions.splice(index, 1);
                    });
                }
                else if (typeof object[key] === 'object') {
                    this.cleanupResource(object[key], false);
                }
            });
        }
        return object;
    }
    _getStu3Resources(implementationGuide) {
        const promises = [];
        _.each(implementationGuide.package, (igPackage) => {
            const references = _.chain(igPackage.resource)
                .filter((resource) => !!resource.sourceReference && !!resource.sourceReference.reference)
                .map((resource) => resource.sourceReference.reference)
                .value();
            _.each(references, (reference) => {
                const parsed = FhirHelper.parseUrl(reference);
                const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
                const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
                promises.push(resourcePromise);
            });
        });
        return Promise.all(promises);
    }
    _getR4Resources(implementationGuide) {
        if (!implementationGuide.definition) {
            return Promise.resolve([]);
        }
        const promises = _.chain(implementationGuide.definition.resource)
            .filter((resource) => !!resource.reference && !!resource.reference.reference)
            .map((resource) => {
            const reference = resource.reference.reference;
            const parsed = FhirHelper.parseUrl(reference);
            const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
            const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
            return resourcePromise;
        })
            .value();
        return Promise.all(promises);
    }
    getBundle(removeExtensions = false) {
        return new Promise((resolve, reject) => {
            const igUrl = FhirHelper.buildUrl(this.fhirServerBase, 'ImplementationGuide', this.implementationGuideId);
            const fhirServerConfig = _.find(this.fhirConfig.servers, (serverConfig) => {
                return serverConfig.id === this.fhirServerId;
            });
            let implementationGuide;
            let implementationGuideFullUrl;
            rp({ url: igUrl, json: true, resolveWithFullResponse: true })
                .then((response) => {
                implementationGuide = response.body;
                implementationGuideFullUrl = response.headers['content-location'];
                if (fhirServerConfig.version === 'stu3') {
                    return this._getStu3Resources(implementationGuide);
                }
                return this._getR4Resources(implementationGuide);
            })
                .then((responses) => {
                const resourceEntries = _.chain(responses)
                    .filter((response) => {
                    return !!response.body && !!response.body.resourceType;
                })
                    .map((response) => {
                    let fullUrl = response.headers['content-location'];
                    if (!fullUrl) {
                        fullUrl = FhirHelper.joinUrl(this.fhirServerBase, response.body.resourceType, response.body.id);
                        if (response.body.meta && response.body.meta.versionId) {
                            fullUrl = FhirHelper.joinUrl(fullUrl, '_history', response.body.meta.versionId);
                        }
                    }
                    return {
                        fullUrl: fullUrl,
                        resource: response.body
                    };
                })
                    .value();
                if (responses.length !== resourceEntries.length) {
                    this.log.error(`Expected ${responses.length} entries in the export bundle, but only returning ${resourceEntries.length}. Some resources could not be returned in the bundle due to the response from the server.`);
                }
                const bundle = {
                    resourceType: 'Bundle',
                    type: 'collection',
                    total: resourceEntries.length + 1,
                    entry: [{ fullUrl: implementationGuideFullUrl, resource: implementationGuide }].concat(resourceEntries)
                };
                if (removeExtensions) {
                    BundleExporter.cleanupResource(bundle, false);
                }
                resolve(bundle);
            })
                .catch((err) => {
                if (err && err.response && err.response.body) {
                    const errBody = err.response.body;
                    const issueTexts = _.map(errBody.issue, (issue) => issue.diagnostics);
                    if (issueTexts.length > 0) {
                        reject(issueTexts.join(' & '));
                    }
                    else if (errBody.text && errBody.text.div) {
                        reject(errBody.text.div);
                    }
                    else {
                        this.log.error(errBody);
                        reject('Unknown error returned by FHIR server when getting resources for implementation guide');
                    }
                }
                else {
                    this.log.error(err);
                    reject(err);
                }
            });
        });
    }
    export(format = 'json', removeExtensions = false) {
        return new Promise((resolve, reject) => {
            this.getBundle(removeExtensions)
                .then((results) => {
                let response = results;
                if (format === 'xml' || format === 'application/xml') {
                    response = this.fhir.objToXml(results);
                }
                resolve(response);
            })
                .catch((err) => {
                reject(err);
            });
        });
    }
}
exports.BundleExporter = BundleExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVuZGxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsZ0NBQWdDO0FBQ2hDLHNDQUFzQztBQUN0Qyw0Q0FBNEM7QUFDNUMsaUNBQWlDO0FBQ2pDLGlDQUFpQztBQUVqQyxtREFBOEM7QUFHOUMsTUFBYSxjQUFjO0lBVXZCLFlBQVksY0FBc0IsRUFBRSxZQUFvQixFQUFFLFdBQW1CLEVBQUUsSUFBVSxFQUFFLHFCQUE2QjtRQVQvRyxRQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBVTlCLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxxQkFBcUIsQ0FBQztRQUNuRCxJQUFJLENBQUMsVUFBVSxHQUFnQixNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLE1BQU0sQ0FBQyxlQUFlLENBQUMsTUFBVyxFQUFFLEtBQUssR0FBRyxJQUFJO1FBQ25ELElBQUksTUFBTSxFQUFFO1lBQ1IsSUFBSSxLQUFLLEVBQUU7Z0JBQ1AsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQy9DO1lBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLGlCQUFPLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzdFLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENB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QyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ3hCLE1BQU0sQ0FBQyx1RkFBdUYsQ0FBQyxDQUFDO3FCQUNuRztpQkFDSjtxQkFBTTtvQkFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDcEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNmO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxNQUFNLENBQUMsU0FBMkcsTUFBTSxFQUFFLGdCQUFnQixHQUFHLEtBQUs7UUFDckosT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDO2lCQUMzQixJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDZCxJQUFJLFFBQVEsR0FBb0IsT0FBTyxDQUFDO2dCQUV4QyxJQUFJLE1BQU0sS0FBSyxLQUFLLElBQUksTUFBTSxLQUFLLGlCQUFpQixFQUFFO29CQUNsRCxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQzFDO2dCQUVELE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QixDQUFDLENBQUM7aUJBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ1gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ1gsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUE3TUQsd0NBNk1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGaGlyfSBmcm9tICdmaGlyL2ZoaXInO1xuaW1wb3J0IHtCdW5kbGUsIEltcGxlbWVudGF0aW9uR3VpZGUgYXMgU1RVM0ltcGxlbWVudGF0aW9uR3VpZGUsIE9wZXJhdGlvbk91dGNvbWV9IGZyb20gJy4uLy4uL3NyYy9hcHAvbW9kZWxzL3N0dTMvZmhpcic7XG5pbXBvcnQge1xuICAgIEltcGxlbWVudGF0aW9uR3VpZGUgYXMgUjRJbXBsZW1lbnRhdGlvbkd1aWRlLFxuICAgIEltcGxlbWVudGF0aW9uR3VpZGVQYWdlQ29tcG9uZW50XG59IGZyb20gJy4uLy4uL3NyYy9hcHAvbW9kZWxzL3I0L2ZoaXInO1xuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJztcbmltcG9ydCAqIGFzIHJwIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgKiBhcyBGaGlySGVscGVyIGZyb20gJy4uL2ZoaXJIZWxwZXInO1xuaW1wb3J0ICogYXMgbG9nNGpzIGZyb20gJ2xvZzRqcyc7XG5pbXBvcnQgKiBhcyBjb25maWcgZnJvbSAnY29uZmlnJztcbmltcG9ydCB7RmhpciBhcyBGaGlyTW9kZWwsIEZoaXJDb25maWd9IGZyb20gJy4uL2NvbnRyb2xsZXJzL21vZGVscyc7XG5pbXBvcnQge0dsb2JhbHN9IGZyb20gJy4uLy4uL3NyYy9hcHAvZ2xvYmFscyc7XG5pbXBvcnQgRXh0ZW5zaW9uID0gRmhpck1vZGVsLkV4dGVuc2lvbjtcblxuZXhwb3J0IGNsYXNzIEJ1bmRsZUV4cG9ydGVyIHtcbiAgICByZWFkb25seSBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCk7XG4gICAgcmVhZG9ubHkgZmhpclNlcnZlckJhc2U6IHN0cmluZztcbiAgICByZWFkb25seSBmaGlyU2VydmVySWQ6IHN0cmluZztcbiAgICByZWFkb25seSBmaGlyVmVyc2lvbjogc3RyaW5nO1xuICAgIHJlYWRvbmx5IGZoaXI6IEZoaXI7XG4gICAgcmVhZG9ubHkgaW1wbGVtZW50YXRpb25HdWlkZUlkOiBzdHJpbmc7XG5cbiAgICBwdWJsaWMgZmhpckNvbmZpZzogRmhpckNvbmZpZztcblxuICAgIGNvbnN0cnVjdG9yKGZoaXJTZXJ2ZXJCYXNlOiBzdHJpbmcsIGZoaXJTZXJ2ZXJJZDogc3RyaW5nLCBmaGlyVmVyc2lvbjogc3RyaW5nLCBmaGlyOiBGaGlyLCBpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLmZoaXJTZXJ2ZXJCYXNlID0gZmhpclNlcnZlckJhc2U7XG4gICAgICAgIHRoaXMuZmhpclNlcnZlcklkID0gZmhpclNlcnZlcklkO1xuICAgICAgICB0aGlzLmZoaXJWZXJzaW9uID0gZmhpclZlcnNpb247XG4gICAgICAgIHRoaXMuZmhpciA9IGZoaXI7XG4gICAgICAgIHRoaXMuaW1wbGVtZW50YXRpb25HdWlkZUlkID0gaW1wbGVtZW50YXRpb25HdWlkZUlkO1xuICAgICAgICB0aGlzLmZoaXJDb25maWcgPSA8RmhpckNvbmZpZz4gY29uZmlnLmdldCgnZmhpcicpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm1zIGFueSBmaXhlcyB0byB0aGUgcmVzb3VyY2VzIHRoYXQgYXJlIGJlaW5nIGV4cG9ydGVkLCBzdWNoIGFzIHJlbW92aW5nIFRvRi1zcGVjaWZpYyBleHRlbnNpb25zIGZyb20gdGhlIHJlc291cmNlXG4gICAgICogYW5kIGNvbnZlcnRpbmcgSW1wbGVtZW50YXRpb25HdWlkZS5kZWZpbml0aW9uLnBhZ2UubmFtZVJlZmVyZW5jZSB0byBuYW1lVXJsXG4gICAgICogQHBhcmFtIG9iamVjdCBUaGUgcmVzb3VyY2UgdG8gY2xlYW51cFxuICAgICAqIEBwYXJhbSBjbG9uZVxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY2xlYW51cFJlc291cmNlKG9iamVjdDogYW55LCBjbG9uZSA9IHRydWUpIHtcbiAgICAgICAgaWYgKG9iamVjdCkge1xuICAgICAgICAgICAgaWYgKGNsb25lKSB7XG4gICAgICAgICAgICAgICAgb2JqZWN0ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmplY3QpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZXh0ZW5zaW9uVXJscyA9IF8ubWFwKG5ldyBHbG9iYWxzKCkuZXh0ZW5zaW9uVXJscywgKGV4dFVybCkgPT4gZXh0VXJsKTtcbiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBfLmFsbEtleXMob2JqZWN0KTtcblxuICAgICAgICAgICAgLy8gQ29udmVydCBwYWdlLm5hbWVSZWZlcmVuY2UgdG8gcGFnZS5uYW1lVGl0bGVcbiAgICAgICAgICAgIGlmIChvYmplY3QucmVzb3VyY2VUeXBlID09PSAnSW1wbGVtZW50YXRpb25HdWlkZScgJiYgb2JqZWN0LmRlZmluaXRpb24gJiYgb2JqZWN0LmRlZmluaXRpb24ucGFnZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpeFBhZ2UgPSAocGFnZTogSW1wbGVtZW50YXRpb25HdWlkZVBhZ2VDb21wb25lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2UubmFtZVJlZmVyZW5jZSAmJiBwYWdlLnRpdGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGFnZS5uYW1lUmVmZXJlbmNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZS5uYW1lVXJsID0gcGFnZS50aXRsZS5yZXBsYWNlKC8gL2csICdfJykgKyAnLmh0bWwnO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHBhZ2UucGFnZSwgKG5leHQpID0+IGZpeFBhZ2UobmV4dCkpO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBmaXhQYWdlKG9iamVjdC5kZWZpbml0aW9uLnBhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBSZW1vdmUgVG9GLXNwZWNpZmljIGV4dGVuc2lvbnNcbiAgICAgICAgICAgIF8uZWFjaChrZXlzLCAoa2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ2V4dGVuc2lvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXh0ZW5zaW9uczogRXh0ZW5zaW9uW10gPSBvYmplY3Rba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlRXh0ZW5zaW9ucyA9IF8uZmlsdGVyKGV4dGVuc2lvbnMsIChleHRlbnNpb24pID0+IGV4dGVuc2lvblVybHMuaW5kZXhPZihleHRlbnNpb24udXJsKSA+PSAwKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4dGVuc2lvbnMgZnJvbSB0aGUgcmVzb3VyY2UgdGhhdCBhcmUgZm9yIFRyaWZvbGlhXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChyZW1vdmVFeHRlbnNpb25zLCAocmVtb3ZlRXh0ZW5zaW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IGV4dGVuc2lvbnMuaW5kZXhPZihyZW1vdmVFeHRlbnNpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9ucy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmplY3Rba2V5XSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhbnVwUmVzb3VyY2Uob2JqZWN0W2tleV0sIGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvYmplY3Q7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0U3R1M1Jlc291cmNlcyhpbXBsZW1lbnRhdGlvbkd1aWRlOiBTVFUzSW1wbGVtZW50YXRpb25HdWlkZSkge1xuICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIF8uZWFjaChpbXBsZW1lbnRhdGlvbkd1aWRlLnBhY2thZ2UsIChpZ1BhY2thZ2UpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZXMgPSBfLmNoYWluKGlnUGFja2FnZS5yZXNvdXJjZSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChyZXNvdXJjZSkgPT4gISFyZXNvdXJjZS5zb3VyY2VSZWZlcmVuY2UgJiYgISFyZXNvdXJjZS5zb3VyY2VSZWZlcmVuY2UucmVmZXJlbmNlKVxuICAgICAgICAgICAgICAgIC5tYXAoKHJlc291cmNlKSA9PiByZXNvdXJjZS5zb3VyY2VSZWZlcmVuY2UucmVmZXJlbmNlKVxuICAgICAgICAgICAgICAgIC52YWx1ZSgpO1xuXG4gICAgICAgICAgICBfLmVhY2gocmVmZXJlbmNlcywgKHJlZmVyZW5jZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IEZoaXJIZWxwZXIucGFyc2VVcmwocmVmZXJlbmNlKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZVVybCA9IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5maGlyU2VydmVyQmFzZSwgcGFyc2VkLnJlc291cmNlVHlwZSwgcGFyc2VkLmlkKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZVByb21pc2UgPSBycCh7IHVybDogcmVzb3VyY2VVcmwsIGpzb246IHRydWUsIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2gocmVzb3VyY2VQcm9taXNlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFI0UmVzb3VyY2VzKGltcGxlbWVudGF0aW9uR3VpZGU6IFI0SW1wbGVtZW50YXRpb25HdWlkZSkge1xuICAgICAgICBpZiAoIWltcGxlbWVudGF0aW9uR3VpZGUuZGVmaW5pdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IF8uY2hhaW4oaW1wbGVtZW50YXRpb25HdWlkZS5kZWZpbml0aW9uLnJlc291cmNlKVxuICAgICAgICAgICAgLmZpbHRlcigocmVzb3VyY2UpID0+ICEhcmVzb3VyY2UucmVmZXJlbmNlICYmICEhcmVzb3VyY2UucmVmZXJlbmNlLnJlZmVyZW5jZSlcbiAgICAgICAgICAgIC5tYXAoKHJlc291cmNlKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlbmNlID0gcmVzb3VyY2UucmVmZXJlbmNlLnJlZmVyZW5jZTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBGaGlySGVscGVyLnBhcnNlVXJsKHJlZmVyZW5jZSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VVcmwgPSBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuZmhpclNlcnZlckJhc2UsIHBhcnNlZC5yZXNvdXJjZVR5cGUsIHBhcnNlZC5pZCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VQcm9taXNlID0gcnAoeyB1cmw6IHJlc291cmNlVXJsLCBqc29uOiB0cnVlLCByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VQcm9taXNlO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC52YWx1ZSgpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEJ1bmRsZShyZW1vdmVFeHRlbnNpb25zID0gZmFsc2UpOiBQcm9taXNlPEJ1bmRsZT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaWdVcmwgPSBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuZmhpclNlcnZlckJhc2UsICdJbXBsZW1lbnRhdGlvbkd1aWRlJywgdGhpcy5pbXBsZW1lbnRhdGlvbkd1aWRlSWQpO1xuICAgICAgICAgICAgY29uc3QgZmhpclNlcnZlckNvbmZpZyA9IF8uZmluZCh0aGlzLmZoaXJDb25maWcuc2VydmVycywgKHNlcnZlckNvbmZpZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2ZXJDb25maWcuaWQgPT09IHRoaXMuZmhpclNlcnZlcklkO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsZXQgaW1wbGVtZW50YXRpb25HdWlkZTtcbiAgICAgICAgICAgIGxldCBpbXBsZW1lbnRhdGlvbkd1aWRlRnVsbFVybDtcblxuICAgICAgICAgICAgcnAoeyB1cmw6IGlnVXJsLCBqc29uOiB0cnVlLCByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSB9KVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlID0gcmVzcG9uc2UuYm9keTtcbiAgICAgICAgICAgICAgICAgICAgaW1wbGVtZW50YXRpb25HdWlkZUZ1bGxVcmwgPSByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LWxvY2F0aW9uJ107XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZoaXJTZXJ2ZXJDb25maWcudmVyc2lvbiA9PT0gJ3N0dTMnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0U3R1M1Jlc291cmNlcyhpbXBsZW1lbnRhdGlvbkd1aWRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRSNFJlc291cmNlcyhpbXBsZW1lbnRhdGlvbkd1aWRlKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VFbnRyaWVzID0gXy5jaGFpbihyZXNwb25zZXMpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXJlc3BvbnNlLmJvZHkgJiYgISFyZXNwb25zZS5ib2R5LnJlc291cmNlVHlwZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmdWxsVXJsID0gcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC1sb2NhdGlvbiddO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmdWxsVXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxVcmwgPSBGaGlySGVscGVyLmpvaW5VcmwodGhpcy5maGlyU2VydmVyQmFzZSwgcmVzcG9uc2UuYm9keS5yZXNvdXJjZVR5cGUsIHJlc3BvbnNlLmJvZHkuaWQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5ib2R5Lm1ldGEgJiYgcmVzcG9uc2UuYm9keS5tZXRhLnZlcnNpb25JZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFVybCA9IEZoaXJIZWxwZXIuam9pblVybChmdWxsVXJsLCAnX2hpc3RvcnknLCByZXNwb25zZS5ib2R5Lm1ldGEudmVyc2lvbklkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxVcmw6IGZ1bGxVcmwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiByZXNwb25zZS5ib2R5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudmFsdWUoKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2VzLmxlbmd0aCAhPT0gcmVzb3VyY2VFbnRyaWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYEV4cGVjdGVkICR7cmVzcG9uc2VzLmxlbmd0aH0gZW50cmllcyBpbiB0aGUgZXhwb3J0IGJ1bmRsZSwgYnV0IG9ubHkgcmV0dXJuaW5nICR7cmVzb3VyY2VFbnRyaWVzLmxlbmd0aH0uIFNvbWUgcmVzb3VyY2VzIGNvdWxkIG5vdCBiZSByZXR1cm5lZCBpbiB0aGUgYnVuZGxlIGR1ZSB0byB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLmApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnVuZGxlID0gPEJ1bmRsZT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VUeXBlOiAnQnVuZGxlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjb2xsZWN0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiByZXNvdXJjZUVudHJpZXMubGVuZ3RoICsgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5OiBbeyBmdWxsVXJsOiBpbXBsZW1lbnRhdGlvbkd1aWRlRnVsbFVybCwgcmVzb3VyY2U6IGltcGxlbWVudGF0aW9uR3VpZGUgfV0uY29uY2F0KHJlc291cmNlRW50cmllcylcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlRXh0ZW5zaW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgQnVuZGxlRXhwb3J0ZXIuY2xlYW51cFJlc291cmNlKGJ1bmRsZSwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShidW5kbGUpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVyciAmJiBlcnIucmVzcG9uc2UgJiYgZXJyLnJlc3BvbnNlLmJvZHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVyckJvZHkgPSA8T3BlcmF0aW9uT3V0Y29tZT4gZXJyLnJlc3BvbnNlLmJvZHk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZVRleHRzID0gXy5tYXAoZXJyQm9keS5pc3N1ZSwgKGlzc3VlKSA9PiBpc3N1ZS5kaWFnbm9zdGljcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc3N1ZVRleHRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoaXNzdWVUZXh0cy5qb2luKCcgJiAnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVyckJvZHkudGV4dCAmJiBlcnJCb2R5LnRleHQuZGl2KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVyckJvZHkudGV4dC5kaXYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihlcnJCb2R5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoJ1Vua25vd24gZXJyb3IgcmV0dXJuZWQgYnkgRkhJUiBzZXJ2ZXIgd2hlbiBnZXR0aW5nIHJlc291cmNlcyBmb3IgaW1wbGVtZW50YXRpb24gZ3VpZGUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXhwb3J0KGZvcm1hdDogJ2pzb24nfCd4bWwnfCdhcHBsaWNhdGlvbi9qc29uJ3wnYXBwbGljYXRpb24vZmhpcitqc29uJ3wnYXBwbGljYXRpb24veG1sJ3wnYXBwbGljYXRpb24vZmhpcit4bWwnID0gJ2pzb24nLCByZW1vdmVFeHRlbnNpb25zID0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2V0QnVuZGxlKHJlbW92ZUV4dGVuc2lvbnMpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlOiBCdW5kbGUgfCBzdHJpbmcgPSByZXN1bHRzO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JtYXQgPT09ICd4bWwnIHx8IGZvcm1hdCA9PT0gJ2FwcGxpY2F0aW9uL3htbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5maGlyLm9ialRvWG1sKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==
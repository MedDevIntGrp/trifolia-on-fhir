"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("underscore");
const rp = require("request-promise");
const FhirHelper = require("../fhirHelper");
const log4js = require("log4js");
const config = require("config");
const globals_1 = require("../../src/app/globals");
class BundleExporter {
    constructor(fhirServerBase, fhirServerId, fhirVersion, fhir, implementationGuideId) {
        this.log = log4js.getLogger();
        this.fhirServerBase = fhirServerBase;
        this.fhirServerId = fhirServerId;
        this.fhirVersion = fhirVersion;
        this.fhir = fhir;
        this.implementationGuideId = implementationGuideId;
        this.fhirConfig = config.get('fhir');
    }
    /**
     * Performs any fixes to the resources that are being exported, such as removing ToF-specific extensions from the resource
     * and converting ImplementationGuide.definition.page.nameReference to nameUrl
     * @param object The resource to cleanup
     * @param clone
     */
    static cleanupResource(object, clone = true) {
        if (object) {
            if (clone) {
                object = JSON.parse(JSON.stringify(object));
            }
            const extensionUrls = _.map(new globals_1.Globals().extensionUrls, (extUrl) => extUrl);
            const keys = _.allKeys(object);
            // Convert page.nameReference to page.nameTitle
            if (object.resourceType === 'ImplementationGuide' && object.definition && object.definition.page) {
                const fixPage = (page) => {
                    if (page.nameReference && page.title) {
                        delete page.nameReference;
                        page.nameUrl = page.title.replace(/ /g, '_') + '.html';
                    }
                    _.each(page.page, (next) => fixPage(next));
                };
                fixPage(object.definition.page);
                // Remove any contained binary resources. The IG publisher produces errors when there is a contained binary resource on the IG.
                const containedBinary = _.filter(object.contained, (contained) => contained.resourceType === 'Binary');
                _.each(containedBinary, (contained) => {
                    const index = object.contained.indexOf(contained);
                    object.contained.splice(index, 1);
                });
            }
            // Remove ToF-specific extensions
            _.each(keys, (key) => {
                if (key === 'extension') {
                    const extensions = object[key];
                    const removeExtensions = _.filter(extensions, (extension) => extensionUrls.indexOf(extension.url) >= 0);
                    // Remove any extensions from the resource that are for Trifolia
                    _.each(removeExtensions, (removeExtension) => {
                        const index = extensions.indexOf(removeExtension);
                        extensions.splice(index, 1);
                    });
                }
                else if (typeof object[key] === 'object') {
                    this.cleanupResource(object[key], false);
                }
            });
        }
        return object;
    }
    _getStu3Resources(implementationGuide) {
        const promises = [];
        _.each(implementationGuide.package, (igPackage) => {
            const references = _.chain(igPackage.resource)
                .filter((resource) => !!resource.sourceReference && !!resource.sourceReference.reference)
                .map((resource) => resource.sourceReference.reference)
                .value();
            _.each(references, (reference) => {
                const parsed = FhirHelper.parseUrl(reference);
                const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
                const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
                promises.push(resourcePromise);
            });
        });
        return Promise.all(promises);
    }
    _getR4Resources(implementationGuide) {
        if (!implementationGuide.definition) {
            return Promise.resolve([]);
        }
        const promises = _.chain(implementationGuide.definition.resource)
            .filter((resource) => !!resource.reference && !!resource.reference.reference)
            .map((resource) => {
            const reference = resource.reference.reference;
            const parsed = FhirHelper.parseUrl(reference);
            const resourceUrl = FhirHelper.buildUrl(this.fhirServerBase, parsed.resourceType, parsed.id);
            const resourcePromise = rp({ url: resourceUrl, json: true, resolveWithFullResponse: true });
            return resourcePromise;
        })
            .value();
        return Promise.all(promises);
    }
    getBundle(removeExtensions = false) {
        return new Promise((resolve, reject) => {
            const igUrl = FhirHelper.buildUrl(this.fhirServerBase, 'ImplementationGuide', this.implementationGuideId);
            const fhirServerConfig = _.find(this.fhirConfig.servers, (serverConfig) => {
                return serverConfig.id === this.fhirServerId;
            });
            let implementationGuide;
            let implementationGuideFullUrl;
            rp({ url: igUrl, json: true, resolveWithFullResponse: true })
                .then((response) => {
                implementationGuide = response.body;
                implementationGuideFullUrl = response.headers['content-location'];
                if (fhirServerConfig.version === 'stu3') {
                    return this._getStu3Resources(implementationGuide);
                }
                return this._getR4Resources(implementationGuide);
            })
                .then((responses) => {
                const resourceEntries = _.chain(responses)
                    .filter((response) => {
                    return !!response.body && !!response.body.resourceType;
                })
                    .map((response) => {
                    let fullUrl = response.headers['content-location'];
                    if (!fullUrl) {
                        fullUrl = FhirHelper.joinUrl(this.fhirServerBase, response.body.resourceType, response.body.id);
                        if (response.body.meta && response.body.meta.versionId) {
                            fullUrl = FhirHelper.joinUrl(fullUrl, '_history', response.body.meta.versionId);
                        }
                    }
                    return {
                        fullUrl: fullUrl,
                        resource: response.body
                    };
                })
                    .value();
                if (responses.length !== resourceEntries.length) {
                    this.log.error(`Expected ${responses.length} entries in the export bundle, but only returning ${resourceEntries.length}. Some resources could not be returned in the bundle due to the response from the server.`);
                }
                const bundle = {
                    resourceType: 'Bundle',
                    type: 'collection',
                    total: resourceEntries.length + 1,
                    entry: [{ fullUrl: implementationGuideFullUrl, resource: implementationGuide }].concat(resourceEntries)
                };
                if (removeExtensions) {
                    BundleExporter.cleanupResource(bundle, false);
                }
                resolve(bundle);
            })
                .catch((err) => {
                if (err && err.response && err.response.body) {
                    const errBody = err.response.body;
                    const issueTexts = _.map(errBody.issue, (issue) => issue.diagnostics);
                    if (issueTexts.length > 0) {
                        reject(issueTexts.join(' & '));
                    }
                    else if (errBody.text && errBody.text.div) {
                        reject(errBody.text.div);
                    }
                    else {
                        this.log.error(errBody);
                        reject('Unknown error returned by FHIR server when getting resources for implementation guide');
                    }
                }
                else {
                    this.log.error(err);
                    reject(err);
                }
            });
        });
    }
    export(format = 'json', removeExtensions = false) {
        return new Promise((resolve, reject) => {
            this.getBundle(removeExtensions)
                .then((results) => {
                let response = results;
                if (format === 'xml' || format === 'application/xml') {
                    response = this.fhir.objToXml(results);
                }
                resolve(response);
            })
                .catch((err) => {
                reject(err);
            });
        });
    }
}
exports.BundleExporter = BundleExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVuZGxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsZ0NBQWdDO0FBQ2hDLHNDQUFzQztBQUN0Qyw0Q0FBNEM7QUFDNUMsaUNBQWlDO0FBQ2pDLGlDQUFpQztBQUVqQyxtREFBOEM7QUFHOUMsTUFBYSxjQUFjO0lBVXZCLFlBQVksY0FBc0IsRUFBRSxZQUFvQixFQUFFLFdBQW1CLEVBQUUsSUFBVSxFQUFFLHFCQUE2QjtRQVQvRyxRQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBVTlCLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxxQkFBcUIsQ0FBQztRQUNuRCxJQUFJLENBQUMsVUFBVSxHQUFnQixNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLE1BQU0sQ0FBQyxlQUFlLENBQUMsTUFBVyxFQUFFLEtBQUssR0FBRyxJQUFJO1FBQ25ELElBQUksTUFBTSxFQUFFO1lBQ1IsSUFBSSxLQUFLLEVBQUU7Z0JBQ1AsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQy9DO1lBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLGlCQUFPLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzdFLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENB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RCxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEIsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNYLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztRQUNYLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBcE5ELHdDQW9OQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Rmhpcn0gZnJvbSAnZmhpci9maGlyJztcclxuaW1wb3J0IHtCdW5kbGUsIEltcGxlbWVudGF0aW9uR3VpZGUgYXMgU1RVM0ltcGxlbWVudGF0aW9uR3VpZGUsIE9wZXJhdGlvbk91dGNvbWV9IGZyb20gJy4uLy4uL3NyYy9hcHAvbW9kZWxzL3N0dTMvZmhpcic7XHJcbmltcG9ydCB7XHJcbiAgICBJbXBsZW1lbnRhdGlvbkd1aWRlIGFzIFI0SW1wbGVtZW50YXRpb25HdWlkZSxcclxuICAgIEltcGxlbWVudGF0aW9uR3VpZGVQYWdlQ29tcG9uZW50XHJcbn0gZnJvbSAnLi4vLi4vc3JjL2FwcC9tb2RlbHMvcjQvZmhpcic7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XHJcbmltcG9ydCAqIGFzIHJwIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XHJcbmltcG9ydCAqIGFzIEZoaXJIZWxwZXIgZnJvbSAnLi4vZmhpckhlbHBlcic7XHJcbmltcG9ydCAqIGFzIGxvZzRqcyBmcm9tICdsb2c0anMnO1xyXG5pbXBvcnQgKiBhcyBjb25maWcgZnJvbSAnY29uZmlnJztcclxuaW1wb3J0IHtGaGlyIGFzIEZoaXJNb2RlbCwgRmhpckNvbmZpZ30gZnJvbSAnLi4vY29udHJvbGxlcnMvbW9kZWxzJztcclxuaW1wb3J0IHtHbG9iYWxzfSBmcm9tICcuLi8uLi9zcmMvYXBwL2dsb2JhbHMnO1xyXG5pbXBvcnQgRXh0ZW5zaW9uID0gRmhpck1vZGVsLkV4dGVuc2lvbjtcclxuXHJcbmV4cG9ydCBjbGFzcyBCdW5kbGVFeHBvcnRlciB7XHJcbiAgICByZWFkb25seSBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCk7XHJcbiAgICByZWFkb25seSBmaGlyU2VydmVyQmFzZTogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZmhpclNlcnZlcklkOiBzdHJpbmc7XHJcbiAgICByZWFkb25seSBmaGlyVmVyc2lvbjogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZmhpcjogRmhpcjtcclxuICAgIHJlYWRvbmx5IGltcGxlbWVudGF0aW9uR3VpZGVJZDogc3RyaW5nO1xyXG5cclxuICAgIHB1YmxpYyBmaGlyQ29uZmlnOiBGaGlyQ29uZmlnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGZoaXJTZXJ2ZXJCYXNlOiBzdHJpbmcsIGZoaXJTZXJ2ZXJJZDogc3RyaW5nLCBmaGlyVmVyc2lvbjogc3RyaW5nLCBmaGlyOiBGaGlyLCBpbXBsZW1lbnRhdGlvbkd1aWRlSWQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuZmhpclNlcnZlckJhc2UgPSBmaGlyU2VydmVyQmFzZTtcclxuICAgICAgICB0aGlzLmZoaXJTZXJ2ZXJJZCA9IGZoaXJTZXJ2ZXJJZDtcclxuICAgICAgICB0aGlzLmZoaXJWZXJzaW9uID0gZmhpclZlcnNpb247XHJcbiAgICAgICAgdGhpcy5maGlyID0gZmhpcjtcclxuICAgICAgICB0aGlzLmltcGxlbWVudGF0aW9uR3VpZGVJZCA9IGltcGxlbWVudGF0aW9uR3VpZGVJZDtcclxuICAgICAgICB0aGlzLmZoaXJDb25maWcgPSA8RmhpckNvbmZpZz4gY29uZmlnLmdldCgnZmhpcicpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUGVyZm9ybXMgYW55IGZpeGVzIHRvIHRoZSByZXNvdXJjZXMgdGhhdCBhcmUgYmVpbmcgZXhwb3J0ZWQsIHN1Y2ggYXMgcmVtb3ZpbmcgVG9GLXNwZWNpZmljIGV4dGVuc2lvbnMgZnJvbSB0aGUgcmVzb3VyY2VcclxuICAgICAqIGFuZCBjb252ZXJ0aW5nIEltcGxlbWVudGF0aW9uR3VpZGUuZGVmaW5pdGlvbi5wYWdlLm5hbWVSZWZlcmVuY2UgdG8gbmFtZVVybFxyXG4gICAgICogQHBhcmFtIG9iamVjdCBUaGUgcmVzb3VyY2UgdG8gY2xlYW51cFxyXG4gICAgICogQHBhcmFtIGNsb25lXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgY2xlYW51cFJlc291cmNlKG9iamVjdDogYW55LCBjbG9uZSA9IHRydWUpIHtcclxuICAgICAgICBpZiAob2JqZWN0KSB7XHJcbiAgICAgICAgICAgIGlmIChjbG9uZSkge1xyXG4gICAgICAgICAgICAgICAgb2JqZWN0ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmplY3QpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgZXh0ZW5zaW9uVXJscyA9IF8ubWFwKG5ldyBHbG9iYWxzKCkuZXh0ZW5zaW9uVXJscywgKGV4dFVybCkgPT4gZXh0VXJsKTtcclxuICAgICAgICAgICAgY29uc3Qga2V5cyA9IF8uYWxsS2V5cyhvYmplY3QpO1xyXG5cclxuICAgICAgICAgICAgLy8gQ29udmVydCBwYWdlLm5hbWVSZWZlcmVuY2UgdG8gcGFnZS5uYW1lVGl0bGVcclxuICAgICAgICAgICAgaWYgKG9iamVjdC5yZXNvdXJjZVR5cGUgPT09ICdJbXBsZW1lbnRhdGlvbkd1aWRlJyAmJiBvYmplY3QuZGVmaW5pdGlvbiAmJiBvYmplY3QuZGVmaW5pdGlvbi5wYWdlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaXhQYWdlID0gKHBhZ2U6IEltcGxlbWVudGF0aW9uR3VpZGVQYWdlQ29tcG9uZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2UubmFtZVJlZmVyZW5jZSAmJiBwYWdlLnRpdGxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwYWdlLm5hbWVSZWZlcmVuY2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2UubmFtZVVybCA9IHBhZ2UudGl0bGUucmVwbGFjZSgvIC9nLCAnXycpICsgJy5odG1sJztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChwYWdlLnBhZ2UsIChuZXh0KSA9PiBmaXhQYWdlKG5leHQpKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgZml4UGFnZShvYmplY3QuZGVmaW5pdGlvbi5wYWdlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGNvbnRhaW5lZCBiaW5hcnkgcmVzb3VyY2VzLiBUaGUgSUcgcHVibGlzaGVyIHByb2R1Y2VzIGVycm9ycyB3aGVuIHRoZXJlIGlzIGEgY29udGFpbmVkIGJpbmFyeSByZXNvdXJjZSBvbiB0aGUgSUcuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb250YWluZWRCaW5hcnkgPSBfLmZpbHRlcihvYmplY3QuY29udGFpbmVkLCAoY29udGFpbmVkKSA9PiBjb250YWluZWQucmVzb3VyY2VUeXBlID09PSAnQmluYXJ5Jyk7XHJcbiAgICAgICAgICAgICAgICBfLmVhY2goY29udGFpbmVkQmluYXJ5LCAoY29udGFpbmVkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBvYmplY3QuY29udGFpbmVkLmluZGV4T2YoY29udGFpbmVkKTtcclxuICAgICAgICAgICAgICAgICAgICBvYmplY3QuY29udGFpbmVkLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gUmVtb3ZlIFRvRi1zcGVjaWZpYyBleHRlbnNpb25zXHJcbiAgICAgICAgICAgIF8uZWFjaChrZXlzLCAoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnZXh0ZW5zaW9uJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4dGVuc2lvbnM6IEV4dGVuc2lvbltdID0gb2JqZWN0W2tleV07XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlRXh0ZW5zaW9ucyA9IF8uZmlsdGVyKGV4dGVuc2lvbnMsIChleHRlbnNpb24pID0+IGV4dGVuc2lvblVybHMuaW5kZXhPZihleHRlbnNpb24udXJsKSA+PSAwKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFueSBleHRlbnNpb25zIGZyb20gdGhlIHJlc291cmNlIHRoYXQgYXJlIGZvciBUcmlmb2xpYVxyXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChyZW1vdmVFeHRlbnNpb25zLCAocmVtb3ZlRXh0ZW5zaW9uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gZXh0ZW5zaW9ucy5pbmRleE9mKHJlbW92ZUV4dGVuc2lvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iamVjdFtrZXldID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYW51cFJlc291cmNlKG9iamVjdFtrZXldLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG9iamVjdDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9nZXRTdHUzUmVzb3VyY2VzKGltcGxlbWVudGF0aW9uR3VpZGU6IFNUVTNJbXBsZW1lbnRhdGlvbkd1aWRlKSB7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcclxuXHJcbiAgICAgICAgXy5lYWNoKGltcGxlbWVudGF0aW9uR3VpZGUucGFja2FnZSwgKGlnUGFja2FnZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByZWZlcmVuY2VzID0gXy5jaGFpbihpZ1BhY2thZ2UucmVzb3VyY2UpXHJcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChyZXNvdXJjZSkgPT4gISFyZXNvdXJjZS5zb3VyY2VSZWZlcmVuY2UgJiYgISFyZXNvdXJjZS5zb3VyY2VSZWZlcmVuY2UucmVmZXJlbmNlKVxyXG4gICAgICAgICAgICAgICAgLm1hcCgocmVzb3VyY2UpID0+IHJlc291cmNlLnNvdXJjZVJlZmVyZW5jZS5yZWZlcmVuY2UpXHJcbiAgICAgICAgICAgICAgICAudmFsdWUoKTtcclxuXHJcbiAgICAgICAgICAgIF8uZWFjaChyZWZlcmVuY2VzLCAocmVmZXJlbmNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBGaGlySGVscGVyLnBhcnNlVXJsKHJlZmVyZW5jZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZVVybCA9IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5maGlyU2VydmVyQmFzZSwgcGFyc2VkLnJlc291cmNlVHlwZSwgcGFyc2VkLmlkKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc291cmNlUHJvbWlzZSA9IHJwKHsgdXJsOiByZXNvdXJjZVVybCwganNvbjogdHJ1ZSwgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKHJlc291cmNlUHJvbWlzZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2dldFI0UmVzb3VyY2VzKGltcGxlbWVudGF0aW9uR3VpZGU6IFI0SW1wbGVtZW50YXRpb25HdWlkZSkge1xyXG4gICAgICAgIGlmICghaW1wbGVtZW50YXRpb25HdWlkZS5kZWZpbml0aW9uKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBfLmNoYWluKGltcGxlbWVudGF0aW9uR3VpZGUuZGVmaW5pdGlvbi5yZXNvdXJjZSlcclxuICAgICAgICAgICAgLmZpbHRlcigocmVzb3VyY2UpID0+ICEhcmVzb3VyY2UucmVmZXJlbmNlICYmICEhcmVzb3VyY2UucmVmZXJlbmNlLnJlZmVyZW5jZSlcclxuICAgICAgICAgICAgLm1hcCgocmVzb3VyY2UpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IHJlc291cmNlLnJlZmVyZW5jZS5yZWZlcmVuY2U7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBGaGlySGVscGVyLnBhcnNlVXJsKHJlZmVyZW5jZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZVVybCA9IEZoaXJIZWxwZXIuYnVpbGRVcmwodGhpcy5maGlyU2VydmVyQmFzZSwgcGFyc2VkLnJlc291cmNlVHlwZSwgcGFyc2VkLmlkKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc291cmNlUHJvbWlzZSA9IHJwKHsgdXJsOiByZXNvdXJjZVVybCwganNvbjogdHJ1ZSwgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VQcm9taXNlO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAudmFsdWUoKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QnVuZGxlKHJlbW92ZUV4dGVuc2lvbnMgPSBmYWxzZSk6IFByb21pc2U8QnVuZGxlPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaWdVcmwgPSBGaGlySGVscGVyLmJ1aWxkVXJsKHRoaXMuZmhpclNlcnZlckJhc2UsICdJbXBsZW1lbnRhdGlvbkd1aWRlJywgdGhpcy5pbXBsZW1lbnRhdGlvbkd1aWRlSWQpO1xyXG4gICAgICAgICAgICBjb25zdCBmaGlyU2VydmVyQ29uZmlnID0gXy5maW5kKHRoaXMuZmhpckNvbmZpZy5zZXJ2ZXJzLCAoc2VydmVyQ29uZmlnKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmVyQ29uZmlnLmlkID09PSB0aGlzLmZoaXJTZXJ2ZXJJZDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGxldCBpbXBsZW1lbnRhdGlvbkd1aWRlO1xyXG4gICAgICAgICAgICBsZXQgaW1wbGVtZW50YXRpb25HdWlkZUZ1bGxVcmw7XHJcblxyXG4gICAgICAgICAgICBycCh7IHVybDogaWdVcmwsIGpzb246IHRydWUsIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlID0gcmVzcG9uc2UuYm9keTtcclxuICAgICAgICAgICAgICAgICAgICBpbXBsZW1lbnRhdGlvbkd1aWRlRnVsbFVybCA9IHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbG9jYXRpb24nXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZoaXJTZXJ2ZXJDb25maWcudmVyc2lvbiA9PT0gJ3N0dTMnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRTdHUzUmVzb3VyY2VzKGltcGxlbWVudGF0aW9uR3VpZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFI0UmVzb3VyY2VzKGltcGxlbWVudGF0aW9uR3VpZGUpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNvdXJjZUVudHJpZXMgPSBfLmNoYWluKHJlc3BvbnNlcylcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigocmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXJlc3BvbnNlLmJvZHkgJiYgISFyZXNwb25zZS5ib2R5LnJlc291cmNlVHlwZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgocmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmdWxsVXJsID0gcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC1sb2NhdGlvbiddO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZnVsbFVybCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxVcmwgPSBGaGlySGVscGVyLmpvaW5VcmwodGhpcy5maGlyU2VydmVyQmFzZSwgcmVzcG9uc2UuYm9keS5yZXNvdXJjZVR5cGUsIHJlc3BvbnNlLmJvZHkuaWQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuYm9keS5tZXRhICYmIHJlc3BvbnNlLmJvZHkubWV0YS52ZXJzaW9uSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFVybCA9IEZoaXJIZWxwZXIuam9pblVybChmdWxsVXJsLCAnX2hpc3RvcnknLCByZXNwb25zZS5ib2R5Lm1ldGEudmVyc2lvbklkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsVXJsOiBmdWxsVXJsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiByZXNwb25zZS5ib2R5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudmFsdWUoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlcy5sZW5ndGggIT09IHJlc291cmNlRW50cmllcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYEV4cGVjdGVkICR7cmVzcG9uc2VzLmxlbmd0aH0gZW50cmllcyBpbiB0aGUgZXhwb3J0IGJ1bmRsZSwgYnV0IG9ubHkgcmV0dXJuaW5nICR7cmVzb3VyY2VFbnRyaWVzLmxlbmd0aH0uIFNvbWUgcmVzb3VyY2VzIGNvdWxkIG5vdCBiZSByZXR1cm5lZCBpbiB0aGUgYnVuZGxlIGR1ZSB0byB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLmApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnVuZGxlID0gPEJ1bmRsZT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZVR5cGU6ICdCdW5kbGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY29sbGVjdGlvbicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiByZXNvdXJjZUVudHJpZXMubGVuZ3RoICsgMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW50cnk6IFt7IGZ1bGxVcmw6IGltcGxlbWVudGF0aW9uR3VpZGVGdWxsVXJsLCByZXNvdXJjZTogaW1wbGVtZW50YXRpb25HdWlkZSB9XS5jb25jYXQocmVzb3VyY2VFbnRyaWVzKVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVFeHRlbnNpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIEJ1bmRsZUV4cG9ydGVyLmNsZWFudXBSZXNvdXJjZShidW5kbGUsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYnVuZGxlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIgJiYgZXJyLnJlc3BvbnNlICYmIGVyci5yZXNwb25zZS5ib2R5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVyckJvZHkgPSA8T3BlcmF0aW9uT3V0Y29tZT4gZXJyLnJlc3BvbnNlLmJvZHk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzc3VlVGV4dHMgPSBfLm1hcChlcnJCb2R5Lmlzc3VlLCAoaXNzdWUpID0+IGlzc3VlLmRpYWdub3N0aWNzKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc3N1ZVRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChpc3N1ZVRleHRzLmpvaW4oJyAmICcpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJCb2R5LnRleHQgJiYgZXJyQm9keS50ZXh0LmRpdikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVyckJvZHkudGV4dC5kaXYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoZXJyQm9keSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoJ1Vua25vd24gZXJyb3IgcmV0dXJuZWQgYnkgRkhJUiBzZXJ2ZXIgd2hlbiBnZXR0aW5nIHJlc291cmNlcyBmb3IgaW1wbGVtZW50YXRpb24gZ3VpZGUnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBleHBvcnQoZm9ybWF0OiAnanNvbid8J3htbCd8J2FwcGxpY2F0aW9uL2pzb24nfCdhcHBsaWNhdGlvbi9maGlyK2pzb24nfCdhcHBsaWNhdGlvbi94bWwnfCdhcHBsaWNhdGlvbi9maGlyK3htbCcgPSAnanNvbicsIHJlbW92ZUV4dGVuc2lvbnMgPSBmYWxzZSkge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0QnVuZGxlKHJlbW92ZUV4dGVuc2lvbnMpXHJcbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCByZXNwb25zZTogQnVuZGxlIHwgc3RyaW5nID0gcmVzdWx0cztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdCA9PT0gJ3htbCcgfHwgZm9ybWF0ID09PSAnYXBwbGljYXRpb24veG1sJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IHRoaXMuZmhpci5vYmpUb1htbChyZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSJdfQ==